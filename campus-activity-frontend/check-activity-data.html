<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨æ•°æ®æ£€æŸ¥</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .data-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .data-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .activity-item {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }
        .activity-item.missing {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .activity-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .activity-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }
        .user-info {
            background: #e8f5e8;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” æ´»åŠ¨æ•°æ®æ£€æŸ¥å·¥å…·</h1>
        <p>æ£€æŸ¥localStorageå’Œå…¨å±€æ•°æ®ç®¡ç†å™¨ä¸­çš„æ´»åŠ¨æ•°æ®</p>
    </div>

    <div class="data-section">
        <h3>ğŸ‘¤ å½“å‰ç”¨æˆ·ä¿¡æ¯</h3>
        <div id="current-user" class="user-info">
            <p>æ­£åœ¨æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯...</p>
        </div>
    </div>

    <div class="data-section">
        <h3>ğŸ“‹ localStorageä¸­çš„æ´»åŠ¨æ•°æ®</h3>
        <div id="localStorage-activities">
            <p>æ­£åœ¨æ£€æŸ¥localStorage...</p>
        </div>
        <button class="button" onclick="clearLocalStorage()">æ¸…ç©ºlocalStorage</button>
        <button class="button" onclick="reloadData()">é‡æ–°åŠ è½½æ•°æ®</button>
    </div>

    <div class="data-section">
        <h3>ğŸ—ƒï¸ å…¨å±€æ•°æ®ç®¡ç†å™¨ä¸­çš„æ´»åŠ¨</h3>
        <div id="global-activities">
            <p>æ­£åœ¨æ£€æŸ¥å…¨å±€æ•°æ®ç®¡ç†å™¨...</p>
        </div>
    </div>

    <div class="data-section">
        <h3>â“ æ´»åŠ¨ID 7æ£€æŸ¥</h3>
        <div id="activity-7-check">
            <p>æ­£åœ¨æ£€æŸ¥æ´»åŠ¨ID 7...</p>
        </div>
        <button class="button" onclick="createActivity7()">åˆ›å»ºæ´»åŠ¨ID 7</button>
        <button class="button danger" onclick="deleteActivity7()">åˆ é™¤æ´»åŠ¨ID 7</button>
    </div>

    <div class="data-section">
        <h3>ğŸ”§ æ•°æ®ä¿®å¤å·¥å…·</h3>
        <button class="button" onclick="fixData()">ä¿®å¤æ•°æ®ä¸ä¸€è‡´</button>
        <button class="button" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
        <div id="debug-info" style="margin-top: 15px;"></div>
    </div>

    <script type="module">
        // å¯¼å…¥å…¨å±€æ•°æ®ç®¡ç†å™¨
        import { globalDataManager } from './src/api/global-data.js';

        // æ£€æŸ¥å½“å‰ç”¨æˆ·
        function checkCurrentUser() {
            const userDiv = document.getElementById('current-user');
            try {
                const currentUserId = globalDataManager.getCurrentUserId();
                const users = globalDataManager.getUsers();
                const currentUser = users.find(u => u.id === currentUserId);
                
                if (currentUser) {
                    userDiv.innerHTML = `
                        <h4>å½“å‰ç™»å½•ç”¨æˆ·</h4>
                        <p><strong>ID:</strong> ${currentUser.id}</p>
                        <p><strong>å§“å:</strong> ${currentUser.realName}</p>
                        <p><strong>å­¦å·:</strong> ${currentUser.studentId}</p>
                        <p><strong>ä¿¡èª‰åˆ†:</strong> ${currentUser.creditScore}</p>
                    `;
                } else {
                    userDiv.innerHTML = '<p style="color: red;">âŒ æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·</p>';
                }
            } catch (error) {
                userDiv.innerHTML = `<p style="color: red;">âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ£€æŸ¥localStorageä¸­çš„æ´»åŠ¨
        function checkLocalStorageActivities() {
            const div = document.getElementById('localStorage-activities');
            try {
                const activities = localStorage.getItem('campus_activities');
                if (activities) {
                    const parsedActivities = JSON.parse(activities);
                    div.innerHTML = `
                        <p><strong>æ‰¾åˆ° ${parsedActivities.length} ä¸ªæ´»åŠ¨</strong></p>
                        ${parsedActivities.map(activity => `
                            <div class="activity-item">
                                <h4>ID: ${activity.id} - ${activity.title}</h4>
                                <div class="activity-meta">
                                    <span>ğŸ“… åˆ›å»ºè€…ID: ${activity.organizerId}</span>
                                    <span>ğŸ‘¥ å‚ä¸è€…: ${activity.currentParticipants}/${activity.maxParticipants}</span>
                                    <span>ğŸ·ï¸ çŠ¶æ€: ${activity.status}</span>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    div.innerHTML = '<p>âŒ localStorageä¸­æ²¡æœ‰æ´»åŠ¨æ•°æ®</p>';
                }
            } catch (error) {
                div.innerHTML = `<p style="color: red;">âŒ è¯»å–localStorageå¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ£€æŸ¥å…¨å±€æ•°æ®ç®¡ç†å™¨ä¸­çš„æ´»åŠ¨
        function checkGlobalActivities() {
            const div = document.getElementById('global-activities');
            try {
                const activities = globalDataManager.getActivities();
                div.innerHTML = `
                    <p><strong>æ‰¾åˆ° ${activities.length} ä¸ªæ´»åŠ¨</strong></p>
                    ${activities.map(activity => `
                        <div class="activity-item">
                            <h4>ID: ${activity.id} - ${activity.title}</h4>
                            <div class="activity-meta">
                                <span>ğŸ“… åˆ›å»ºè€…ID: ${activity.organizerId}</span>
                                <span>ğŸ‘¥ å‚ä¸è€…: ${activity.currentParticipants}/${activity.maxParticipants}</span>
                                <span>ğŸ·ï¸ çŠ¶æ€: ${activity.status}</span>
                            </div>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                div.innerHTML = `<p style="color: red;">âŒ è¯»å–å…¨å±€æ•°æ®å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ£€æŸ¥æ´»åŠ¨ID 7
        function checkActivity7() {
            const div = document.getElementById('activity-7-check');
            try {
                const activities = globalDataManager.getActivities();
                const activity7 = activities.find(a => a.id === '7' || a.id === 7);
                
                if (activity7) {
                    div.innerHTML = `
                        <div class="activity-item">
                            <h4>âœ… æ‰¾åˆ°æ´»åŠ¨ID 7</h4>
                            <p><strong>æ ‡é¢˜:</strong> ${activity7.title}</p>
                            <p><strong>åˆ›å»ºè€…ID:</strong> ${activity7.organizerId}</p>
                            <p><strong>æè¿°:</strong> ${activity7.description}</p>
                            <div class="activity-meta">
                                <span>ğŸ‘¥ å‚ä¸è€…: ${activity7.currentParticipants}/${activity7.maxParticipants}</span>
                                <span>ğŸ·ï¸ çŠ¶æ€: ${activity7.status}</span>
                            </div>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="activity-item missing">
                            <h4>âŒ æ´»åŠ¨ID 7 ä¸å­˜åœ¨</h4>
                            <p>ç³»ç»Ÿä¸­æ²¡æœ‰æ‰¾åˆ°IDä¸º7çš„æ´»åŠ¨</p>
                        </div>
                    `;
                }
            } catch (error) {
                div.innerHTML = `<p style="color: red;">âŒ æ£€æŸ¥æ´»åŠ¨ID 7å¤±è´¥: ${error.message}</p>`;
            }
        }

        // åˆ›å»ºæ´»åŠ¨ID 7
        window.createActivity7 = function() {
            try {
                const currentUserId = globalDataManager.getCurrentUserId();
                const users = globalDataManager.getUsers();
                const currentUser = users.find(u => u.id === currentUserId);
                
                if (!currentUser) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }

                const newActivity = {
                    id: '7',
                    title: 'ç”¨æˆ·åˆ›å»ºçš„æ´»åŠ¨',
                    type: 'ç”¨æˆ·æ´»åŠ¨',
                    category: 'other',
                    description: 'è¿™æ˜¯ç”¨æˆ·åˆ›å»ºçš„æ´»åŠ¨ï¼Œç”¨äºæµ‹è¯•æ´»åŠ¨ID 7çš„è®¿é—®',
                    organizerId: currentUserId,
                    organizerName: currentUser.realName,
                    startTime: new Date(Date.now() + 86400000 * 2).toISOString(),
                    endTime: new Date(Date.now() + 86400000 * 2 + 10800000).toISOString(),
                    location: 'æµ‹è¯•åœ°ç‚¹',
                    locationName: 'æµ‹è¯•åœ°ç‚¹',
                    maxParticipants: 50,
                    currentParticipants: 1,
                    status: 'recruiting',
                    tags: ['æµ‹è¯•', 'ç”¨æˆ·åˆ›å»º'],
                    coverImage: '/activity-cover-default.png',
                    createdAt: new Date().toISOString(),
                    distance: 0
                };

                globalDataManager.addActivity(newActivity);
                
                // åˆ›å»ºå‚ä¸è€…è®°å½•
                const participants = [{
                    userId: currentUserId,
                    userName: currentUser.realName,
                    status: 'approved',
                    joinTime: new Date().toISOString()
                }];
                globalDataManager.setActivityParticipants('7', participants);
                
                // åŒæ­¥åˆ°localStorage
                const updatedActivities = globalDataManager.getActivities();
                localStorage.setItem('campus_activities', JSON.stringify(updatedActivities));
                
                alert('âœ… æ´»åŠ¨ID 7åˆ›å»ºæˆåŠŸï¼');
                reloadData();
            } catch (error) {
                alert('âŒ åˆ›å»ºæ´»åŠ¨å¤±è´¥: ' + error.message);
            }
        };

        // åˆ é™¤æ´»åŠ¨ID 7
        window.deleteActivity7 = function() {
            try {
                globalDataManager.removeActivity('7');
                localStorage.removeItem('campus_activities');
                alert('âœ… æ´»åŠ¨ID 7åˆ é™¤æˆåŠŸï¼');
                reloadData();
            } catch (error) {
                alert('âŒ åˆ é™¤æ´»åŠ¨å¤±è´¥: ' + error.message);
            }
        };

        // æ¸…ç©ºlocalStorage
        window.clearLocalStorage = function() {
            localStorage.removeItem('campus_activities');
            alert('âœ… localStorageå·²æ¸…ç©º');
            reloadData();
        };

        // é‡æ–°åŠ è½½æ•°æ®
        window.reloadData = function() {
            checkCurrentUser();
            checkLocalStorageActivities();
            checkGlobalActivities();
            checkActivity7();
        };

        // ä¿®å¤æ•°æ®ä¸ä¸€è‡´
        window.fixData = function() {
            try {
                // è·å–å…¨å±€æ•°æ®
                const globalActivities = globalDataManager.getActivities();
                
                // åŒæ­¥åˆ°localStorage
                localStorage.setItem('campus_activities', JSON.stringify(globalActivities));
                
                alert('âœ… æ•°æ®ä¿®å¤å®Œæˆï¼localStorageå·²åŒæ­¥');
                reloadData();
            } catch (error) {
                alert('âŒ æ•°æ®ä¿®å¤å¤±è´¥: ' + error.message);
            }
        };

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        window.showDebugInfo = function() {
            const debugDiv = document.getElementById('debug-info');
            try {
                const debugInfo = {
                    currentUserId: globalDataManager.getCurrentUserId(),
                    globalActivitiesCount: globalDataManager.getActivities().length,
                    localStorageExists: !!localStorage.getItem('campus_activities'),
                    localStorageData: localStorage.getItem('campus_activities') ? JSON.parse(localStorage.getItem('campus_activities')).length : 0
                };
                
                debugDiv.innerHTML = `
                    <div class="code-block">
${JSON.stringify(debugInfo, null, 2)}
                    </div>
                `;
            } catch (error) {
                debugDiv.innerHTML = `<p style="color: red;">âŒ è·å–è°ƒè¯•ä¿¡æ¯å¤±è´¥: ${error.message}</p>`;
            }
        };

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ£€æŸ¥
        window.addEventListener('load', function() {
            setTimeout(reloadData, 1000);
        });

        // å¯¼å‡ºå‡½æ•°ä¾›å…¨å±€ä½¿ç”¨
        window.checkCurrentUser = checkCurrentUser;
        window.checkLocalStorageActivities = checkLocalStorageActivities;
        window.checkGlobalActivities = checkGlobalActivities;
        window.checkActivity7 = checkActivity7;
    </script>
</body>
</html>