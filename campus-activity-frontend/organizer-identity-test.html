<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„ç»‡è€…èº«ä»½æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .section h2 {
            color: #555;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #0056CC;
        }
        .button.success {
            background: #34C759;
        }
        .button.success:hover {
            background: #28A745;
        }
        .button.warning {
            background: #FF9500;
        }
        .button.warning:hover {
            background: #E67E00;
        }
        .data-display {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .user-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .user-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .user-info {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        .activity-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .activity-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .organizer-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .result {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘¤ ç»„ç»‡è€…èº«ä»½æµ‹è¯•å·¥å…·</h1>
        
        <div class="section">
            <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
            <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•æ´»åŠ¨è¯¦æƒ…å¼¹çª—ä¸­çš„ç»„ç»‡è€…èº«ä»½æ£€æµ‹åŠŸèƒ½ã€‚é€šè¿‡æ¨¡æ‹Ÿä¸åŒçš„ç”¨æˆ·å’Œæ´»åŠ¨æ•°æ®ï¼ŒéªŒè¯ç»„ç»‡è€…æ“ä½œç•Œé¢æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºã€‚</p>
        </div>

        <div class="section">
            <h2>ğŸ‘¤ å½“å‰ç”¨æˆ·ä¿¡æ¯</h2>
            <div id="currentUserInfo" class="user-card">
                <h3>ç”¨æˆ·ä¿¡æ¯</h3>
                <div class="user-info" id="userInfoDisplay">æœªè®¾ç½®ç”¨æˆ·ä¿¡æ¯</div>
            </div>
            <button class="button" onclick="setUser1()">è®¾ç½®ç”¨æˆ·1 (å¼ ä¸‰)</button>
            <button class="button" onclick="setUser2()">è®¾ç½®ç”¨æˆ·2 (æå››)</button>
            <button class="button" onclick="setUser3()">è®¾ç½®ç”¨æˆ·3 (ç¯®çƒç¤¾)</button>
            <button class="button warning" onclick="clearUser()">æ¸…é™¤ç”¨æˆ·</button>
        </div>

        <div class="section">
            <h2>ğŸ¯ æµ‹è¯•æ´»åŠ¨</h2>
            <div id="testActivities"></div>
            <button class="button success" onclick="loadTestActivities()">åŠ è½½æµ‹è¯•æ´»åŠ¨</button>
        </div>

        <div class="section">
            <h2>ğŸ§ª èº«ä»½éªŒè¯æµ‹è¯•</h2>
            <div id="testResults"></div>
            <button class="button" onclick="runIdentityTest()">è¿è¡Œèº«ä»½éªŒè¯æµ‹è¯•</button>
        </div>

        <div class="section">
            <h2>ğŸ”§ æ•°æ®æ“ä½œ</h2>
            <button class="button" onclick="openActivityList()">æ‰“å¼€æ´»åŠ¨åˆ—è¡¨</button>
            <button class="button success" onclick="openFixTool()">æ‰“å¼€ä¿®å¤å·¥å…·</button>
            <button class="button warning" onclick="exportTestData()">å¯¼å‡ºæµ‹è¯•æ•°æ®</button>
        </div>

        <div id="messages"></div>
    </div>

    <script>
        // æµ‹è¯•ç”¨æˆ·æ•°æ®
        const testUsers = {
            user1: {
                id: '1',
                realName: 'å¼ ä¸‰',
                name: 'å¼ ä¸‰',
                studentId: '2022001001',
                department: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯å­¦é™¢',
                avatar: 'https://via.placeholder.com/150',
                email: 'zhangsan@example.com',
                creditScore: 95
            },
            user2: {
                id: '2',
                realName: 'æå››',
                name: 'æå››',
                studentId: '2022001002',
                department: 'ç”µå­å·¥ç¨‹å­¦é™¢',
                avatar: 'https://via.placeholder.com/150',
                email: 'lisi@example.com',
                creditScore: 88
            },
            user3: {
                id: '3',
                realName: 'ç¯®çƒç¤¾',
                name: 'ç¯®çƒç¤¾',
                studentId: 'org001',
                department: 'å­¦ç”Ÿç»„ç»‡',
                avatar: 'https://via.placeholder.com/150',
                email: 'basketball@club.com',
                creditScore: 92
            }
        }

        // æµ‹è¯•æ´»åŠ¨æ•°æ®
        const testActivities = [
            {
                id: 'activity1',
                title: 'ç¯®çƒå‹è°Šèµ›',
                type: 'sports',
                locationName: 'ç¯®çƒåœº1',
                description: 'å‘¨æœ«ç¯®çƒæ¯”èµ›ï¼Œæ¬¢è¿æ‰€æœ‰ç¯®çƒçˆ±å¥½è€…å‚åŠ ã€‚',
                startTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                endTime: new Date(Date.now() + 26 * 60 * 60 * 1000).toISOString(),
                registrationDeadline: new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString(),
                currentParticipants: 4,
                maxParticipants: 8,
                organizer: { 
                    id: '3', 
                    name: 'ç¯®çƒç¤¾', 
                    avatar: 'https://via.placeholder.com/150', 
                    role: 'ç»„ç»‡è€…', 
                    creditScore: 92 
                },
                distance: 0.5,
                isEnrolled: false,
                isApproved: false,
                status: 'open'
            },
            {
                id: 'activity2',
                title: 'è‹±è¯­è§’äº¤æµæ´»åŠ¨',
                type: 'study',
                locationName: 'å­¦ç”Ÿæ´»åŠ¨ä¸­å¿ƒ301',
                description: 'æ¯å‘¨äº”æ™šä¸Šçš„è‹±è¯­è§’æ´»åŠ¨ï¼Œæ¬¢è¿æ‰€æœ‰è‹±è¯­çˆ±å¥½è€…å‚åŠ ã€‚',
                startTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                endTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 + 2 * 60 * 60 * 1000).toISOString(),
                registrationDeadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 - 2 * 60 * 60 * 1000).toISOString(),
                currentParticipants: 12,
                maxParticipants: 25,
                organizer: { 
                    id: '1', 
                    name: 'å¼ ä¸‰', 
                    avatar: 'https://via.placeholder.com/150', 
                    role: 'ç»„ç»‡è€…', 
                    creditScore: 95 
                },
                distance: 0.2,
                isEnrolled: false,
                isApproved: false,
                status: 'open'
            },
            {
                id: 'activity3',
                title: 'ç¼–ç¨‹é©¬æ‹‰æ¾å¤§èµ›',
                type: 'tech',
                locationName: 'åˆ›æ–°å®éªŒå®¤',
                description: '24å°æ—¶ç¼–ç¨‹æŒ‘æˆ˜èµ›ï¼Œä¸»é¢˜ä¸ºæ™ºæ…§æ ¡å›­ã€‚',
                startTime: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toISOString(),
                endTime: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(),
                registrationDeadline: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000 - 4 * 60 * 60 * 1000).toISOString(),
                currentParticipants: 8,
                maxParticipants: 20,
                organizer: { 
                    id: '2', 
                    name: 'æå››', 
                    avatar: 'https://via.placeholder.com/150', 
                    role: 'ç»„ç»‡è€…', 
                    creditScore: 88 
                },
                distance: 1.2,
                isEnrolled: false,
                isApproved: false,
                status: 'open'
            }
        ]

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `result ${type}`;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 5000);
        }

        function updateUserDisplay() {
            const userInfo = localStorage.getItem('userInfo');
            const displayDiv = document.getElementById('userInfoDisplay');
            
            if (userInfo) {
                const user = JSON.parse(userInfo);
                displayDiv.innerHTML = `
                    <strong>å§“å:</strong> ${user.realName || user.name}<br>
                    <strong>ID:</strong> ${user.id}<br>
                    <strong>å­¦å·:</strong> ${user.studentId || 'æ— '}<br>
                    <strong>é™¢ç³»:</strong> ${user.department || 'æ— '}<br>
                    <strong>é‚®ç®±:</strong> ${user.email || 'æ— '}<br>
                    <strong>ä¿¡èª‰åˆ†:</strong> ${user.creditScore || 'æ— '}
                `;
            } else {
                displayDiv.textContent = 'æœªè®¾ç½®ç”¨æˆ·ä¿¡æ¯';
            }
        }

        function setUser1() {
            localStorage.setItem('userInfo', JSON.stringify(testUsers.user1));
            updateUserDisplay();
            showMessage('âœ… å·²è®¾ç½®ç”¨æˆ·1ï¼šå¼ ä¸‰', 'success');
        }

        function setUser2() {
            localStorage.setItem('userInfo', JSON.stringify(testUsers.user2));
            updateUserDisplay();
            showMessage('âœ… å·²è®¾ç½®ç”¨æˆ·2ï¼šæå››', 'success');
        }

        function setUser3() {
            localStorage.setItem('userInfo', JSON.stringify(testUsers.user3));
            updateUserDisplay();
            showMessage('âœ… å·²è®¾ç½®ç”¨æˆ·3ï¼šç¯®çƒç¤¾', 'success');
        }

        function clearUser() {
            localStorage.removeItem('userInfo');
            updateUserDisplay();
            showMessage('âš ï¸ å·²æ¸…é™¤ç”¨æˆ·ä¿¡æ¯', 'warning');
        }

        function loadTestActivities() {
            localStorage.setItem('campus_activities', JSON.stringify(testActivities));
            displayTestActivities();
            showMessage('âœ… å·²åŠ è½½æµ‹è¯•æ´»åŠ¨æ•°æ®', 'success');
        }

        function displayTestActivities() {
            const activitiesDiv = document.getElementById('testActivities');
            activitiesDiv.innerHTML = '';
            
            testActivities.forEach((activity, index) => {
                const activityDiv = document.createElement('div');
                activityDiv.className = 'activity-card';
                activityDiv.innerHTML = `
                    <h3>${index + 1}. ${activity.title}</h3>
                    <div class="organizer-info">
                        <strong>ç»„ç»‡è€…ä¿¡æ¯:</strong><br>
                        ID: ${activity.organizer.id}<br>
                        å§“å: ${activity.organizer.name}<br>
                        ä¿¡èª‰åˆ†: ${activity.organizer.creditScore}
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 8px;">
                        ç±»å‹: ${activity.type} | åœ°ç‚¹: ${activity.locationName} | 
                        å‚ä¸è€…: ${activity.currentParticipants}/${activity.maxParticipants}
                    </div>
                `;
                activitiesDiv.appendChild(activityDiv);
            });
        }

        function isOrganizer(activity, user) {
            if (!activity || !activity.organizer || !user) {
                return false;
            }
            
            const organizerId = activity.organizer.id?.toString();
            const currentUserId = user.id?.toString();
            const organizerName = activity.organizer.name;
            const currentUserName = user.realName || user.name;
            
            console.log('ç»„ç»‡è€…æ£€æŸ¥:', {
                organizerId,
                currentUserId,
                organizerName,
                currentUserName,
                isMatch: organizerId === currentUserId || organizerName === currentUserName
            });
            
            return organizerId === currentUserId || organizerName === currentUserName;
        }

        function runIdentityTest() {
            const userInfo = localStorage.getItem('userInfo');
            const currentUser = userInfo ? JSON.parse(userInfo) : null;
            const resultsDiv = document.getElementById('testResults');
            
            resultsDiv.innerHTML = '<h3>æµ‹è¯•ç»“æœ:</h3>';
            
            if (!currentUser) {
                resultsDiv.innerHTML += '<div class="result warning">âš ï¸ è¯·å…ˆè®¾ç½®ç”¨æˆ·ä¿¡æ¯</div>';
                return;
            }
            
            testActivities.forEach((activity, index) => {
                const isOrg = isOrganizer(activity, currentUser);
                const resultDiv = document.createElement('div');
                resultDiv.className = `result ${isOrg ? 'success' : 'error'}`;
                resultDiv.innerHTML = `
                    <strong>æ´»åŠ¨ ${index + 1}: ${activity.title}</strong><br>
                    å½“å‰ç”¨æˆ·: ${currentUser.realName || currentUser.name} (ID: ${currentUser.id})<br>
                    æ´»åŠ¨ç»„ç»‡è€…: ${activity.organizer.name} (ID: ${activity.organizer.id})<br>
                    ç»“æœ: ${isOrg ? 'âœ… æ˜¯ç»„ç»‡è€… - åº”æ˜¾ç¤ºç®¡ç†ç•Œé¢' : 'âŒ ä¸æ˜¯ç»„ç»‡è€… - åº”æ˜¾ç¤ºæŠ¥åç•Œé¢'}
                `;
                resultsDiv.appendChild(resultDiv);
            });
            
            showMessage('ğŸ§ª èº«ä»½éªŒè¯æµ‹è¯•å®Œæˆ', 'success');
        }

        function openActivityList() {
            window.open('http://localhost:3000/activities', '_blank');
            showMessage('ğŸ“± å·²æ‰“å¼€æ´»åŠ¨åˆ—è¡¨é¡µé¢', 'success');
        }

        function openFixTool() {
            window.open('ultimate-activity-fix-v2.html', '_blank');
            showMessage('ğŸ”§ å·²æ‰“å¼€ä¿®å¤å·¥å…·', 'success');
        }

        function exportTestData() {
            const testData = {
                users: testUsers,
                activities: testActivities,
                currentUser: localStorage.getItem('userInfo') ? JSON.parse(localStorage.getItem('userInfo')) : null
            };
            
            const blob = new Blob([JSON.stringify(testData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `organizer_test_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('ğŸ“¤ æµ‹è¯•æ•°æ®å·²å¯¼å‡º', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            updateUserDisplay();
            displayTestActivities();
        };
    </script>
</body>
</html>