<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç½®è°ƒè¯• - è¯¦ç»†åˆ†æ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .location-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .calibration-info {
            background: #fff3e0;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .debug-info {
            background: #f3e5f5;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error-info {
            background: #ffebee;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976D2;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            border-left: 4px solid #2196F3;
            padding-left: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ä½ç½®è·å–è¯¦ç»†è°ƒè¯•</h1>
    
    <div class="container">
        <h2>ğŸ“ ä½ç½®è·å–æµ‹è¯•</h2>
        <button onclick="testLocation()">è·å–å½“å‰ä½ç½®</button>
        <button onclick="testMultipleTimes()">è¿ç»­æµ‹è¯•5æ¬¡</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        // å¯¼å…¥ä½ç½®å·¥å…·å‡½æ•°
        import { getCurrentLocation, smartLocationCalibration, DEFAULT_LOCATION } from './src/utils/location.js';
        
        window.testLocation = async function() {
            const resultsDiv = document.getElementById('results');
            
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step';
            stepDiv.innerHTML = '<h3>ğŸ” ä½ç½®è·å–æµ‹è¯• #' + (document.querySelectorAll('.step').length + 1) + '</h3>';
            
            try {
                // æ­¥éª¤1: è·å–åŸå§‹ä½ç½®
                stepDiv.innerHTML += '<div class="location-info"><h4>æ­¥éª¤1: å¼€å§‹è·å–ä½ç½®...</h4>';
                
                const location = await getCurrentLocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
                
                stepDiv.innerHTML += '<h5>âœ… ä½ç½®è·å–æˆåŠŸ</h5>';
                stepDiv.innerHTML += '<pre>' + JSON.stringify(location, null, 2) + '</pre>';
                
                // åˆ†æä½ç½®ä¿¡æ¯
                if (location.isDefault) {
                    stepDiv.innerHTML += '<div class="error-info"><h5>âš ï¸ ä½¿ç”¨äº†é»˜è®¤ä½ç½®</h5>';
                    stepDiv.innerHTML += '<p>åŸå› : ' + (location.fallbackReason || 'æœªçŸ¥') + '</p></div>';
                }
                
                if (location.calibrated) {
                    stepDiv.innerHTML += '<div class="calibration-info"><h5>ğŸ¯ ä½ç½®å·²æ ¡å‡†</h5>';
                    stepDiv.innerHTML += '<p>æ ¡å‡†æ¥æº: ' + location.calibrationSource + '</p>';
                    stepDiv.innerHTML += '<p>åŸå§‹è·ç¦»: ' + (location.originalDistance || 'æœªçŸ¥') + 'ç±³</p>';
                    stepDiv.innerHTML += '<p>æƒé‡å¾—åˆ†: ' + (location.weightedScore || 'æœªçŸ¥') + '</p>';
                    stepDiv.innerHTML += '<p>ç½®ä¿¡åº¦: ' + (location.confidence || 'æœªçŸ¥') + '</p></div>';
                }
                
                // æ­¥éª¤2: æ‰‹åŠ¨æµ‹è¯•æ ¡å‡†ç®—æ³•
                const rawLocation = {
                    latitude: location.latitude,
                    longitude: location.longitude,
                    accuracy: location.accuracy
                };
                
                const calibratedLocation = smartLocationCalibration(rawLocation);
                
                stepDiv.innerHTML += '<div class="debug-info"><h4>æ­¥éª¤2: æ ¡å‡†ç®—æ³•åˆ†æ</h4>';
                stepDiv.innerHTML += '<h5>åŸå§‹ä½ç½®:</h5>';
                stepDiv.innerHTML += '<pre>' + JSON.stringify(rawLocation, null, 2) + '</pre>';
                stepDiv.innerHTML += '<h5>æ ¡å‡†åä½ç½®:</h5>';
                stepDiv.innerHTML += '<pre>' + JSON.stringify(calibratedLocation, null, 2) + '</pre>';
                
                if (calibratedLocation.debugInfo) {
                    stepDiv.innerHTML += '<h5>æ‰€æœ‰å‚è€ƒç‚¹ä¿¡æ¯:</h5>';
                    stepDiv.innerHTML += '<pre>' + JSON.stringify(calibratedLocation.debugInfo, null, 2) + '</pre>';
                }
                
                // æ­¥éª¤3: è·ç¦»åˆ†æ
                stepDiv.innerHTML += '<div class="location-info"><h4>æ­¥éª¤3: å…³é”®å»ºç­‘è·ç¦»åˆ†æ</h4>';
                
                const calculateDistance = function(lat1, lng1, lat2, lng2) {
                    const R = 6371e3;
                    const Ï†1 = lat1 * Math.PI / 180;
                    const Ï†2 = lat2 * Math.PI / 180;
                    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
                    const Î”Î» = (lng2 - lng1) * Math.PI / 180;
                    const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                            Math.cos(Ï†1) * Math.cos(Ï†2) *
                            Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    return R * c;
                };
                
                const buildings = [
                    { name: 'å›¾ä¹¦é¦†', lat: 23.0419, lng: 113.4016 },
                    { name: '3æ ‹å®¿èˆ', lat: 23.0413, lng: 113.4022 },
                    { name: '4æ ‹å®¿èˆ', lat: 23.0415, lng: 113.4020 },
                    { name: 'æ•™å­¦æ¥¼Aæ ‹', lat: 23.0422, lng: 113.4012 },
                    { name: 'ä½“è‚²é¦†', lat: 23.0410, lng: 113.4018 },
                    { name: 'é£Ÿå ‚', lat: 23.0425, lng: 113.4010 },
                    { name: 'é»˜è®¤ä½ç½®', lat: DEFAULT_LOCATION.latitude, lng: DEFAULT_LOCATION.longitude }
                ];
                
                buildings.forEach(building => {
                    const distance = calculateDistance(
                        location.latitude, location.longitude,
                        building.lat, building.lng
                    );
                    stepDiv.innerHTML += `<p><strong>${building.name}</strong>: ${distance.toFixed(2)}ç±³</p>`;
                });
                
                stepDiv.innerHTML += '</div>';
                
            } catch (error) {
                stepDiv.innerHTML += '<div class="error-info"><h4>âŒ ä½ç½®è·å–å¤±è´¥</h4>';
                stepDiv.innerHTML += '<p>é”™è¯¯: ' + error.message + '</p>';
                stepDiv.innerHTML += '<pre>' + JSON.stringify(error, null, 2) + '</pre></div>';
            }
            
            stepDiv.innerHTML += '</div>';
            resultsDiv.appendChild(stepDiv);
        };
        
        window.testMultipleTimes = async function() {
            for (let i = 0; i < 5; i++) {
                await window.testLocation();
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        };
        
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡æµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(window.testLocation, 1000);
        });
    </script>
</body>
</html>