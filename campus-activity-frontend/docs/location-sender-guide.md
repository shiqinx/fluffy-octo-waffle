# 位置数据发送功能说明

## 🎯 功能概述

您的校园活动平台现在已经集成了自动位置数据发送功能，可以将用户的位置信息实时发送到后端服务器，用于个性化推荐和位置服务。

## 🚀 新增功能

### 1. 自动位置收集
- **自动定位**：用户打开地图并允许位置权限后，自动发送位置到后端
- **手动校准**：用户手动选择建筑物校准位置时，发送精确位置
- **校园中心**：用户选择使用校园中心时，发送校园中心位置

### 2. 智能缓存机制
- **批量发送**：自动定位的数据会先缓存，5分钟批量发送一次，减少网络请求
- **立即发送**：手动校准的位置立即发送，确保数据及时性
- **缓存限制**：最多缓存10条位置数据，防止内存占用过多

### 3. 用户体验优化
- **静默处理**：所有位置数据发送都在后台进行，不影响用户正常使用
- **错误处理**：后端不可用时静默失败，不会弹出错误提示
- **登录感知**：用户登录后自动发送位置数据

## 📊 数据格式

发送到后端的位置数据包含以下信息：

```json
{
  "userId": "用户ID",
  "longitude": 112.0444,
  "latitude": 22.9156,
  "accuracy": 15,
  "validTime": "2024-01-01T12:00:00.000Z",
  "timestamp": "2024-01-01T11:30:00.000Z",
  "address": "广东药科大学云浮校区",
  "source": "auto|manual|campus_center"
}
```

## 🔧 技术实现

### 核心函数
- `sendLocationToBackend()` - 核心发送函数
- `sendLocationImmediately()` - 立即发送位置数据
- `sendCachedLocations()` - 批量发送缓存数据
- `startLocationBatchSender()` - 启动定时批量发送

### 触发时机
1. **自动定位成功** → `onLocationSuccess()`
2. **手动选择建筑物** → `selectBuilding()`
3. **使用校园中心** → `useCampusCenter()`
4. **用户登录状态变化** → `watch(userStore.userId)`

## 🧪 测试方法

### 方法1：使用测试页面
访问 `http://localhost:3002/test-location-sender.html` 进行功能测试

### 方法2：在主应用中测试
1. 打开 `http://localhost:3002`
2. 允许位置权限
3. 观察浏览器控制台的位置数据发送日志
4. 尝试手动校准位置
5. 检查网络请求中的位置数据

## 📋 控制台日志

位置数据发送时会在浏览器控制台显示以下日志：

```
📤 发送位置数据到后端: {userId: "...", longitude: ..., latitude: ...}
✅ 位置数据保存成功: {...}
📦 位置数据已加入缓存: {...}
📦 批量发送位置历史数据: {...}
```

## ⚙️ 配置选项

### 缓存设置
```javascript
const LOCATION_SEND_INTERVAL = 5 * 60 * 1000 // 5分钟发送间隔
const MAX_CACHE_SIZE = 10 // 最大缓存条数
```

### Mock模式
通过 `src/api/location.js` 中的 `useMock` 变量控制：
- `true` - 使用模拟数据
- `false` - 调用真实后端API

## 🔍 故障排除

### 常见问题
1. **位置权限被拒绝**：用户需要手动授予位置权限
2. **后端不可用**：会静默失败，不影响正常使用
3. **网络错误**：自动重试机制处理

### 调试方法
1. 打开浏览器开发者工具
2. 查看Console标签页的日志输出
3. 检查Network标签页的API请求
4. 使用测试页面验证功能

## 📈 性能影响

- **网络请求**：通过批量发送机制，最多每5分钟发送一次请求
- **内存占用**：缓存最多10条位置数据，占用极小
- **用户体验**：完全后台处理，无感知操作

## 🎉 总结

这个功能为您的校园活动平台增加了强大的位置服务能力，为后续的个性化推荐、位置历史分析等功能奠定了基础。所有功能都已经过优化，确保不会影响现有系统的稳定性和用户体验。