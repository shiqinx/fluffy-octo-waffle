<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆéªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .header p {
            color: #718096;
            font-size: 1.1em;
        }
        .test-section {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4299e1;
        }
        .test-section h3 {
            color: #2d3748;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .btn {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        .btn.warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }
        .btn.danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
            border-left: 4px solid;
        }
        .status.success {
            background: #f0fff4;
            color: #22543d;
            border-color: #48bb78;
        }
        .status.error {
            background: #fff5f5;
            color: #742a2a;
            border-color: #f56565;
        }
        .status.info {
            background: #ebf8ff;
            color: #2c5282;
            border-color: #4299e1;
        }
        .status.warning {
            background: #fffbeb;
            color: #744210;
            border-color: #ed8936;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #3182ce);
            transition: width 0.3s ease;
        }
        .test-result {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .test-item:last-child {
            border-bottom: none;
        }
        .test-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        .test-icon.pass {
            background: #48bb78;
        }
        .test-icon.fail {
            background: #f56565;
        }
        .test-icon.pending {
            background: #a0aec0;
        }
        .activity-preview {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #4299e1;
        }
        .activity-preview h4 {
            margin: 0 0 8px 0;
            color: #2d3748;
        }
        .activity-preview p {
            margin: 4px 0;
            color: #718096;
            font-size: 14px;
        }
        .nav-links {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .nav-links a {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #718096;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ æ´»åŠ¨åˆ›å»ºä¿®å¤æœ€ç»ˆéªŒè¯</h1>
        <p>å®Œæ•´æµ‹è¯•æ´»åŠ¨åˆ›å»ºåæ•°æ®åŒæ­¥å’Œæ˜¾ç¤ºåŠŸèƒ½</p>
    </div>

    <div class="nav-links">
        <a href="http://localhost:3001" target="_blank">ğŸ  ä¸»é¡µ</a>
        <a href="http://localhost:3001/views/activity/ActivityList.html" target="_blank">ğŸ“‹ æ´»åŠ¨åˆ—è¡¨</a>
        <a href="http://localhost:3001/views/activity/CreateActivity.html" target="_blank">â• åˆ›å»ºæ´»åŠ¨</a>
        <a href="http://localhost:3001/test-creation-fix.html" target="_blank">ğŸ§ª è°ƒè¯•é¡µé¢</a>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•è¿›åº¦</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="progressText">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•</h3>
            <button class="btn" onclick="runFullTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button class="btn success" onclick="runQuickTest()">âš¡ å¿«é€ŸéªŒè¯</button>
            <button class="btn warning" onclick="resetEnvironment()">ğŸ”„ é‡ç½®ç¯å¢ƒ</button>
            <div id="testStatus"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ æµ‹è¯•ç»“æœ</h3>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ å½“å‰æ´»åŠ¨çŠ¶æ€</h3>
            <div id="activityStatus"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
            <div class="summary-stats" id="summaryStats"></div>
        </div>
    </div>

    <script>
        let testResults = [];
        let currentProgress = 0;

        function updateProgress(percent, text) {
            currentProgress = percent;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function addTestResult(testName, passed, message) {
            testResults.push({ name: testName, passed, message });
            updateTestResultsDisplay();
        }

        function updateTestResultsDisplay() {
            const resultsElement = document.getElementById('testResults');
            const html = testResults.map(result => `
                <div class="test-item">
                    <div class="test-icon ${result.passed ? 'pass' : 'fail'}">
                        ${result.passed ? 'âœ“' : 'âœ—'}
                    </div>
                    <div>
                        <strong>${result.name}</strong>
                        <div style="color: #718096; font-size: 14px;">${result.message}</div>
                    </div>
                </div>
            `).join('');
            resultsElement.innerHTML = html;
        }

        function updateSummaryStats() {
            const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const passedTests = testResults.filter(r => r.passed).length;
            const totalTests = testResults.length;

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${activities.length}</div>
                    <div class="stat-label">æ´»åŠ¨æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${user.username ? 'å·²ç™»å½•' : 'æœªç™»å½•'}</div>
                    <div class="stat-label">ç”¨æˆ·çŠ¶æ€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${passedTests}/${totalTests}</div>
                    <div class="stat-label">æµ‹è¯•é€šè¿‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalTests > 0 ? Math.round(passedTests/totalTests*100) : 0}%</div>
                    <div class="stat-label">æˆåŠŸç‡</div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = statsHtml;
        }

        function updateActivityStatus() {
            const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            let statusHtml = `
                <div class="status info">
                    <strong>ğŸ“Š æ´»åŠ¨æ•°æ®çŠ¶æ€:</strong><br>
                    ğŸ“ æ€»æ´»åŠ¨æ•°: ${activities.length}<br>
                    ğŸ‘¤ å½“å‰ç”¨æˆ·: ${user.nickname || user.username || 'æœªç™»å½•'}<br>
                    ğŸ•’ æœ€åæ›´æ–°: ${new Date().toLocaleString()}
                </div>
            `;
            
            // æ˜¾ç¤ºæœ€è¿‘çš„æ´»åŠ¨
            if (activities.length > 0) {
                const recentActivities = activities.slice(0, 3);
                statusHtml += '<h4>æœ€è¿‘æ´»åŠ¨:</h4>';
                recentActivities.forEach(activity => {
                    statusHtml += `
                        <div class="activity-preview">
                            <h4>${activity.title}</h4>
                            <p>ğŸ“… ${new Date(activity.startTime).toLocaleString()}</p>
                            <p>ğŸ“ ${activity.locationName || activity.location}</p>
                            <p>ğŸ‘¥ ${activity.currentParticipants}/${activity.maxParticipants}</p>
                        </div>
                    `;
                });
            }
            
            document.getElementById('activityStatus').innerHTML = statusHtml;
        }

        async function runFullTest() {
            testResults = [];
            updateProgress(0, 'å¼€å§‹å®Œæ•´æµ‹è¯•...');
            
            try {
                // æµ‹è¯•1: ç¯å¢ƒæ£€æŸ¥
                updateProgress(10, 'æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ...');
                const envOk = await checkEnvironment();
                addTestResult('ç¯å¢ƒæ£€æŸ¥', envOk, envOk ? 'æµ‹è¯•ç¯å¢ƒæ­£å¸¸' : 'æµ‹è¯•ç¯å¢ƒå¼‚å¸¸');
                
                // æµ‹è¯•2: ç”¨æˆ·ç™»å½•
                updateProgress(25, 'æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•...');
                const loginOk = await simulateLogin();
                addTestResult('ç”¨æˆ·ç™»å½•', loginOk, loginOk ? 'ç”¨æˆ·ç™»å½•æˆåŠŸ' : 'ç”¨æˆ·ç™»å½•å¤±è´¥');
                
                // æµ‹è¯•3: åˆ›å»ºæ´»åŠ¨
                updateProgress(50, 'åˆ›å»ºæµ‹è¯•æ´»åŠ¨...');
                const createOk = await createTestActivity();
                addTestResult('æ´»åŠ¨åˆ›å»º', createOk, createOk ? 'æ´»åŠ¨åˆ›å»ºæˆåŠŸ' : 'æ´»åŠ¨åˆ›å»ºå¤±è´¥');
                
                // æµ‹è¯•4: æ•°æ®åŒæ­¥éªŒè¯
                updateProgress(75, 'éªŒè¯æ•°æ®åŒæ­¥...');
                const syncOk = await verifyDataSync();
                addTestResult('æ•°æ®åŒæ­¥', syncOk, syncOk ? 'æ•°æ®åŒæ­¥æ­£å¸¸' : 'æ•°æ®åŒæ­¥å¼‚å¸¸');
                
                // æµ‹è¯•5: åˆ—è¡¨æ˜¾ç¤ºéªŒè¯
                updateProgress(90, 'éªŒè¯åˆ—è¡¨æ˜¾ç¤º...');
                const displayOk = await verifyListDisplay();
                addTestResult('åˆ—è¡¨æ˜¾ç¤º', displayOk, displayOk ? 'åˆ—è¡¨æ˜¾ç¤ºæ­£å¸¸' : 'åˆ—è¡¨æ˜¾ç¤ºå¼‚å¸¸');
                
                updateProgress(100, 'æµ‹è¯•å®Œæˆï¼');
                const allPassed = testResults.every(r => r.passed);
                showStatus('testStatus', 
                    `æµ‹è¯•å®Œæˆï¼${allPassed ? 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡' : 'âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥'}`, 
                    allPassed ? 'success' : 'error'
                );
                
            } catch (error) {
                updateProgress(100, 'æµ‹è¯•å¼‚å¸¸ç»ˆæ­¢');
                showStatus('testStatus', `æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                addTestResult('æµ‹è¯•æ‰§è¡Œ', false, `å¼‚å¸¸: ${error.message}`);
            }
            
            updateSummaryStats();
            updateActivityStatus();
        }

        async function runQuickTest() {
            testResults = [];
            updateProgress(0, 'å¿«é€ŸéªŒè¯ä¸­...');
            
            try {
                // å¿«é€Ÿæ£€æŸ¥æ•°æ®çŠ¶æ€
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                updateProgress(33, 'æ£€æŸ¥æ•°æ®å­˜å‚¨...');
                const hasData = activities.length > 0;
                addTestResult('æ•°æ®å­˜å‚¨', hasData, `å‘ç°${activities.length}ä¸ªæ´»åŠ¨`);
                
                updateProgress(66, 'æ£€æŸ¥ç”¨æˆ·çŠ¶æ€...');
                const hasUser = !!user.username;
                addTestResult('ç”¨æˆ·çŠ¶æ€', hasUser, hasUser ? 'ç”¨æˆ·å·²ç™»å½•' : 'ç”¨æˆ·æœªç™»å½•');
                
                updateProgress(100, 'å¿«é€ŸéªŒè¯å®Œæˆ');
                showStatus('testStatus', 'å¿«é€ŸéªŒè¯å®Œæˆ', 'info');
                
            } catch (error) {
                updateProgress(100, 'å¿«é€ŸéªŒè¯å¤±è´¥');
                showStatus('testStatus', `å¿«é€ŸéªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateSummaryStats();
            updateActivityStatus();
        }

        async function checkEnvironment() {
            try {
                // æ£€æŸ¥localStorageå¯ç”¨æ€§
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                
                // æ£€æŸ¥å¿…è¦çš„APIå‡½æ•°
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                return true;
            } catch (error) {
                console.error('ç¯å¢ƒæ£€æŸ¥å¤±è´¥:', error);
                return false;
            }
        }

        async function simulateLogin() {
            try {
                const testUser = {
                    id: 'test_user_final',
                    username: 'finaltest',
                    nickname: 'æœ€ç»ˆæµ‹è¯•ç”¨æˆ·',
                    email: 'final@test.com',
                    avatar: '',
                    phone: '13800138000',
                    studentId: '2021001999',
                    major: 'è½¯ä»¶å·¥ç¨‹',
                    grade: '2021çº§',
                    reputation: 90,
                    isVerified: true,
                    createdAt: new Date().toISOString()
                };
                
                localStorage.setItem('currentUser', JSON.stringify(testUser));
                localStorage.setItem('token', 'final_test_token_' + Date.now());
                
                return true;
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                return false;
            }
        }

        async function createTestActivity() {
            try {
                const testActivity = {
                    title: 'æœ€ç»ˆéªŒè¯æ´»åŠ¨_' + Date.now(),
                    description: 'è¿™æ˜¯ç”¨äºæœ€ç»ˆéªŒè¯çš„æ´»åŠ¨',
                    category: 'study',
                    startTime: new Date(Date.now() + 86400000).toISOString(),
                    endTime: new Date(Date.now() + 86400000 + 3600000).toISOString(),
                    location: {
                        name: 'æœ€ç»ˆéªŒè¯åœ°ç‚¹',
                        address: 'æœ€ç»ˆéªŒè¯åœ°å€'
                    },
                    maxParticipants: 25,
                    tags: ['æœ€ç»ˆéªŒè¯', 'æµ‹è¯•'],
                    joinType: 'free'
                };
                
                const response = await mockCreateActivity(testActivity);
                return response.success;
            } catch (error) {
                console.error('åˆ›å»ºæ´»åŠ¨å¤±è´¥:', error);
                return false;
            }
        }

        async function verifyDataSync() {
            try {
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                const hasNewActivity = activities.some(a => a.title.includes('æœ€ç»ˆéªŒè¯æ´»åŠ¨_'));
                return hasNewActivity;
            } catch (error) {
                console.error('æ•°æ®åŒæ­¥éªŒè¯å¤±è´¥:', error);
                return false;
            }
        }

        async function verifyListDisplay() {
            try {
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                return activities.length > 0 && activities.every(a => a.id && a.title);
            } catch (error) {
                console.error('åˆ—è¡¨æ˜¾ç¤ºéªŒè¯å¤±è´¥:', error);
                return false;
            }
        }

        function resetEnvironment() {
            try {
                // æ¸…ç†æµ‹è¯•æ•°æ®
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                const filteredActivities = activities.filter(activity => 
                    !activity.title.includes('æµ‹è¯•æ´»åŠ¨_') && 
                    !activity.title.includes('æœ€ç»ˆéªŒè¯æ´»åŠ¨_')
                );
                localStorage.setItem('campus_activities', JSON.stringify(filteredActivities));
                
                // æ¸…ç†ç”¨æˆ·æ•°æ®
                localStorage.removeItem('currentUser');
                localStorage.removeItem('token');
                
                // é‡ç½®æµ‹è¯•ç»“æœ
                testResults = [];
                updateTestResultsDisplay();
                
                updateProgress(0, 'ç¯å¢ƒå·²é‡ç½®');
                showStatus('testStatus', 'âœ… æµ‹è¯•ç¯å¢ƒå·²é‡ç½®', 'success');
                updateSummaryStats();
                updateActivityStatus();
                
            } catch (error) {
                showStatus('testStatus', `é‡ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // Mock API function
        async function mockCreateActivity(activityData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    try {
                        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                        
                        const newActivity = {
                            id: 'activity_' + Date.now(),
                            ...activityData,
                            creatorId: currentUser.id || 'anonymous',
                            creatorName: currentUser.nickname || currentUser.username || 'åŒ¿åç”¨æˆ·',
                            currentParticipants: 0,
                            createdAt: new Date().toISOString(),
                            status: 'upcoming',
                            isEnrolled: false,
                            isApproved: false,
                            isCreator: true
                        };
                        
                        const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                        activities.unshift(newActivity);
                        localStorage.setItem('campus_activities', JSON.stringify(activities));
                        
                        resolve({
                            success: true,
                            data: newActivity,
                            message: 'æ´»åŠ¨åˆ›å»ºæˆåŠŸ'
                        });
                    } catch (error) {
                        resolve({
                            success: false,
                            message: error.message
                        });
                    }
                }, 100);
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            updateProgress(0, 'é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•');
            updateSummaryStats();
            updateActivityStatus();
        });

        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(() => {
            updateActivityStatus();
        }, 10000);
    </script>
</body>
</html>