<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨æ•°æ®ä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 28px;
        }
        .header p {
            color: #7f8c8d;
            margin: 10px 0 0 0;
            font-size: 14px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #007bff;
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        .status-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .status-card.warning {
            border-left-color: #ffc107;
        }
        .status-card.warning .value {
            color: #ffc107;
        }
        .status-card.success {
            border-left-color: #28a745;
        }
        .status-card.success .value {
            color: #28a745;
        }
        .status-card.error {
            border-left-color: #dc3545;
        }
        .status-card.error .value {
            color: #dc3545;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        .log-section {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-section h3 {
            margin: 0 0 15px 0;
            color: #3498db;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #34495e;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            color: #95a5a6;
            margin-right: 10px;
        }
        .log-level-info {
            color: #3498db;
        }
        .log-level-success {
            color: #2ecc71;
        }
        .log-level-warning {
            color: #f39c12;
        }
        .log-level-error {
            color: #e74c3c;
        }
        .activity-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .activity-item {
            background: white;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .activity-item h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
        }
        .activity-item .meta {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .activity-item .description {
            font-size: 14px;
            color: #34495e;
            line-height: 1.4;
        }
        .progress-bar {
            background: #e9ecef;
            border-radius: 4px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            background: linear-gradient(90deg, #007bff, #28a745);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æ´»åŠ¨æ•°æ®ä¿®å¤å·¥å…·</h1>
            <p>è¯Šæ–­å’Œä¿®å¤æ´»åŠ¨æ•°æ®æ˜¾ç¤ºå¼‚å¸¸é—®é¢˜</p>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>ğŸ“Š localStorageçŠ¶æ€</h3>
                <div class="value" id="storage-status">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ“¦ æ´»åŠ¨æ•°æ®æ•°é‡</h3>
                <div class="value" id="activity-count">0</div>
            </div>
            <div class="status-card">
                <h3>ğŸ”„ æ•°æ®é‡å¤æ£€æŸ¥</h3>
                <div class="value" id="duplicate-check">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <h3>âš™ï¸ Mockæ¨¡å¼çŠ¶æ€</h3>
                <div class="value" id="mock-status">æ£€æŸ¥ä¸­...</div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" onclick="runDiagnosis()">ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button class="btn btn-success" onclick="fixActivityData()">âœ… ä¿®å¤æ´»åŠ¨æ•°æ®</button>
            <button class="btn btn-warning" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰æ•°æ®</button>
            <button class="btn btn-danger" onclick="forceReset()">ğŸ”„ å¼ºåˆ¶é‡ç½®</button>
            <a href="/activities" class="btn btn-primary">ğŸ‘€ æŸ¥çœ‹æ´»åŠ¨åˆ—è¡¨</a>
        </div>

        <div class="progress-bar" id="progress-container" style="display: none;">
            <div class="progress-fill" id="progress-fill">0%</div>
        </div>

        <div class="activity-list" id="activity-list" style="display: none;">
            <h3>ğŸ“‹ å½“å‰æ´»åŠ¨æ•°æ®</h3>
            <div id="activity-items"></div>
        </div>

        <div class="log-section">
            <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
            <div id="log-container"></div>
        </div>
    </div>

    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        const logContainer = document.getElementById('log-container');
        
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">${message}</span>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(percent) {
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
            
            if (percent >= 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
        }

        // æ£€æŸ¥localStorageçŠ¶æ€
        function checkStorageStatus() {
            try {
                const activities = localStorage.getItem('campus_activities');
                if (!activities) {
                    document.getElementById('storage-status').textContent = 'æ— æ•°æ®';
                    document.getElementById('storage-status').parentElement.className = 'status-card warning';
                    return false;
                }
                
                const parsed = JSON.parse(activities);
                if (!Array.isArray(parsed)) {
                    document.getElementById('storage-status').textContent = 'æ ¼å¼é”™è¯¯';
                    document.getElementById('storage-status').parentElement.className = 'status-card error';
                    return false;
                }
                
                document.getElementById('storage-status').textContent = 'æ­£å¸¸';
                document.getElementById('storage-status').parentElement.className = 'status-card success';
                document.getElementById('activity-count').textContent = parsed.length;
                return true;
            } catch (error) {
                document.getElementById('storage-status').textContent = 'å¼‚å¸¸';
                document.getElementById('storage-status').parentElement.className = 'status-card error';
                addLog(`æ£€æŸ¥localStorageå¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æ£€æŸ¥æ•°æ®é‡å¤
        function checkDuplicates() {
            try {
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                const titles = activities.map(a => a.title);
                const uniqueTitles = [...new Set(titles)];
                
                if (titles.length !== uniqueTitles.length) {
                    const duplicates = titles.filter((title, index) => titles.indexOf(title) !== index);
                    document.getElementById('duplicate-check').textContent = `å‘ç°é‡å¤`;
                    document.getElementById('duplicate-check').parentElement.className = 'status-card error';
                    addLog(`å‘ç°é‡å¤çš„æ´»åŠ¨æ ‡é¢˜: ${[...new Set(duplicates)].join(', ')}`, 'error');
                    return false;
                }
                
                document.getElementById('duplicate-check').textContent = 'æ— é‡å¤';
                document.getElementById('duplicate-check').parentElement.className = 'status-card success';
                return true;
            } catch (error) {
                document.getElementById('duplicate-check').textContent = 'æ£€æŸ¥å¤±è´¥';
                document.getElementById('duplicate-check').parentElement.className = 'status-card error';
                return false;
            }
        }

        // æ£€æŸ¥Mockæ¨¡å¼
        function checkMockStatus() {
            // åœ¨HTMLç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—®import.meta.env
            // é€šè¿‡æ£€æŸ¥localStorageä¸­çš„æ•°æ®æ¥åˆ¤æ–­æ˜¯å¦ä½¿ç”¨Mockæ¨¡å¼
            const hasMockData = localStorage.getItem('campus_activities') !== null;
            
            if (hasMockData) {
                document.getElementById('mock-status').textContent = 'å¯èƒ½å¯ç”¨';
                document.getElementById('mock-status').parentElement.className = 'status-card warning';
                addLog('æ£€æµ‹åˆ°æœ¬åœ°æ´»åŠ¨æ•°æ®ï¼Œå¯èƒ½ä½¿ç”¨Mockæ¨¡å¼', 'warning');
            } else {
                document.getElementById('mock-status').textContent = 'æœªçŸ¥';
                document.getElementById('mock-status').parentElement.className = 'status-card';
                addLog('æ— æ³•ç¡®å®šMockæ¨¡å¼çŠ¶æ€', 'info');
            }
        }

        // æ˜¾ç¤ºæ´»åŠ¨åˆ—è¡¨
        function displayActivities() {
            try {
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                const activityItems = document.getElementById('activity-items');
                const activityList = document.getElementById('activity-list');
                
                if (activities.length === 0) {
                    activityItems.innerHTML = '<p style="text-align: center; color: #7f8c8d;">æš‚æ— æ´»åŠ¨æ•°æ®</p>';
                } else {
                    activityItems.innerHTML = activities.map(activity => `
                        <div class="activity-item">
                            <h4>${activity.title}</h4>
                            <div class="meta">
                                ğŸ“… ${new Date(activity.startTime).toLocaleDateString()} | 
                                ğŸ“ ${activity.locationName || activity.location} | 
                                ğŸ‘¥ ${activity.currentParticipants}/${activity.maxParticipants}äºº
                            </div>
                            <div class="description">${activity.description}</div>
                        </div>
                    `).join('');
                }
                
                activityList.style.display = 'block';
            } catch (error) {
                addLog(`æ˜¾ç¤ºæ´»åŠ¨åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œå®Œæ•´è¯Šæ–­
        async function runDiagnosis() {
            addLog('å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­...', 'info');
            updateProgress(0);
            
            updateProgress(20);
            checkStorageStatus();
            
            updateProgress(40);
            checkDuplicates();
            
            updateProgress(60);
            checkMockStatus();
            
            updateProgress(80);
            displayActivities();
            
            updateProgress(100);
            addLog('è¯Šæ–­å®Œæˆï¼', 'success');
        }

        // ä¿®å¤æ´»åŠ¨æ•°æ®
        function fixActivityData() {
            addLog('å¼€å§‹ä¿®å¤æ´»åŠ¨æ•°æ®...', 'info');
            
            try {
                // åˆ›å»ºæ­£ç¡®çš„é»˜è®¤æ´»åŠ¨æ•°æ®
                const correctActivities = [
                    {
                        id: 1,
                        title: 'ä¸­åŒ»å…»ç”Ÿè®²åº§',
                        type: 'å­¦æœ¯è®²åº§',
                        category: 'study',
                        description: 'é‚€è¯·è‘—åä¸­åŒ»ä¸“å®¶è®²è§£ä¼ ç»Ÿå…»ç”ŸçŸ¥è¯†ï¼ŒåŒ…æ‹¬å››å­£å…»ç”Ÿã€é£Ÿç–—å…»ç”Ÿã€è¿åŠ¨å…»ç”Ÿç­‰å†…å®¹ã€‚ç°åœºè¿˜æœ‰å…è´¹ä¸­åŒ»ä½“è´¨æ£€æµ‹æœåŠ¡ã€‚',
                        organizerId: 1,
                        organizerName: 'ä¸­åŒ»å­¦é™¢',
                        startTime: new Date(Date.now() + 86400000 * 2).toISOString(),
                        endTime: new Date(Date.now() + 86400000 * 2 + 10800000).toISOString(),
                        location: 'å­¦æœ¯æŠ¥å‘Šå…',
                        locationName: 'å­¦æœ¯æŠ¥å‘Šå…',
                        maxParticipants: 200,
                        currentParticipants: 156,
                        status: 'recruiting',
                        tags: ['å¥åº·', 'å…»ç”Ÿ', 'ä¸­åŒ»', 'è®²åº§'],
                        coverImage: '/activity-cover-1.png',
                        createdAt: new Date().toISOString(),
                        distance: 0.3
                    },
                    {
                        id: 2,
                        title: 'æ‘„å½±ä½œå“å±•è§ˆ',
                        type: 'æ–‡åŒ–è‰ºæœ¯',
                        category: 'culture',
                        description: 'å±•ç¤ºæˆ‘æ ¡æ‘„å½±çˆ±å¥½è€…çš„ä¼˜ç§€ä½œå“ï¼ŒåŒ…æ‹¬æ ¡å›­é£å…‰ã€äººç‰©è‚–åƒã€çºªå®æ‘„å½±ç­‰å¤šç±»åˆ«ã€‚å¼€å¹•å¼å°†æœ‰ä¸“ä¸šæ‘„å½±å¸ˆç°åœºåˆ†äº«æ‹æ‘„æŠ€å·§ã€‚',
                        organizerId: 2,
                        organizerName: 'æ‘„å½±åä¼š',
                        startTime: new Date(Date.now() + 86400000 * 3).toISOString(),
                        endTime: new Date(Date.now() + 86400000 * 3 + 28800000).toISOString(),
                        location: 'è‰ºæœ¯å±•è§ˆä¸­å¿ƒ',
                        locationName: 'è‰ºæœ¯å±•è§ˆä¸­å¿ƒ',
                        maxParticipants: 500,
                        currentParticipants: 234,
                        status: 'recruiting',
                        tags: ['æ‘„å½±', 'è‰ºæœ¯', 'å±•è§ˆ', 'æ–‡åŒ–'],
                        coverImage: '/activity-cover-2.png',
                        createdAt: new Date().toISOString(),
                        distance: 0.5
                    },
                    {
                        id: 3,
                        title: 'ç¼–ç¨‹é©¬æ‹‰æ¾å¤§èµ›',
                        type: 'ç§‘æŠ€åˆ›æ–°',
                        category: 'tech',
                        description: '48å°æ—¶ç¼–ç¨‹æŒ‘æˆ˜èµ›ï¼Œä¸»é¢˜ä¸º"æ™ºæ…§æ ¡å›­"ã€‚å‚èµ›è€…éœ€è¦åœ¨è§„å®šæ—¶é—´å†…å®Œæˆåˆ›æ–°é¡¹ç›®å¼€å‘ï¼Œä¼˜èƒœå›¢é˜Ÿå°†è·å¾—ä¸°åšå¥–å“å’Œå®ä¹ æœºä¼šã€‚',
                        organizerId: 3,
                        organizerName: 'è®¡ç®—æœºå­¦é™¢',
                        startTime: new Date(Date.now() + 86400000 * 4).toISOString(),
                        endTime: new Date(Date.now() + 86400000 * 6).toISOString(),
                        location: 'åˆ›æ–°å®éªŒå®¤',
                        locationName: 'åˆ›æ–°å®éªŒå®¤',
                        maxParticipants: 100,
                        currentParticipants: 87,
                        status: 'recruiting',
                        tags: ['ç¼–ç¨‹', 'åˆ›æ–°', 'æ¯”èµ›', 'æŠ€æœ¯'],
                        coverImage: '/activity-cover-3.png',
                        createdAt: new Date().toISOString(),
                        distance: 1.2
                    },
                    {
                        id: 4,
                        title: 'ç¯®çƒå‹è°Šèµ›',
                        type: 'ä½“è‚²ç«æŠ€',
                        category: 'sports',
                        description: 'é™¢ç³»é—´ç¯®çƒå‹è°Šèµ›ï¼Œä¿ƒè¿›å„é™¢ç³»äº¤æµã€‚æ¯”èµ›é‡‡ç”¨å›½é™…ç¯®è”è§„åˆ™ï¼Œè®¾æœ‰MVPå¥–é¡¹å’Œæœ€ä½³å›¢é˜Ÿå¥–ã€‚',
                        organizerId: 4,
                        organizerName: 'ä½“è‚²éƒ¨',
                        startTime: new Date(Date.now() + 86400000 * 5).toISOString(),
                        endTime: new Date(Date.now() + 86400000 * 5 + 7200000).toISOString(),
                        location: 'ä½“è‚²é¦†',
                        locationName: 'ä½“è‚²é¦†',
                        maxParticipants: 200,
                        currentParticipants: 178,
                        status: 'recruiting',
                        tags: ['ç¯®çƒ', 'ä½“è‚²', 'æ¯”èµ›', 'å‹è°Šèµ›'],
                        coverImage: '/activity-cover-4.png',
                        createdAt: new Date().toISOString(),
                        distance: 0.8
                    },
                    {
                        id: 5,
                        title: 'æ ¡å›­éŸ³ä¹èŠ‚',
                        type: 'æ–‡è‰ºæ¼”å‡º',
                        category: 'culture',
                        description: 'å¹´åº¦æ ¡å›­éŸ³ä¹ç››å…¸ï¼Œé‚€è¯·æ ¡å†…çŸ¥åä¹é˜Ÿå’Œæ ¡å¤–ä¸“ä¸šéŸ³ä¹äººåŒå°æ¼”å‡ºã€‚æ¶µç›–æ‘‡æ»šã€æ°‘è°£ã€æµè¡Œç­‰å¤šç§éŸ³ä¹é£æ ¼ã€‚',
                        organizerId: 5,
                        organizerName: 'å­¦ç”Ÿä¼šæ–‡è‰ºéƒ¨',
                        startTime: new Date(Date.now() + 86400000 * 6).toISOString(),
                        endTime: new Date(Date.now() + 86400000 * 6 + 14400000).toISOString(),
                        location: 'å¤§å­¦ç”Ÿæ´»åŠ¨ä¸­å¿ƒ',
                        locationName: 'å¤§å­¦ç”Ÿæ´»åŠ¨ä¸­å¿ƒ',
                        maxParticipants: 1000,
                        currentParticipants: 856,
                        status: 'recruiting',
                        tags: ['éŸ³ä¹', 'æ¼”å‡º', 'æ–‡è‰º', 'éŸ³ä¹èŠ‚'],
                        coverImage: '/activity-cover-5.png',
                        createdAt: new Date().toISOString(),
                        distance: 0.6
                    }
                ];
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('campus_activities', JSON.stringify(correctActivities));
                
                addLog(`æ´»åŠ¨æ•°æ®ä¿®å¤å®Œæˆï¼Œå…±ä¿®å¤${correctActivities.length}ä¸ªæ´»åŠ¨`, 'success');
                
                // åˆ·æ–°çŠ¶æ€
                setTimeout(() => {
                    runDiagnosis();
                }, 1000);
                
            } catch (error) {
                addLog(`ä¿®å¤æ´»åŠ¨æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç†æ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æ´»åŠ¨æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                addLog('æ¸…ç†æ‰€æœ‰æ´»åŠ¨æ•°æ®...', 'warning');
                localStorage.removeItem('campus_activities');
                addLog('æ´»åŠ¨æ•°æ®å·²æ¸…ç†', 'success');
                setTimeout(() => {
                    runDiagnosis();
                }, 1000);
            }
        }

        // å¼ºåˆ¶é‡ç½®
        function forceReset() {
            if (confirm('ç¡®å®šè¦å¼ºåˆ¶é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ¸…ç†æ‰€æœ‰ç¼“å­˜å¹¶é‡æ–°åˆå§‹åŒ–ï¼')) {
                addLog('å¼ºåˆ¶é‡ç½®ä¸­...', 'warning');
                
                // æ¸…ç†æ‰€æœ‰ç›¸å…³çš„localStorageæ•°æ®
                const keysToRemove = [
                    'campus_activities',
                    'activity_participants',
                    'activity_chats',
                    'user_data',
                    'auth_token'
                ];
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                addLog('æ‰€æœ‰æ•°æ®å·²æ¸…ç†ï¼Œæ­£åœ¨é‡æ–°åˆå§‹åŒ–...', 'info');
                
                // é‡æ–°è®¾ç½®æ­£ç¡®çš„æ´»åŠ¨æ•°æ®
                setTimeout(() => {
                    fixActivityData();
                }, 1000);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', () => {
            addLog('æ´»åŠ¨æ•°æ®ä¿®å¤å·¥å…·å·²åŠ è½½', 'info');
            runDiagnosis();
        });
    </script>
</body>
</html>