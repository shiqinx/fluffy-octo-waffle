<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨åˆ›å»ºæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .activity-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .activity-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .activity-item p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .nav-links {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .nav-links a {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .nav-links a:hover {
            background: #545b62;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ´»åŠ¨åˆ›å»ºä¿®å¤æµ‹è¯•</h1>
    
    <div class="nav-links">
        <a href="http://localhost:3001" target="_blank">ğŸ  ä¸»é¡µ</a>
        <a href="http://localhost:3001/views/activity/ActivityList.html" target="_blank">ğŸ“‹ æ´»åŠ¨åˆ—è¡¨</a>
        <a href="http://localhost:3001/views/activity/CreateActivity.html" target="_blank">â• åˆ›å»ºæ´»åŠ¨</a>
        <a href="http://localhost:3001/data-sync-debug.html" target="_blank">ğŸ” æ•°æ®è°ƒè¯•</a>
    </div>

    <div class="test-container">
        <h2>ğŸ“Š æ•°æ®çŠ¶æ€æ£€æŸ¥</h2>
        <div id="dataStatus"></div>
        <button class="btn" onclick="checkDataStatus()">åˆ·æ–°æ•°æ®çŠ¶æ€</button>
        <button class="btn warning" onclick="clearTestData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
    </div>

    <div class="test-container">
        <h2>ğŸ§ª æµ‹è¯•æ“ä½œ</h2>
        <div class="test-section">
            <h3>1. æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•</h3>
            <button class="btn" onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•æµ‹è¯•ç”¨æˆ·</button>
            <div id="loginStatus"></div>
        </div>

        <div class="test-section">
            <h3>2. åˆ›å»ºæµ‹è¯•æ´»åŠ¨</h3>
            <button class="btn success" onclick="createTestActivity()">åˆ›å»ºæµ‹è¯•æ´»åŠ¨</button>
            <div id="creationStatus"></div>
        </div>

        <div class="test-section">
            <h3>3. éªŒè¯æ•°æ®åŒæ­¥</h3>
            <button class="btn" onclick="verifySync()">éªŒè¯æ•°æ®åŒæ­¥</button>
            <div id="syncStatus"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ“‹ å½“å‰æ´»åŠ¨åˆ—è¡¨</h2>
        <div id="activityList" class="activity-list"></div>
    </div>

    <div class="test-container">
        <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
        <div id="logOutput" class="log"></div>
        <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        let logMessages = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logMessages.push(logMessage);
            
            const logOutput = document.getElementById('logOutput');
            logOutput.textContent = logMessages.join('\n');
            logOutput.scrollTop = logOutput.scrollHeight;
            
            console.log(logMessage);
        }

        function clearLog() {
            logMessages = [];
            document.getElementById('logOutput').textContent = '';
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function checkDataStatus() {
            try {
                log('ğŸ” æ£€æŸ¥æ•°æ®çŠ¶æ€...');
                
                // æ£€æŸ¥localStorage
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                const statusHtml = `
                    <div class="status info">
                        <strong>ğŸ“Š æ•°æ®çŠ¶æ€:</strong><br>
                        ğŸ“ æ´»åŠ¨æ•°é‡: ${activities.length}<br>
                        ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: ${user.username ? user.username : 'æœªç™»å½•'}<br>
                        ğŸ•’ æœ€åæ›´æ–°: ${new Date().toLocaleString()}
                    </div>
                `;
                
                document.getElementById('dataStatus').innerHTML = statusHtml;
                
                // æ›´æ–°æ´»åŠ¨åˆ—è¡¨æ˜¾ç¤º
                updateActivityList(activities);
                
                log(`âœ… æ•°æ®çŠ¶æ€æ£€æŸ¥å®Œæˆ: ${activities.length}ä¸ªæ´»åŠ¨`);
            } catch (error) {
                log(`âŒ æ£€æŸ¥æ•°æ®çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
                showStatus('dataStatus', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function updateActivityList(activities) {
            const listElement = document.getElementById('activityList');
            
            if (activities.length === 0) {
                listElement.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ´»åŠ¨</p>';
                return;
            }
            
            const activitiesHtml = activities.map(activity => `
                <div class="activity-item">
                    <h4>${activity.title}</h4>
                    <p>ğŸ“… æ—¶é—´: ${new Date(activity.startTime).toLocaleString()}</p>
                    <p>ğŸ“ åœ°ç‚¹: ${activity.locationName || activity.location}</p>
                    <p>ğŸ‘¥ äººæ•°: ${activity.currentParticipants}/${activity.maxParticipants}</p>
                    <p>ğŸ†” ID: ${activity.id}</p>
                </div>
            `).join('');
            
            listElement.innerHTML = activitiesHtml;
        }

        async function simulateLogin() {
            try {
                log('ğŸ‘¤ æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•...');
                
                const testUser = {
                    id: 'test_user_' + Date.now(),
                    username: 'testuser',
                    nickname: 'æµ‹è¯•ç”¨æˆ·',
                    email: 'test@example.com',
                    avatar: '',
                    phone: '13800138000',
                    studentId: '2021001001',
                    major: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯',
                    grade: '2021çº§',
                    reputation: 85,
                    isVerified: true,
                    createdAt: new Date().toISOString()
                };
                
                localStorage.setItem('currentUser', JSON.stringify(testUser));
                localStorage.setItem('token', 'mock_token_' + Date.now());
                
                showStatus('loginStatus', 'âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ', 'success');
                log('âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ: ' + testUser.username);
                
                // æ›´æ–°æ•°æ®çŠ¶æ€
                await checkDataStatus();
            } catch (error) {
                log(`âŒ ç™»å½•å¤±è´¥: ${error.message}`, 'error');
                showStatus('loginStatus', `ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function createTestActivity() {
            try {
                log('ğŸ¯ å¼€å§‹åˆ›å»ºæµ‹è¯•æ´»åŠ¨...');
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (!currentUser.username) {
                    throw new Error('è¯·å…ˆç™»å½•');
                }
                
                const testActivity = {
                    title: 'æµ‹è¯•æ´»åŠ¨_' + Date.now(),
                    description: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•æ•°æ®åŒæ­¥çš„æ´»åŠ¨',
                    category: 'study',
                    startTime: new Date(Date.now() + 86400000).toISOString(), // æ˜å¤©
                    endTime: new Date(Date.now() + 86400000 + 3600000).toISOString(), // æ˜å¤©+1å°æ—¶
                    location: {
                        name: 'æµ‹è¯•åœ°ç‚¹',
                        address: 'æµ‹è¯•åœ°å€'
                    },
                    maxParticipants: 20,
                    tags: ['æµ‹è¯•', 'åŒæ­¥'],
                    joinType: 'free'
                };
                
                // è°ƒç”¨mock APIåˆ›å»ºæ´»åŠ¨
                const response = await mockCreateActivity(testActivity);
                
                if (response.success) {
                    showStatus('creationStatus', `âœ… æ´»åŠ¨åˆ›å»ºæˆåŠŸ: ${response.data.title}`, 'success');
                    log(`âœ… æ´»åŠ¨åˆ›å»ºæˆåŠŸ: ${response.data.title} (ID: ${response.data.id})`);
                    
                    // ç­‰å¾…æ•°æ®åŒæ­¥
                    setTimeout(async () => {
                        await checkDataStatus();
                        await verifySync();
                    }, 500);
                } else {
                    throw new Error(response.message || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                log(`âŒ åˆ›å»ºæ´»åŠ¨å¤±è´¥: ${error.message}`, 'error');
                showStatus('creationStatus', `åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function verifySync() {
            try {
                log('ğŸ” éªŒè¯æ•°æ®åŒæ­¥...');
                
                // æ£€æŸ¥localStorageä¸­çš„æ•°æ®
                const storedActivities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                
                // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                const hasValidActivities = storedActivities.length > 0;
                const hasValidStructure = storedActivities.every(activity => 
                    activity.id && activity.title && activity.startTime
                );
                
                if (hasValidActivities && hasValidStructure) {
                    showStatus('syncStatus', `âœ… æ•°æ®åŒæ­¥æ­£å¸¸ (${storedActivities.length}ä¸ªæ´»åŠ¨)`, 'success');
                    log(`âœ… æ•°æ®åŒæ­¥éªŒè¯é€šè¿‡: ${storedActivities.length}ä¸ªæ´»åŠ¨`);
                } else {
                    throw new Error('æ•°æ®åŒæ­¥å¼‚å¸¸æˆ–æ•°æ®ç»“æ„ä¸å®Œæ•´');
                }
            } catch (error) {
                log(`âŒ æ•°æ®åŒæ­¥éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                showStatus('syncStatus', `åŒæ­¥éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearTestData() {
            try {
                log('ğŸ—‘ï¸ æ¸…ç†æµ‹è¯•æ•°æ®...');
                
                // ä¿ç•™é»˜è®¤æ´»åŠ¨ï¼Œåªæ¸…ç†æµ‹è¯•åˆ›å»ºçš„æ´»åŠ¨
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                const filteredActivities = activities.filter(activity => 
                    !activity.title.includes('æµ‹è¯•æ´»åŠ¨_')
                );
                
                localStorage.setItem('campus_activities', JSON.stringify(filteredActivities));
                
                showStatus('dataStatus', 'âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†', 'success');
                log('âœ… æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ');
                
                // æ›´æ–°æ˜¾ç¤º
                checkDataStatus();
            } catch (error) {
                log(`âŒ æ¸…ç†æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // Mock API function
        async function mockCreateActivity(activityData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    try {
                        // è·å–å½“å‰ç”¨æˆ·
                        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                        
                        // ç”Ÿæˆæ–°æ´»åŠ¨
                        const newActivity = {
                            id: 'activity_' + Date.now(),
                            ...activityData,
                            creatorId: currentUser.id || 'anonymous',
                            creatorName: currentUser.nickname || currentUser.username || 'åŒ¿åç”¨æˆ·',
                            currentParticipants: 0,
                            createdAt: new Date().toISOString(),
                            status: 'upcoming',
                            isEnrolled: false,
                            isApproved: false,
                            isCreator: true
                        };
                        
                        // è·å–ç°æœ‰æ´»åŠ¨
                        const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                        
                        // æ·»åŠ æ–°æ´»åŠ¨åˆ°å¼€å¤´
                        activities.unshift(newActivity);
                        
                        // ä¿å­˜åˆ°localStorage
                        localStorage.setItem('campus_activities', JSON.stringify(activities));
                        
                        resolve({
                            success: true,
                            data: newActivity,
                            message: 'æ´»åŠ¨åˆ›å»ºæˆåŠŸ'
                        });
                    } catch (error) {
                        resolve({
                            success: false,
                            message: error.message
                        });
                    }
                }, 100); // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ•°æ®çŠ¶æ€
        window.addEventListener('load', () => {
            checkDataStatus();
            log('ğŸš€ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
        });

        // å®šæœŸåˆ·æ–°æ•°æ®çŠ¶æ€
        setInterval(checkDataStatus, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html>