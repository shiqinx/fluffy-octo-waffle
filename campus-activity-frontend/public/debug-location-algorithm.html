<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šä½ç®—æ³•å®æ—¶è°ƒè¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .input-section, .output-section {
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .point-analysis {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
        .point-analysis.selected {
            border-color: #28a745;
            background: #f8fff9;
        }
        .point-analysis.rejected {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 12px 0;
        }
        .metric {
            text-align: center;
            padding: 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
        }
        .metric-value {
            font-weight: bold;
            color: #007bff;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .coordinates-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .coordinates-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .algorithm-step {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 8px 0;
        }
        .final-result {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 16px;
            margin: 16px 0;
            font-weight: bold;
        }
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 8px 0;
        }
        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 12px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å®šä½ç®—æ³•å®æ—¶è°ƒè¯•</h1>
        <p>å®æ—¶æŸ¥çœ‹ç®—æ³•æ‰§è¡Œè¿‡ç¨‹ï¼Œæ‰¾å‡ºä¸ºä»€ä¹ˆä»ç„¶è¯†åˆ«ä¸º3æ ‹</p>
    </div>

    <div class="debug-grid">
        <div class="input-section">
            <h3>ğŸ“ è¾“å…¥ä½ç½®</h3>
            <div class="coordinates-input">
                <input type="number" id="latitude" placeholder="çº¬åº¦" step="0.0001" value="23.0419">
                <input type="number" id="longitude" placeholder="ç»åº¦" step="0.0001" value="113.4016">
            </div>
            <button onclick="testWithCurrentInput()">ğŸ§ª æµ‹è¯•å½“å‰åæ ‡</button>
            <button onclick="testLibraryLocation()">ğŸ“š æµ‹è¯•å›¾ä¹¦é¦†</button>
            <button onclick="testNearLibraryLocation()">ğŸ“ æµ‹è¯•å›¾ä¹¦é¦†é™„è¿‘</button>
            <button onclick="testDormitoryLocation()">ğŸ  æµ‹è¯•3æ ‹å®¿èˆ</button>
            
            <div style="margin-top: 16px;">
                <h4>ğŸ¯ é¢„è®¾æµ‹è¯•åœºæ™¯</h4>
                <button onclick="testScenario1()">åœºæ™¯1: å›¾ä¹¦é¦†æ­£ä¸­å¿ƒ</button>
                <button onclick="testScenario2()">åœºæ™¯2: å›¾ä¹¦é¦†è¾¹ç¼˜</button>
                <button onclick="testScenario3()">åœºæ™¯3: å›¾ä¹¦é¦†ä¸å®¿èˆé—´</button>
                <button onclick="testScenario4()">åœºæ™¯4: 3æ ‹å®¿èˆé™„è¿‘</button>
            </div>
        </div>

        <div class="output-section">
            <h3>ğŸ“Š ç®—æ³•æ‰§è¡Œç»“æœ</h3>
            <div id="algorithmResult">
                <p>ç­‰å¾…æµ‹è¯•...</p>
            </div>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ”¬ è¯¦ç»†åˆ†æè¿‡ç¨‹</h3>
        <div id="detailedAnalysis">
            <p>ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹åˆ†æ...</p>
        </div>
    </div>

    <script>
        // æ ¡å›­å‚è€ƒç‚¹é…ç½®
        const CAMPUS_REFERENCE_POINTS = [
            {
                name: 'å›¾ä¹¦é¦†',
                coords: [23.0419, 113.4016],
                radius: 150,
                priority: 1,
                weight: 1.0,
                buildingType: 'library'
            },
            {
                name: '4æ ‹å®¿èˆ',
                coords: [23.0415, 113.4020],
                radius: 100,
                priority: 2,
                weight: 0.4,
                buildingType: 'dormitory'
            },
            {
                name: '3æ ‹å®¿èˆ',
                coords: [23.0413, 113.4022],
                radius: 100,
                priority: 2,
                weight: 0.4,
                buildingType: 'dormitory'
            },
            {
                name: 'æ•™å­¦æ¥¼Aæ ‹',
                coords: [23.0421, 113.4012],
                radius: 120,
                priority: 3,
                weight: 0.7,
                buildingType: 'academic'
            },
            {
                name: 'ä½“è‚²é¦†',
                coords: [23.0417, 113.4010],
                radius: 150,
                priority: 2,
                weight: 0.5,
                buildingType: 'sports'
            },
            {
                name: 'é£Ÿå ‚',
                coords: [23.0423, 113.4018],
                radius: 120,
                priority: 3,
                weight: 0.4,
                buildingType: 'dining'
            }
        ];

        // è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lng2 - lng1) * Math.PI / 180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // æ–°ç®—æ³•è°ƒè¯•ç‰ˆæœ¬
        function debugAlgorithm(rawLocation) {
            const analysis = [];
            
            analysis.push({
                step: 'è¾“å…¥ä½ç½®',
                data: `çº¬åº¦: ${rawLocation.latitude}, ç»åº¦: ${rawLocation.longitude}`,
                type: 'info'
            });

            // æ­¥éª¤1: è®¡ç®—åˆ°å„å‚è€ƒç‚¹çš„è·ç¦»å’Œæƒé‡å¾—åˆ†
            const distances = CAMPUS_REFERENCE_POINTS.map(point => {
                const distance = calculateDistance(
                    rawLocation.latitude,
                    rawLocation.longitude,
                    point.coords[0],
                    point.coords[1]
                );
                
                const distanceScore = Math.max(0, 1 - distance / point.radius);
                const weightedScore = distanceScore * point.weight;
                
                return {
                    ...point,
                    distance: distance,
                    isInRange: distance <= point.radius,
                    distanceScore: distanceScore,
                    weightedScore: weightedScore
                };
            });

            analysis.push({
                step: 'è·ç¦»å’Œæƒé‡è®¡ç®—',
                data: distances.map(d => ({
                    name: d.name,
                    distance: d.distance.toFixed(1) + 'm',
                    isInRange: d.isInRange,
                    distanceScore: d.distanceScore.toFixed(3),
                    weightedScore: d.weightedScore.toFixed(3)
                })),
                type: 'calculation'
            });

            // æ­¥éª¤2: æ™ºèƒ½ç­›é€‰
            const inRangePoints = distances.filter(d => d.isInRange && d.weightedScore > 0.1);
            
            analysis.push({
                step: 'æ™ºèƒ½ç­›é€‰ (isInRange && weightedScore > 0.1)',
                data: inRangePoints.length > 0 ? 
                    inRangePoints.map(d => `${d.name}(${d.weightedScore.toFixed(3)})`).join(', ') :
                    'æ— ç¬¦åˆæ¡ä»¶çš„å‚è€ƒç‚¹',
                type: inRangePoints.length > 0 ? 'success' : 'warning'
            });

            if (inRangePoints.length === 0) {
                analysis.push({
                    step: 'ç®—æ³•ç»“æŸ',
                    data: 'æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ ¡å‡†ç‚¹ï¼Œè¿”å›åŸå§‹ä½ç½®',
                    type: 'error'
                });
                return { result: null, analysis: analysis };
            }

            // æ­¥éª¤3: æ’åº
            inRangePoints.sort((a, b) => {
                // å›¾ä¹¦é¦†ç‰¹æ®Šä¼˜å…ˆï¼šå¦‚æœæ˜¯å›¾ä¹¦é¦†ï¼Œç»™äºˆé¢å¤–ä¼˜åŠ¿
                const aLibraryBonus = a.buildingType === 'library' ? 0.2 : 0;
                const bLibraryBonus = b.buildingType === 'library' ? 0.2 : 0;
                
                const aFinalScore = a.weightedScore + aLibraryBonus;
                const bFinalScore = b.weightedScore + bLibraryBonus;
                
                // é¦–å…ˆæŒ‰æœ€ç»ˆå¾—åˆ†æ’åº
                if (Math.abs(aFinalScore - bFinalScore) > 0.05) {
                    return bFinalScore - aFinalScore;
                }
                // å¾—åˆ†ç›¸è¿‘æ—¶æŒ‰ä¼˜å…ˆçº§æ’åº
                if (a.priority !== b.priority) {
                    return a.priority - b.priority;
                }
                // æœ€åæŒ‰å®é™…è·ç¦»æ’åº
                return a.distance - b.distance;
            });

            analysis.push({
                step: 'æ’åºç»“æœ (å«å›¾ä¹¦é¦†åŠ æˆ)',
                data: inRangePoints.map((d, i) => {
                    const libraryBonus = d.buildingType === 'library' ? 0.2 : 0;
                    const finalScore = d.weightedScore + libraryBonus;
                    return `${i+1}. ${d.name}(æƒé‡:${d.weightedScore.toFixed(3)}, åŠ æˆ:${libraryBonus.toFixed(1)}, æœ€ç»ˆ:${finalScore.toFixed(3)}, ä¼˜å…ˆçº§:${d.priority}, è·ç¦»:${d.distance.toFixed(1)}m)`;
                }).join('<br>'),
                type: 'info'
            });

            const bestPoint = inRangePoints[0];
            const secondBest = inRangePoints[1];

            // æ­¥éª¤4: å¤šé‡éªŒè¯
            const condition1 = bestPoint.weightedScore > 0.3;
            const condition2 = !secondBest || bestPoint.weightedScore - secondBest.weightedScore > 0.1;
            
            analysis.push({
                step: 'é«˜ç½®ä¿¡åº¦éªŒè¯',
                data: `æƒé‡å¾—åˆ†>0.3: ${condition1 ? 'âœ…' : 'âŒ'} (${bestPoint.weightedScore.toFixed(3)})<br>
                       æ˜æ˜¾ä¼˜äºç¬¬äºŒ: ${condition2 ? 'âœ…' : 'âŒ'} ${secondBest ? `(å·®è·: ${(bestPoint.weightedScore - secondBest.weightedScore).toFixed(3)})` : '(æ— ç¬¬äºŒé€‰æ‹©)'}`,
                type: condition1 && condition2 ? 'success' : 'warning'
            });

            if (condition1 && condition2) {
                analysis.push({
                    step: 'æœ€ç»ˆç»“æœ',
                    data: `âœ… é«˜ç½®ä¿¡åº¦æ ¡å‡†: ${bestPoint.name}`,
                    type: 'success'
                });
                return { result: bestPoint, analysis: analysis, confidence: 'high' };
            }

            // æ­¥éª¤5: ä¸­ç­‰ç½®ä¿¡åº¦éªŒè¯
            const condition3 = bestPoint.distance <= 80;
            
            analysis.push({
                step: 'ä¸­ç­‰ç½®ä¿¡åº¦éªŒè¯',
                data: `è·ç¦»â‰¤80m: ${condition3 ? 'âœ…' : 'âŒ'} (${bestPoint.distance.toFixed(1)}m)`,
                type: condition3 ? 'success' : 'warning'
            });

            if (condition3) {
                analysis.push({
                    step: 'æœ€ç»ˆç»“æœ',
                    data: `âš ï¸ ä¸­ç­‰ç½®ä¿¡åº¦æ ¡å‡†: ${bestPoint.name}`,
                    type: 'warning'
                });
                return { result: bestPoint, analysis: analysis, confidence: 'medium' };
            }

            analysis.push({
                step: 'ç®—æ³•ç»“æŸ',
                data: 'âŒ æœªé€šè¿‡ä»»ä½•éªŒè¯ï¼Œè¿”å›åŸå§‹ä½ç½®',
                type: 'error'
            });
            return { result: null, analysis: analysis, confidence: 'none' };
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysis(debugResult) {
            const detailedAnalysis = document.getElementById('detailedAnalysis');
            const algorithmResult = document.getElementById('algorithmResult');
            
            // æ˜¾ç¤ºè¯¦ç»†åˆ†æè¿‡ç¨‹
            detailedAnalysis.innerHTML = debugResult.analysis.map(step => {
                const className = step.type === 'success' ? 'algorithm-step' :
                                 step.type === 'warning' ? 'warning' :
                                 step.type === 'error' ? 'error' : 'algorithm-step';
                
                let content = `<div class="${className}">
                    <strong>${step.step}:</strong><br>`;
                
                if (Array.isArray(step.data)) {
                    content += '<table style="width:100%; border-collapse: collapse;">';
                    content += step.data.map(item => 
                        `<tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 4px;">${item.name}</td>
                            <td style="padding: 4px;">${item.distance}</td>
                            <td style="padding: 4px;">${item.isInRange ? 'âœ…' : 'âŒ'}</td>
                            <td style="padding: 4px;">${item.distanceScore}</td>
                            <td style="padding: 4px;"><strong>${item.weightedScore}</strong></td>
                        </tr>`
                    ).join('');
                    content += '</table>';
                } else {
                    content += step.data;
                }
                
                content += '</div>';
                return content;
            }).join('');

            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            if (debugResult.result) {
                algorithmResult.innerHTML = `
                    <div class="final-result">
                        ğŸ¯ è¯†åˆ«ç»“æœ: ${debugResult.result.name}<br>
                        ğŸ“ åæ ‡: ${debugResult.result.coords[0]}, ${debugResult.result.coords[1]}<br>
                        ğŸ“ è·ç¦»: ${debugResult.result.distance.toFixed(1)}ç±³<br>
                        âš–ï¸ æƒé‡å¾—åˆ†: ${debugResult.result.weightedScore.toFixed(3)}<br>
                        ğŸ–ï¸ ä¼˜å…ˆçº§: ${debugResult.result.priority}<br>
                        ğŸ“Š ç½®ä¿¡åº¦: ${debugResult.confidence === 'high' ? 'é«˜' : debugResult.confidence === 'medium' ? 'ä¸­' : 'æ— '}
                    </div>
                `;
            } else {
                algorithmResult.innerHTML = `
                    <div class="error">
                        âŒ ç®—æ³•æœªæ‰¾åˆ°åˆé€‚çš„æ ¡å‡†ç‚¹<br>
                        å¯èƒ½åŸå› : æƒé‡å¾—åˆ†è¿‡ä½æˆ–è·ç¦»è¿‡è¿œ
                    </div>
                `;
            }
        }

        // æµ‹è¯•å‡½æ•°
        function testWithCurrentInput() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            testLocation({ latitude: lat, longitude: lng });
        }

        function testLibraryLocation() {
            testLocation({ latitude: 23.0419, longitude: 113.4016 });
        }

        function testNearLibraryLocation() {
            testLocation({ latitude: 23.04195, longitude: 113.40165 });
        }

        function testDormitoryLocation() {
            testLocation({ latitude: 23.0413, longitude: 113.4022 });
        }

        function testScenario1() {
            testLocation({ latitude: 23.0419, longitude: 113.4016 }); // å›¾ä¹¦é¦†æ­£ä¸­å¿ƒ
        }

        function testScenario2() {
            testLocation({ latitude: 23.04185, longitude: 113.40155 }); // å›¾ä¹¦é¦†è¾¹ç¼˜
        }

        function testScenario3() {
            testLocation({ latitude: 23.0417, longitude: 113.4018 }); // å›¾ä¹¦é¦†ä¸å®¿èˆé—´
        }

        function testScenario4() {
            testLocation({ latitude: 23.04135, longitude: 113.40215 }); // 3æ ‹å®¿èˆé™„è¿‘
        }

        function testLocation(rawLocation) {
            const debugResult = debugAlgorithm(rawLocation);
            displayAnalysis(debugResult);
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•å›¾ä¹¦é¦†ä½ç½®
        document.addEventListener('DOMContentLoaded', function() {
            testLibraryLocation();
        });
    </script>
</body>
</html>