<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯æ¨¡å—APIæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }

        .section h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #4f46e5;
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .result.success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .result.error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .result.info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status.warning {
            background: #fed7aa;
            color: #92400e;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .token-info {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .token-info h4 {
            margin-bottom: 10px;
            color: #1f2937;
        }

        .token-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .token-item:last-child {
            border-bottom: none;
        }

        .token-label {
            font-weight: 500;
            color: #374151;
        }

        .token-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            color: #6b7280;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” è®¤è¯æ¨¡å—APIæµ‹è¯•</h1>
            <p>æµ‹è¯•ç”¨æˆ·è®¤è¯ã€ä»¤ç‰Œç®¡ç†å’Œæƒé™éªŒè¯åŠŸèƒ½</p>
        </div>

        <div class="content">
            <!-- ç¯å¢ƒçŠ¶æ€ -->
            <div class="section">
                <h2>ç¯å¢ƒçŠ¶æ€</h2>
                <div id="environment-status"></div>
                <div class="token-info">
                    <h4>å½“å‰ä»¤ç‰ŒçŠ¶æ€</h4>
                    <div class="token-item">
                        <span class="token-label">è®¿é—®ä»¤ç‰Œ:</span>
                        <span class="token-value" id="access-token">æœªè®¾ç½®</span>
                    </div>
                    <div class="token-item">
                        <span class="token-label">åˆ·æ–°ä»¤ç‰Œ:</span>
                        <span class="token-value" id="refresh-token">æœªè®¾ç½®</span>
                    </div>
                    <div class="token-item">
                        <span class="token-label">ä»¤ç‰ŒçŠ¶æ€:</span>
                        <span class="token-value" id="token-status">æœªæ£€æŸ¥</span>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ç™»å½• -->
            <div class="section">
                <h2>ç”¨æˆ·ç™»å½•</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="username">ç”¨æˆ·å/å­¦å·</label>
                        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–å­¦å·" value="testuser">
                    </div>
                    <div class="form-group">
                        <label for="password">å¯†ç </label>
                        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " value="password123">
                    </div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="remember-me">
                    <label for="remember-me">è®°ä½æˆ‘ï¼ˆå»¶é•¿ä»¤ç‰Œæœ‰æ•ˆæœŸï¼‰</label>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="testLogin()">
                        <span>ğŸ”‘</span> ç™»å½•
                    </button>
                    <button class="btn btn-secondary" onclick="testLogout()">
                        <span>ğŸšª</span> ç™»å‡º
                    </button>
                </div>
                <div id="login-result"></div>
            </div>

            <!-- ä»¤ç‰Œç®¡ç† -->
            <div class="section">
                <h2>ä»¤ç‰Œç®¡ç†</h2>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="testCheckToken()">
                        <span>âœ…</span> æ£€æŸ¥ä»¤ç‰ŒçŠ¶æ€
                    </button>
                    <button class="btn btn-secondary" onclick="testRefreshToken()">
                        <span>ğŸ”„</span> åˆ·æ–°ä»¤ç‰Œ
                    </button>
                    <button class="btn btn-danger" onclick="clearTokens()">
                        <span>ğŸ—‘ï¸</span> æ¸…é™¤ä»¤ç‰Œ
                    </button>
                </div>
                <div id="token-result"></div>
            </div>

            <!-- è‡ªåŠ¨åˆ·æ–°æµ‹è¯• -->
            <div class="section">
                <h2>è‡ªåŠ¨åˆ·æ–°æµ‹è¯•</h2>
                <p style="margin-bottom: 15px; color: #6b7280;">
                    æµ‹è¯•ä»¤ç‰Œè¿‡æœŸæ—¶çš„è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ï¼ˆæ¨¡æ‹Ÿ401é”™è¯¯ï¼‰
                </p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="testAutoRefresh()">
                        <span>ğŸ¤–</span> æµ‹è¯•è‡ªåŠ¨åˆ·æ–°
                    </button>
                    <button class="btn btn-secondary" onclick="testConcurrentRequests()">
                        <span>âš¡</span> å¹¶å‘è¯·æ±‚æµ‹è¯•
                    </button>
                </div>
                <div id="auto-refresh-result"></div>
            </div>

            <!-- æµ‹è¯•æ—¥å¿— -->
            <div class="section">
                <h2>æµ‹è¯•æ—¥å¿—</h2>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="clearLog()">
                        <span>ğŸ§¹</span> æ¸…ç©ºæ—¥å¿—
                    </button>
                    <button class="btn btn-secondary" onclick="exportLog()">
                        <span>ğŸ“¥</span> å¯¼å‡ºæ—¥å¿—
                    </button>
                </div>
                <div id="test-log" class="result info">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <script type="module">
        // ç¯å¢ƒé…ç½®æ£€æµ‹
        function getEnvironmentConfig() {
            const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            const useMock = localStorage.getItem('useMock') === 'true'
            const apiBaseUrl = isDev 
                ? (localStorage.getItem('apiBaseUrl') || 'http://localhost:8080')
                : '/api'
            
            return { isDev, useMock, apiBaseUrl }
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const logElement = document.getElementById('test-log')
            const logEntry = `[${timestamp}] ${message}`
            
            logElement.textContent += logEntry + '\n'
            logElement.scrollTop = logElement.scrollHeight
            
            console.log(`[Auth Test] ${logEntry}`)
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, data, isSuccess = true) {
            const element = document.getElementById(elementId)
            element.className = `result ${isSuccess ? 'success' : 'error'}`
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        }

        // æ›´æ–°ä»¤ç‰ŒçŠ¶æ€æ˜¾ç¤º
        function updateTokenStatus() {
            const accessToken = localStorage.getItem('token') || 'æœªè®¾ç½®'
            const refreshToken = localStorage.getItem('refreshToken') || 'æœªè®¾ç½®'
            
            document.getElementById('access-token').textContent = accessToken.substring(0, 20) + (accessToken.length > 20 ? '...' : '')
            document.getElementById('refresh-token').textContent = refreshToken.substring(0, 20) + (refreshToken.length > 20 ? '...' : '')
        }

        // æ›´æ–°ç¯å¢ƒçŠ¶æ€
        function updateEnvironmentStatus() {
            const config = getEnvironmentConfig()
            const statusElement = document.getElementById('environment-status')
            
            statusElement.innerHTML = `
                <div class="status ${config.useMock ? 'warning' : 'success'}">
                    <span class="status-dot"></span>
                    å½“å‰æ¨¡å¼: ${config.useMock ? 'Mockæ¨¡å¼' : 'åç«¯æ¨¡å¼'}
                </div>
                <div class="status info">
                    <span class="status-dot"></span>
                    APIåœ°å€: ${config.apiBaseUrl}
                </div>
                <div class="status ${config.isDev ? 'success' : 'info'}">
                    <span class="status-dot"></span>
                    ç¯å¢ƒ: ${config.isDev ? 'å¼€å‘ç¯å¢ƒ' : 'ç”Ÿäº§ç¯å¢ƒ'}
                </div>
            `
        }

        // APIè¯·æ±‚å‡½æ•°
        async function apiRequest(url, options = {}) {
            const config = getEnvironmentConfig()
            const token = localStorage.getItem('token')
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            }
            
            const finalOptions = { ...defaultOptions, ...options }
            
            if (config.useMock) {
                log(`ä½¿ç”¨Mockæ•°æ®: ${options.method || 'GET'} ${url}`)
                return getMockResponse(url, options)
            }
            
            try {
                log(`å‘é€è¯·æ±‚: ${options.method || 'GET'} ${config.apiBaseUrl}${url}`)
                const response = await fetch(`${config.apiBaseUrl}${url}`, finalOptions)
                const data = await response.json()
                
                log(`æ”¶åˆ°å“åº”: ${response.status} ${JSON.stringify(data).substring(0, 100)}...`)
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${data.message || 'è¯·æ±‚å¤±è´¥'}`)
                }
                
                return { success: true, data }
            } catch (error) {
                log(`è¯·æ±‚å¤±è´¥: ${error.message}`)
                return { success: false, error: error.message }
            }
        }

        // Mockæ•°æ®
        function getMockResponse(url, options) {
            const mockResponses = {
                '/api/auth/login': {
                    success: true,
                    data: {
                        token: 'mock-jwt-access-token-' + Date.now(),
                        refreshToken: 'mock-jwt-refresh-token-' + Date.now(),
                        tokenType: 'Bearer',
                        expiresIn: 3600,
                        rememberMe: options.body ? JSON.parse(options.body).rememberMe : false,
                        user: {
                            id: 123,
                            username: 'testuser',
                            role: 'USER'
                        }
                    }
                },
                '/api/auth/refresh': {
                    success: true,
                    data: {
                        accessToken: 'mock-refreshed-access-token-' + Date.now(),
                        tokenType: 'Bearer',
                        expiresIn: 3600
                    }
                },
                '/api/auth/check': {
                    success: true,
                    data: {
                        valid: true,
                        aboutToExpire: false,
                        userId: 123,
                        username: 'testuser'
                    }
                }
            }
            
            return mockResponses[url] || { success: false, error: 'Mockæ¥å£æœªå®šä¹‰' }
        }

        // æµ‹è¯•å‡½æ•°
        window.testLogin = async function() {
            const username = document.getElementById('username').value
            const password = document.getElementById('password').value
            const rememberMe = document.getElementById('remember-me').checked
            
            if (!username || !password) {
                showResult('login-result', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', false)
                return
            }
            
            log(`å¼€å§‹ç™»å½•æµ‹è¯•: username=${username}, rememberMe=${rememberMe}`)
            
            const result = await apiRequest('/api/auth/login', {
                method: 'POST',
                body: JSON.stringify({
                    username,
                    password,
                    rememberMe
                })
            })
            
            if (result.success) {
                const { token, refreshToken } = result.data.data
                localStorage.setItem('token', token)
                localStorage.setItem('refreshToken', refreshToken)
                updateTokenStatus()
                showResult('login-result', result.data.data, true)
                log('ç™»å½•æˆåŠŸï¼Œä»¤ç‰Œå·²ä¿å­˜')
            } else {
                showResult('login-result', result.error, false)
                log(`ç™»å½•å¤±è´¥: ${result.error}`)
            }
        }

        window.testLogout = function() {
            localStorage.removeItem('token')
            localStorage.removeItem('refreshToken')
            updateTokenStatus()
            showResult('login-result', 'å·²ç™»å‡ºï¼Œä»¤ç‰Œå·²æ¸…é™¤', true)
            log('ç”¨æˆ·å·²ç™»å‡º')
        }

        window.testCheckToken = async function() {
            log('å¼€å§‹æ£€æŸ¥ä»¤ç‰ŒçŠ¶æ€')
            
            const result = await apiRequest('/api/auth/check', {
                method: 'GET'
            })
            
            if (result.success) {
                document.getElementById('token-status').textContent = 'æœ‰æ•ˆ'
                showResult('token-result', result.data.data, true)
                log(`ä»¤ç‰ŒçŠ¶æ€: ${JSON.stringify(result.data.data)}`)
            } else {
                document.getElementById('token-status').textContent = 'æ— æ•ˆ'
                showResult('token-result', result.error, false)
                log(`ä»¤ç‰Œæ£€æŸ¥å¤±è´¥: ${result.error}`)
            }
        }

        window.testRefreshToken = async function() {
            log('å¼€å§‹åˆ·æ–°ä»¤ç‰Œ')
            
            const refreshToken = localStorage.getItem('refreshToken')
            if (!refreshToken) {
                showResult('token-result', 'æ²¡æœ‰åˆ·æ–°ä»¤ç‰Œï¼Œè¯·å…ˆç™»å½•', false)
                return
            }
            
            const result = await apiRequest('/api/auth/refresh', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${refreshToken}`
                }
            })
            
            if (result.success) {
                const { accessToken } = result.data.data
                localStorage.setItem('token', accessToken)
                updateTokenStatus()
                showResult('token-result', result.data.data, true)
                log('ä»¤ç‰Œåˆ·æ–°æˆåŠŸ')
            } else {
                showResult('token-result', result.error, false)
                log(`ä»¤ç‰Œåˆ·æ–°å¤±è´¥: ${result.error}`)
            }
        }

        window.clearTokens = function() {
            localStorage.removeItem('token')
            localStorage.removeItem('refreshToken')
            updateTokenStatus()
            document.getElementById('token-status').textContent = 'æœªæ£€æŸ¥'
            showResult('token-result', 'æ‰€æœ‰ä»¤ç‰Œå·²æ¸…é™¤', true)
            log('ä»¤ç‰Œå·²æ‰‹åŠ¨æ¸…é™¤')
        }

        window.testAutoRefresh = async function() {
            log('å¼€å§‹è‡ªåŠ¨åˆ·æ–°æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿ401é”™è¯¯ï¼‰')
            
            // æ¨¡æ‹Ÿå‘é€ä¸€ä¸ªéœ€è¦è®¤è¯çš„è¯·æ±‚
            const result = await apiRequest('/api/user/profile', {
                method: 'GET'
            })
            
            if (result.success) {
                showResult('auto-refresh-result', 'è¯·æ±‚æˆåŠŸï¼Œä»¤ç‰Œä»ç„¶æœ‰æ•ˆ', true)
            } else {
                showResult('auto-refresh-result', `è‡ªåŠ¨åˆ·æ–°æµ‹è¯•: ${result.error}`, false)
            }
            
            log('è‡ªåŠ¨åˆ·æ–°æµ‹è¯•å®Œæˆ')
        }

        window.testConcurrentRequests = async function() {
            log('å¼€å§‹å¹¶å‘è¯·æ±‚æµ‹è¯•')
            
            const requests = Array(3).fill().map((_, index) => 
                apiRequest('/api/auth/check', { method: 'GET' })
                    .then(result => ({ index, result }))
            )
            
            try {
                const results = await Promise.all(requests)
                const successCount = results.filter(r => r.result.success).length
                showResult('auto-refresh-result', 
                    `å¹¶å‘æµ‹è¯•å®Œæˆ: ${successCount}/${results.length} æˆåŠŸ`, 
                    successCount === results.length
                )
                log(`å¹¶å‘è¯·æ±‚ç»“æœ: ${successCount}/${results.length} æˆåŠŸ`)
            } catch (error) {
                showResult('auto-refresh-result', `å¹¶å‘æµ‹è¯•å¤±è´¥: ${error.message}`, false)
                log(`å¹¶å‘æµ‹è¯•å¤±è´¥: ${error.message}`)
            }
        }

        window.clearLog = function() {
            document.getElementById('test-log').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n'
        }

        window.exportLog = function() {
            const logContent = document.getElementById('test-log').textContent
            const blob = new Blob([logContent], { type: 'text/plain' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `auth-test-log-${new Date().toISOString().slice(0, 19)}.txt`
            a.click()
            URL.revokeObjectURL(url)
            log('æ—¥å¿—å·²å¯¼å‡º')
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateEnvironmentStatus()
            updateTokenStatus()
            log('è®¤è¯æ¨¡å—æµ‹è¯•é¡µé¢å·²åŠ è½½')
        })
    </script>
</body>
</html>