<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šä½ç²¾åº¦æµ‹è¯• - æ ¡å›­æ´»åŠ¨åº”ç”¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .content {
            padding: 20px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .accuracy-level {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .accuracy-high { background: #4CAF50; color: white; }
        .accuracy-medium { background: #FF9800; color: white; }
        .accuracy-low { background: #f44336; color: white; }

        .location-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }

        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover { background: #1976D2; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .comparison-table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        .improvement { color: #4CAF50; font-weight: bold; }
        .degradation { color: #f44336; font-weight: bold; }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success { background: #e8f5e8; color: #2e7d32; }
        .status-warning { background: #fff3e0; color: #f57c00; }
        .status-error { background: #ffebee; color: #c62828; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .log-container {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .log-item {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-info { color: #2196F3; }
        .log-warn { color: #FF9800; }
        .log-error { color: #f44336; }
        .log-success { color: #4CAF50; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å®šä½ç²¾åº¦æµ‹è¯•</h1>
            <p>æµ‹è¯•å®šä½ç²¾åº¦ä¼˜åŒ–æ•ˆæœï¼ŒéªŒè¯æ”¹è¿›åçš„å®šä½å‡†ç¡®æ€§</p>
        </div>

        <div class="content">
            <!-- ç²¾åº¦æŒ‡æ ‡æ¦‚è§ˆ -->
            <div class="test-section">
                <h3>ğŸ“Š ç²¾åº¦æŒ‡æ ‡æ¦‚è§ˆ</h3>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="currentAccuracy">--</div>
                        <div class="metric-label">å½“å‰ç²¾åº¦(ç±³)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="targetAccuracy">300</div>
                        <div class="metric-label">ç›®æ ‡ç²¾åº¦(ç±³)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="improvementRate">--</div>
                        <div class="metric-label">æ”¹è¿›ç‡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="successRate">--</div>
                        <div class="metric-label">æˆåŠŸç‡</div>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶å®šä½æµ‹è¯• -->
            <div class="test-section">
                <h3>ğŸ“ å®æ—¶å®šä½æµ‹è¯•</h3>
                <button class="btn" onclick="testHighAccuracy()">é«˜ç²¾åº¦å®šä½æµ‹è¯•</button>
                <button class="btn" onclick="testStandardAccuracy()">æ ‡å‡†ç²¾åº¦å®šä½æµ‹è¯•</button>
                <button class="btn" onclick="testMultipleAttempts()">å¤šæ¬¡é‡è¯•æµ‹è¯•</button>
                <button class="btn" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
                
                <div id="currentLocation" class="location-info" style="display: none;">
                    <h4>å½“å‰ä½ç½®ä¿¡æ¯</h4>
                    <p><strong>çº¬åº¦:</strong> <span id="latitude">--</span></p>
                    <p><strong>ç»åº¦:</strong> <span id="longitude">--</span></p>
                    <p><strong>ç²¾åº¦:</strong> <span id="accuracy">--</span>ç±³ 
                       <span id="accuracyLevel" class="accuracy-level"></span></p>
                    <p><strong>è·å–æ—¶é—´:</strong> <span id="timestamp">--</span></p>
                    <p><strong>æ ¡å‡†çŠ¶æ€:</strong> <span id="calibrated">--</span></p>
                    <p><strong>éªŒè¯çŠ¶æ€:</strong> <span id="validated">--</span></p>
                </div>
            </div>

            <!-- æ”¹è¿›å‰åå¯¹æ¯” -->
            <div class="test-section">
                <h3>ğŸ“ˆ æ”¹è¿›å‰åå¯¹æ¯”</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>é…ç½®é¡¹</th>
                            <th>æ”¹è¿›å‰</th>
                            <th>æ”¹è¿›å</th>
                            <th>æ•ˆæœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>æœ€å¤§å…è®¸ç²¾åº¦</td>
                            <td>2000ç±³</td>
                            <td>300ç±³</td>
                            <td class="improvement">âœ“ ç²¾åº¦æå‡85%</td>
                        </tr>
                        <tr>
                            <td>é»˜è®¤ç²¾åº¦è¦æ±‚</td>
                            <td>5000ç±³</td>
                            <td>500ç±³</td>
                            <td class="improvement">âœ“ ç²¾åº¦æå‡90%</td>
                        </tr>
                        <tr>
                            <td>ä½ç½®æ ¡å‡†èŒƒå›´</td>
                            <td>â‰¤100ç±³</td>
                            <td>â‰¤300ç±³</td>
                            <td class="improvement">âœ“ è¦†ç›–èŒƒå›´æ‰©å¤§3å€</td>
                        </tr>
                        <tr>
                            <td>ç¼“å­˜ç²¾åº¦è¦æ±‚</td>
                            <td>â‰¤100ç±³</td>
                            <td>â‰¤300ç±³</td>
                            <td class="improvement">âœ“ ç¼“å­˜åˆ©ç”¨ç‡æå‡</td>
                        </tr>
                        <tr>
                            <td>éªŒè¯ç­–ç•¥</td>
                            <td>å®½æ¾(å…è®¸ä½ç²¾åº¦)</td>
                            <td>ä¸¥æ ¼(æ‹’ç»è¶…ç²¾åº¦)</td>
                            <td class="improvement">âœ“ è´¨é‡æ§åˆ¶åŠ å¼º</td>
                        </tr>
                        <tr>
                            <td>é‡è¯•ç­–ç•¥</td>
                            <td>å›ºå®šé™çº§</td>
                            <td>æ™ºèƒ½åˆ†çº§é™çº§</td>
                            <td class="improvement">âœ“ æˆåŠŸç‡æå‡</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- æµ‹è¯•ç»“æœç»Ÿè®¡ -->
            <div class="test-section">
                <h3>ğŸ“‹ æµ‹è¯•ç»“æœç»Ÿè®¡</h3>
                <div id="testResults">
                    <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
                </div>
                
                <h4>æµ‹è¯•æ—¥å¿—</h4>
                <div class="log-container" id="testLog">
                    <div class="log-item log-info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥å®šä½ç›¸å…³å‡½æ•°
        import { 
            getCurrentLocation, 
            DEFAULT_VALIDATION_CONFIG,
            validateLocation,
            smartLocationCalibration
        } from './src/utils/location.js';

        // æµ‹è¯•ç»Ÿè®¡
        let testStats = {
            total: 0,
            success: 0,
            highAccuracy: 0,
            mediumAccuracy: 0,
            lowAccuracy: 0,
            calibrated: 0,
            avgAccuracy: 0
        };

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('testLog');
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ›´æ–°ä½ç½®æ˜¾ç¤º
        function updateLocationDisplay(location) {
            document.getElementById('currentLocation').style.display = 'block';
            document.getElementById('latitude').textContent = location.latitude?.toFixed(6) || '--';
            document.getElementById('longitude').textContent = location.longitude?.toFixed(6) || '--';
            document.getElementById('accuracy').textContent = location.accuracy?.toFixed(0) || '--';
            document.getElementById('timestamp').textContent = new Date(location.timestamp || Date.now()).toLocaleString();
            
            // ç²¾åº¦ç­‰çº§
            const accuracy = location.accuracy;
            let accuracyLevel = '';
            if (accuracy <= 100) {
                accuracyLevel = '<span class="accuracy-level accuracy-high">é«˜ç²¾åº¦</span>';
            } else if (accuracy <= 300) {
                accuracyLevel = '<span class="accuracy-level accuracy-medium">ä¸­ç­‰ç²¾åº¦</span>';
            } else {
                accuracyLevel = '<span class="accuracy-level accuracy-low">ä½ç²¾åº¦</span>';
            }
            document.getElementById('accuracyLevel').innerHTML = accuracyLevel;
            
            // æ ¡å‡†çŠ¶æ€
            document.getElementById('calibrated').innerHTML = location.calibrated ? 
                '<span class="status status-success">å·²æ ¡å‡†</span>' : 
                '<span class="status status-warning">æœªæ ¡å‡†</span>';
            
            // éªŒè¯çŠ¶æ€
            document.getElementById('validated').innerHTML = location.isValidated !== false ? 
                '<span class="status status-success">éªŒè¯é€šè¿‡</span>' : 
                '<span class="status status-error">éªŒè¯å¤±è´¥</span>';
            
            // æ›´æ–°æŒ‡æ ‡
            document.getElementById('currentAccuracy').textContent = accuracy?.toFixed(0) || '--';
            updateMetrics();
        }

        // æ›´æ–°ç»Ÿè®¡æŒ‡æ ‡
        function updateMetrics() {
            const successRate = testStats.total > 0 ? (testStats.success / testStats.total * 100).toFixed(1) : '--';
            document.getElementById('successRate').textContent = successRate + '%';
            
            if (testStats.avgAccuracy > 0) {
                const improvement = Math.max(0, ((500 - testStats.avgAccuracy) / 500 * 100)).toFixed(1);
                document.getElementById('improvementRate').textContent = improvement + '%';
            }
        }

        // é«˜ç²¾åº¦å®šä½æµ‹è¯•
        window.testHighAccuracy = async function() {
            addLog('å¼€å§‹é«˜ç²¾åº¦å®šä½æµ‹è¯•...', 'info');
            try {
                const location = await getCurrentLocation({
                    enableHighAccuracy: true,
                    timeout: 20000,
                    validationConfig: { maxAccuracy: 100 }
                });
                addLog(`é«˜ç²¾åº¦å®šä½æˆåŠŸ: ${location.accuracy.toFixed(0)}ç±³`, 'success');
                updateLocationDisplay(location);
                updateTestStats(location);
            } catch (error) {
                addLog(`é«˜ç²¾åº¦å®šä½å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æ ‡å‡†ç²¾åº¦å®šä½æµ‹è¯•
        window.testStandardAccuracy = async function() {
            addLog('å¼€å§‹æ ‡å‡†ç²¾åº¦å®šä½æµ‹è¯•...', 'info');
            try {
                const location = await getCurrentLocation({
                    enableHighAccuracy: false,
                    timeout: 15000,
                    validationConfig: { maxAccuracy: 300 }
                });
                addLog(`æ ‡å‡†ç²¾åº¦å®šä½æˆåŠŸ: ${location.accuracy.toFixed(0)}ç±³`, 'success');
                updateLocationDisplay(location);
                updateTestStats(location);
            } catch (error) {
                addLog(`æ ‡å‡†ç²¾åº¦å®šä½å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // å¤šæ¬¡é‡è¯•æµ‹è¯•
        window.testMultipleAttempts = async function() {
            addLog('å¼€å§‹å¤šæ¬¡é‡è¯•æµ‹è¯•...', 'info');
            let successCount = 0;
            let totalAccuracy = 0;
            
            for (let i = 1; i <= 5; i++) {
                addLog(`ç¬¬${i}æ¬¡å°è¯•...`, 'info');
                try {
                    const location = await getCurrentLocation({
                        enableHighAccuracy: i <= 2,
                        timeout: 10000,
                        retryCount: 3,
                        validationConfig: { maxAccuracy: 300 }
                    });
                    successCount++;
                    totalAccuracy += location.accuracy;
                    addLog(`ç¬¬${i}æ¬¡æˆåŠŸ: ${location.accuracy.toFixed(0)}ç±³`, 'success');
                    updateTestStats(location);
                } catch (error) {
                    addLog(`ç¬¬${i}æ¬¡å¤±è´¥: ${error.message}`, 'error');
                }
                
                // ç­‰å¾…1ç§’å†è¿›è¡Œä¸‹ä¸€æ¬¡æµ‹è¯•
                if (i < 5) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            const avgAccuracy = successCount > 0 ? (totalAccuracy / successCount).toFixed(0) : '--';
            addLog(`å¤šæ¬¡æµ‹è¯•å®Œæˆ: æˆåŠŸ${successCount}/5æ¬¡, å¹³å‡ç²¾åº¦${avgAccuracy}ç±³`, 'info');
        };

        // æ›´æ–°æµ‹è¯•ç»Ÿè®¡
        function updateTestStats(location) {
            testStats.total++;
            testStats.success++;
            testStats.avgAccuracy = (testStats.avgAccuracy * (testStats.success - 1) + location.accuracy) / testStats.success;
            
            if (location.accuracy <= 100) {
                testStats.highAccuracy++;
            } else if (location.accuracy <= 300) {
                testStats.mediumAccuracy++;
            } else {
                testStats.lowAccuracy++;
            }
            
            if (location.calibrated) {
                testStats.calibrated++;
            }
            
            updateTestResultsDisplay();
        }

        // æ›´æ–°æµ‹è¯•ç»“æœæ˜¾ç¤º
        function updateTestResultsDisplay() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${testStats.total}</div>
                        <div class="metric-label">æ€»æµ‹è¯•æ¬¡æ•°</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${testStats.success}</div>
                        <div class="metric-label">æˆåŠŸæ¬¡æ•°</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${testStats.highAccuracy}</div>
                        <div class="metric-label">é«˜ç²¾åº¦æ¬¡æ•°(â‰¤100m)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${testStats.mediumAccuracy}</div>
                        <div class="metric-label">ä¸­ç­‰ç²¾åº¦æ¬¡æ•°(â‰¤300m)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${testStats.calibrated}</div>
                        <div class="metric-label">æ ¡å‡†æ¬¡æ•°</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${testStats.avgAccuracy.toFixed(0)}</div>
                        <div class="metric-label">å¹³å‡ç²¾åº¦(ç±³)</div>
                    </div>
                </div>
            `;
        }

        // æ¸…é™¤ç»“æœ
        window.clearResults = function() {
            testStats = {
                total: 0,
                success: 0,
                highAccuracy: 0,
                mediumAccuracy: 0,
                lowAccuracy: 0,
                calibrated: 0,
                avgAccuracy: 0
            };
            
            document.getElementById('currentLocation').style.display = 'none';
            document.getElementById('testResults').innerHTML = '<p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>';
            document.getElementById('testLog').innerHTML = '<div class="log-item log-info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>';
            document.getElementById('currentAccuracy').textContent = '--';
            document.getElementById('improvementRate').textContent = '--';
            document.getElementById('successRate').textContent = '--';
            
            addLog('æµ‹è¯•ç»“æœå·²æ¸…é™¤', 'info');
        };

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        addLog('å®šä½ç²¾åº¦æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
        addLog('æ”¹è¿›å†…å®¹: ç²¾åº¦è¦æ±‚ä»2000ç±³æ”¶ç´§åˆ°300ç±³', 'info');
        addLog('æ”¹è¿›å†…å®¹: æ‰©å¤§ä½ç½®æ ¡å‡†èŒƒå›´åˆ°300ç±³å†…', 'info');
        addLog('æ”¹è¿›å†…å®¹: æ™ºèƒ½åˆ†çº§é‡è¯•ç­–ç•¥', 'info');
    </script>
</body>
</html>