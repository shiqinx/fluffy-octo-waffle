<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šä½é—®é¢˜è¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .diagnostic-item {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .status-icon {
            font-size: 20px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å®šä½é—®é¢˜è¯Šæ–­å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å°†å¸®åŠ©æ‚¨è¯Šæ–­å®šä½åŠŸèƒ½å¤±è´¥çš„å…·ä½“åŸå› ã€‚</p>

        <div id="diagnostics">
            <!-- è¯Šæ–­ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <div style="margin-top: 30px; text-align: center;">
            <button class="btn" onclick="runFullDiagnosis()">ğŸš€ è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button class="btn" onclick="testLocationOnly()">ğŸ“ ä»…æµ‹è¯•å®šä½</button>
            <button class="btn" onclick="showSolutions()">ğŸ’¡ æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ</button>
        </div>

        <div id="solutions" style="margin-top: 30px; display: none;">
            <h2>ğŸ’¡ å¸¸è§è§£å†³æ–¹æ¡ˆ</h2>
            <div id="solutions-content"></div>
        </div>
    </div>

    <script>
        let diagnosticResults = [];

        function addDiagnostic(type, title, details, status = 'info') {
            diagnosticResults.push({ type, title, details, status });
            updateDisplay();
        }

        function updateDisplay() {
            const container = document.getElementById('diagnostics');
            container.innerHTML = diagnosticResults.map(item => `
                <div class="diagnostic-item ${item.status}">
                    <span class="status-icon">${getStatusIcon(item.status)}</span>
                    <strong>${item.title}</strong>
                    <div class="result">${item.details}</div>
                </div>
            `).join('');
        }

        function getStatusIcon(status) {
            const icons = {
                success: 'âœ…',
                warning: 'âš ï¸',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };
            return icons[status] || 'â„¹ï¸';
        }

        async function runFullDiagnosis() {
            diagnosticResults = [];
            addDiagnostic('info', 'å¼€å§‹è¯Šæ–­', 'æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ...', 'info');

            // 1. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            await checkBrowserSupport();
            
            // 2. æ£€æŸ¥å®‰å…¨ç¯å¢ƒ
            checkSecurityEnvironment();
            
            // 3. æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            checkNetworkStatus();
            
            // 4. æ£€æŸ¥æƒé™çŠ¶æ€
            await checkPermissions();
            
            // 5. æµ‹è¯•å®šä½åŠŸèƒ½
            await testLocationFunction();
            
            // 6. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
            generateReport();
        }

        async function checkBrowserSupport() {
            const supported = 'geolocation' in navigator;
            if (supported) {
                addDiagnostic('success', 'æµè§ˆå™¨æ”¯æŒ', 'âœ… æµè§ˆå™¨æ”¯æŒåœ°ç†å®šä½API', 'success');
            } else {
                addDiagnostic('error', 'æµè§ˆå™¨ä¸æ”¯æŒ', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½API\nè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼šChromeã€Firefoxã€Safariã€Edge', 'error');
            }
        }

        function checkSecurityEnvironment() {
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            if (isSecure) {
                addDiagnostic('success', 'å®‰å…¨ç¯å¢ƒ', `âœ… å®‰å…¨ç¯å¢ƒï¼š${location.protocol}`, 'success');
            } else {
                addDiagnostic('warning', 'éå®‰å…¨ç¯å¢ƒ', `âš ï¸ éå®‰å…¨ç¯å¢ƒï¼š${location.protocol}\nç°ä»£æµè§ˆå™¨è¦æ±‚HTTPSæ‰èƒ½ä½¿ç”¨ç²¾ç¡®å®šä½\nå»ºè®®ä½¿ç”¨HTTPSæˆ–localhostè®¿é—®`, 'warning');
            }
        }

        function checkNetworkStatus() {
            const online = navigator.onLine;
            if (online) {
                addDiagnostic('success', 'ç½‘ç»œçŠ¶æ€', 'âœ… ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
            } else {
                addDiagnostic('error', 'ç½‘ç»œçŠ¶æ€', 'âŒ ç½‘ç»œè¿æ¥æ–­å¼€\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }

            // æ£€æŸ¥è¿æ¥ç±»å‹
            if ('connection' in navigator) {
                const connection = navigator.connection;
                addDiagnostic('info', 'ç½‘ç»œè¿æ¥ç±»å‹', `ç±»å‹ï¼š${connection.effectiveType || 'æœªçŸ¥'}\nä¸‹è¡Œé€Ÿåº¦ï¼š${connection.downlink || 'æœªçŸ¥'}Mbps`, 'info');
            }
        }

        async function checkPermissions() {
            if ('permissions' in navigator) {
                try {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    addDiagnostic('info', 'å®šä½æƒé™', `çŠ¶æ€ï¼š${permission.state}`, 
                        permission.state === 'granted' ? 'success' : 
                        permission.state === 'denied' ? 'error' : 'warning');
                } catch (error) {
                    addDiagnostic('warning', 'æƒé™æ£€æŸ¥', 'æ— æ³•æŸ¥è¯¢æƒé™çŠ¶æ€ï¼š' + error.message, 'warning');
                }
            } else {
                addDiagnostic('info', 'æƒé™API', 'æµè§ˆå™¨ä¸æ”¯æŒæƒé™æŸ¥è¯¢API', 'info');
            }
        }

        async function testLocationFunction() {
            addDiagnostic('info', 'å®šä½æµ‹è¯•', 'æ­£åœ¨æµ‹è¯•å®šä½åŠŸèƒ½...', 'info');

            if (!navigator.geolocation) {
                addDiagnostic('error', 'å®šä½æµ‹è¯•', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒå®šä½API', 'error');
                return;
            }

            const startTime = Date.now();

            try {
                const position = await new Promise((resolve, reject) => {
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    };

                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });

                const duration = Date.now() - startTime;
                const { latitude, longitude, accuracy, altitude, heading, speed } = position.coords;

                addDiagnostic('success', 'å®šä½æµ‹è¯•æˆåŠŸ', 
                    `âœ… å®šä½æˆåŠŸï¼\n` +
                    `ğŸ“ åæ ‡ï¼š${latitude.toFixed(6)}, ${longitude.toFixed(6)}\n` +
                    `ğŸ¯ ç²¾åº¦ï¼š${accuracy.toFixed(0)}ç±³\n` +
                    `â±ï¸ è€—æ—¶ï¼š${duration}ms\n` +
                    `ğŸ• æ—¶é—´ï¼š${new Date(position.timestamp).toLocaleString()}\n` +
                    `${altitude ? `ğŸ”ï¸ æµ·æ‹”ï¼š${altitude}ç±³\n` : ''}` +
                    `${heading ? `ğŸ§­ æ–¹å‘ï¼š${heading}Â°\n` : ''}` +
                    `${speed ? `ğŸš€ é€Ÿåº¦ï¼š${speed}m/s\n` : ''}`,
                    'success');

            } catch (error) {
                const duration = Date.now() - startTime;
                let errorDetails = `âŒ å®šä½å¤±è´¥ï¼\nâ±ï¸ è€—æ—¶ï¼š${duration}ms\n`;

                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorDetails += `ğŸš« é”™è¯¯ï¼šç”¨æˆ·æ‹’ç»äº†å®šä½è¯·æ±‚\nè§£å†³æ–¹æ¡ˆï¼šåœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ä½ç½®æƒé™`;
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorDetails += `ğŸ” é”™è¯¯ï¼šä½ç½®ä¿¡æ¯ä¸å¯ç”¨\nè§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥GPSä¿¡å·æˆ–ç§»åŠ¨åˆ°å¼€é˜”åŒºåŸŸ`;
                        break;
                    case error.TIMEOUT:
                        errorDetails += `â° é”™è¯¯ï¼šå®šä½è¯·æ±‚è¶…æ—¶\nè§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå°è¯•é‡è¯•`;
                        break;
                    default:
                        errorDetails += `â“ æœªçŸ¥é”™è¯¯ï¼š${error.message}`;
                        break;
                }

                addDiagnostic('error', 'å®šä½æµ‹è¯•å¤±è´¥', errorDetails, 'error');
            }
        }

        async function testLocationOnly() {
            diagnosticResults = [];
            await testLocationFunction();
        }

        function generateReport() {
            const successCount = diagnosticResults.filter(r => r.status === 'success').length;
            const warningCount = diagnosticResults.filter(r => r.status === 'warning').length;
            const errorCount = diagnosticResults.filter(r => r.status === 'error').length;

            let summary = `ğŸ“Š è¯Šæ–­æŠ¥å‘Š\n`;
            summary += `âœ… é€šè¿‡ï¼š${successCount}é¡¹\n`;
            summary += `âš ï¸ è­¦å‘Šï¼š${warningCount}é¡¹\n`;
            summary += `âŒ é”™è¯¯ï¼š${errorCount}é¡¹\n\n`;

            if (errorCount === 0) {
                summary += `ğŸ‰ æ­å–œï¼æ‚¨çš„å®šä½ç¯å¢ƒé…ç½®æ­£ç¡®ï¼Œå®šä½åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œã€‚`;
            } else if (errorCount <= 2) {
                summary += `ğŸ”§ å‘ç°å°‘é‡é—®é¢˜ï¼Œè¯·æ ¹æ®ä¸Šè¿°æç¤ºè¿›è¡Œä¿®å¤ã€‚`;
            } else {
                summary += `âš ï¸ å‘ç°å¤šä¸ªé—®é¢˜ï¼Œå»ºè®®é€ä¸€è§£å†³åé‡æ–°æµ‹è¯•ã€‚`;
            }

            addDiagnostic('info', 'è¯Šæ–­æ€»ç»“', summary, errorCount === 0 ? 'success' : 'warning');
        }

        function showSolutions() {
            const solutionsDiv = document.getElementById('solutions');
            const contentDiv = document.getElementById('solutions-content');
            
            contentDiv.innerHTML = `
                <div class="diagnostic-item info">
                    <h3>ğŸ”§ æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3>
                    <ul>
                        <li><strong>Chromeï¼š</strong> è®¾ç½® â†’ éšç§å’Œå®‰å…¨ â†’ ç½‘ç«™è®¾ç½® â†’ ä½ç½® â†’ å…è®¸</li>
                        <li><strong>Firefoxï¼š</strong> é€‰é¡¹ â†’ éšç§ä¸å®‰å…¨ â†’ æƒé™ â†’ ä½ç½®è®¾ç½®</li>
                        <li><strong>Safariï¼š</strong> åå¥½è®¾ç½® â†’ ç½‘ç«™ â†’ ä½ç½®</li>
                        <li><strong>Edgeï¼š</strong> è®¾ç½® â†’ éšç§ã€æœç´¢å’ŒæœåŠ¡ â†’ ç½‘ç«™æƒé™ â†’ ä½ç½®</li>
                    </ul>
                </div>

                <div class="diagnostic-item warning">
                    <h3>ğŸŒ ç½‘ç»œé—®é¢˜è§£å†³æ–¹æ¡ˆ</h3>
                    <ul>
                        <li>æ£€æŸ¥WiFiæˆ–ç§»åŠ¨ç½‘ç»œè¿æ¥</li>
                        <li>å°è¯•åˆ‡æ¢ç½‘ç»œç¯å¢ƒ</li>
                        <li>å…³é—­VPNæˆ–ä»£ç†</li>
                        <li>æ£€æŸ¥é˜²ç«å¢™è®¾ç½®</li>
                    </ul>
                </div>

                <div class="diagnostic-item success">
                    <h3>ğŸ“± è®¾å¤‡é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3>
                    <ul>
                        <li>ç§»åŠ¨åˆ°å¼€é˜”åŒºåŸŸè·å–GPSä¿¡å·</li>
                        <li>ç¡®ä¿è®¾å¤‡GPSåŠŸèƒ½å·²å¼€å¯</li>
                        <li>é‡å¯è®¾å¤‡æˆ–æµè§ˆå™¨</li>
                        <li>æ›´æ–°æµè§ˆå™¨åˆ°æœ€æ–°ç‰ˆæœ¬</li>
                    </ul>
                </div>

                <div class="diagnostic-item error">
                    <h3>ğŸ”’ HTTPSé—®é¢˜è§£å†³æ–¹æ¡ˆ</h3>
                    <ul>
                        <li>ä½¿ç”¨localhostè®¿é—®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰</li>
                        <li>é…ç½®SSLè¯ä¹¦ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰</li>
                        <li>ä½¿ç”¨åå‘ä»£ç†å¦‚nginx</li>
                        <li>è€ƒè™‘ä½¿ç”¨äº‘æœåŠ¡æä¾›çš„HTTPS</li>
                    </ul>
                </div>
            `;
            
            solutionsDiv.style.display = 'block';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(runFullDiagnosis, 500);
        });
    </script>
</body>
</html>