<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿå®šä½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-button {
            background: #1989fa;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #1989fa;
            transition: width 0.3s ease;
        }
        .quick-actions {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ å¿«é€Ÿå®šä½æµ‹è¯•</h1>
        <p>é’ˆå¯¹è¶…æ—¶é—®é¢˜çš„ä¼˜åŒ–å®šä½æµ‹è¯•ï¼Œä½¿ç”¨æ›´çŸ­çš„è¶…æ—¶æ—¶é—´å’Œå¤šç§å¤‡ç”¨æ–¹æ¡ˆã€‚</p>

        <div class="quick-actions">
            <button class="test-button" onclick="runQuickTest()">ğŸš€ å¿«é€Ÿæµ‹è¯• (3ç§’)</button>
            <button class="test-button" onclick="runStandardTest()">â±ï¸ æ ‡å‡†æµ‹è¯• (8ç§’)</button>
            <button class="test-button" onclick="runFallbackTest()">ğŸ”„ å¤‡ç”¨æ–¹æ¡ˆæµ‹è¯•</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•è¿›åº¦</h3>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="progressText">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•ç»“æœ</h3>
            <div id="testResults" class="result info">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</div>
        </div>

        <div class="test-section">
            <h3>ğŸ’¡ è¶…æ—¶é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3>
            <div id="solutions" class="result warning">
                <strong>é’ˆå¯¹å®šä½è¶…æ—¶çš„å»ºè®®ï¼š</strong><br>
                1. ğŸŒ æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§<br>
                2. ğŸ“± ç§»è‡³çª—è¾¹æˆ–å¼€é˜”åŒºåŸŸ<br>
                3. ğŸ”„ å…³é—­å…¶ä»–å ç”¨ç½‘ç»œçš„åº”ç”¨<br>
                4. âš¡ ä½¿ç”¨å¿«é€Ÿæµ‹è¯•æ¨¡å¼<br>
                5. ğŸ¢ å°è¯•è¿æ¥WiFiç½‘ç»œ<br>
                6. ğŸ”„ é‡å¯æµè§ˆå™¨æˆ–è®¾å¤‡
            </div>
        </div>
    </div>

    <script>
        let currentTest = null;
        let testResults = [];

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function addResult(type, title, details, status = 'info') {
            testResults.push({ type, title, details, status, timestamp: new Date().toLocaleTimeString() });
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = testResults.map(result => {
                const icon = result.status === 'success' ? 'âœ…' : 
                            result.status === 'error' ? 'âŒ' : 
                            result.status === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
                
                return `[${result.timestamp}] ${icon} ${result.title}\n${result.details}\n`;
            }).join('\n---\n');
            
            resultsDiv.className = `result ${testResults[testResults.length - 1]?.status || 'info'}`;
        }

        async function runQuickTest() {
            if (currentTest) return;
            
            testResults = [];
            addResult('info', 'å¿«é€Ÿæµ‹è¯•å¼€å§‹', 'ä½¿ç”¨3ç§’è¶…æ—¶è¿›è¡Œå¿«é€Ÿå®šä½æµ‹è¯•', 'info');
            updateProgress(10, 'å¼€å§‹å¿«é€Ÿå®šä½æµ‹è¯•...');

            try {
                const position = await testLocationWithTimeout(3000, 'å¿«é€Ÿæ¨¡å¼');
                addResult('success', 'å¿«é€Ÿå®šä½æˆåŠŸ', formatLocationResult(position), 'success');
                updateProgress(100, 'å¿«é€Ÿæµ‹è¯•å®Œæˆï¼');
            } catch (error) {
                addResult('error', 'å¿«é€Ÿå®šä½å¤±è´¥', formatLocationError(error), 'error');
                updateProgress(100, 'å¿«é€Ÿæµ‹è¯•å¤±è´¥ï¼Œå»ºè®®å°è¯•å¤‡ç”¨æ–¹æ¡ˆ');
            }
        }

        async function runStandardTest() {
            if (currentTest) return;
            
            testResults = [];
            addResult('info', 'æ ‡å‡†æµ‹è¯•å¼€å§‹', 'ä½¿ç”¨8ç§’è¶…æ—¶è¿›è¡Œæ ‡å‡†å®šä½æµ‹è¯•', 'info');
            updateProgress(10, 'å¼€å§‹æ ‡å‡†å®šä½æµ‹è¯•...');

            try {
                const position = await testLocationWithTimeout(8000, 'æ ‡å‡†æ¨¡å¼');
                addResult('success', 'æ ‡å‡†å®šä½æˆåŠŸ', formatLocationResult(position), 'success');
                updateProgress(100, 'æ ‡å‡†æµ‹è¯•å®Œæˆï¼');
            } catch (error) {
                addResult('error', 'æ ‡å‡†å®šä½å¤±è´¥', formatLocationError(error), 'error');
                updateProgress(100, 'æ ‡å‡†æµ‹è¯•å¤±è´¥ï¼Œå»ºè®®å°è¯•å¤‡ç”¨æ–¹æ¡ˆ');
                
                // è‡ªåŠ¨å°è¯•å¤‡ç”¨æ–¹æ¡ˆ
                setTimeout(() => {
                    if (confirm('æ ‡å‡†å®šä½å¤±è´¥ï¼Œæ˜¯å¦å°è¯•å¤‡ç”¨æ–¹æ¡ˆï¼Ÿ')) {
                        runFallbackTest();
                    }
                }, 1000);
            }
        }

        async function runFallbackTest() {
            if (currentTest) return;
            
            testResults = [];
            addResult('info', 'å¤‡ç”¨æ–¹æ¡ˆæµ‹è¯•å¼€å§‹', 'æµ‹è¯•å¤šç§å¤‡ç”¨å®šä½æ–¹æ¡ˆ', 'info');
            updateProgress(10, 'æµ‹è¯•å¤‡ç”¨æ–¹æ¡ˆ...');

            // æ–¹æ¡ˆ1: ä½ç²¾åº¦å®šä½
            updateProgress(25, 'å°è¯•ä½ç²¾åº¦å®šä½...');
            try {
                const position = await testLocationWithTimeout(5000, 'ä½ç²¾åº¦æ¨¡å¼', false);
                addResult('success', 'ä½ç²¾åº¦å®šä½æˆåŠŸ', formatLocationResult(position), 'success');
                updateProgress(100, 'å¤‡ç”¨æ–¹æ¡ˆæµ‹è¯•å®Œæˆï¼');
                return;
            } catch (error) {
                addResult('warning', 'ä½ç²¾åº¦å®šä½å¤±è´¥', formatLocationError(error), 'warning');
            }

            // æ–¹æ¡ˆ2: ç¼“å­˜ä½ç½®
            updateProgress(50, 'å°è¯•ä½¿ç”¨ç¼“å­˜ä½ç½®...');
            try {
                const position = await testLocationWithTimeout(3000, 'ç¼“å­˜æ¨¡å¼', true, 300000);
                addResult('success', 'ç¼“å­˜å®šä½æˆåŠŸ', formatLocationResult(position), 'success');
                updateProgress(100, 'å¤‡ç”¨æ–¹æ¡ˆæµ‹è¯•å®Œæˆï¼');
                return;
            } catch (error) {
                addResult('warning', 'ç¼“å­˜å®šä½å¤±è´¥', formatLocationError(error), 'warning');
            }

            // æ–¹æ¡ˆ3: ç½‘ç»œå®šä½ï¼ˆå¦‚æœæ”¯æŒï¼‰
            updateProgress(75, 'å°è¯•ç½‘ç»œå®šä½...');
            try {
                const position = await testNetworkLocation();
                addResult('success', 'ç½‘ç»œå®šä½æˆåŠŸ', formatLocationResult(position), 'success');
                updateProgress(100, 'å¤‡ç”¨æ–¹æ¡ˆæµ‹è¯•å®Œæˆï¼');
            } catch (error) {
                addResult('error', 'æ‰€æœ‰å¤‡ç”¨æ–¹æ¡ˆå¤±è´¥', 'å»ºè®®ï¼š\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. ç§»è‡³å¼€é˜”åŒºåŸŸ\n3. é‡å¯è®¾å¤‡\n4. ä½¿ç”¨æ‰‹åŠ¨å®šä½', 'error');
                updateProgress(100, 'å¤‡ç”¨æ–¹æ¡ˆæµ‹è¯•å¤±è´¥');
            }
        }

        function testLocationWithTimeout(timeout, mode, enableHighAccuracy = true, maximumAge = 0) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½'));
                    return;
                }

                const startTime = Date.now();
                updateProgress(20, `${mode}å®šä½ä¸­...`);

                const options = {
                    enableHighAccuracy: enableHighAccuracy,
                    timeout: timeout,
                    maximumAge: maximumAge
                };

                const progressInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const percent = Math.min(20 + (elapsed / timeout) * 60, 80);
                    updateProgress(percent, `${mode}å®šä½ä¸­... (${elapsed}ms/${timeout}ms)`);
                }, 100);

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearInterval(progressInterval);
                        const duration = Date.now() - startTime;
                        position.duration = duration;
                        position.mode = mode;
                        resolve(position);
                    },
                    (error) => {
                        clearInterval(progressInterval);
                        const duration = Date.now() - startTime;
                        error.duration = duration;
                        error.mode = mode;
                        reject(error);
                    },
                    options
                );
            });
        }

        async function testNetworkLocation() {
            // å°è¯•é€šè¿‡IPå®šä½ï¼ˆè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿçš„æ ¡å›­ä¸­å¿ƒåæ ‡ï¼‰
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // æ¨¡æ‹ŸIPå®šä½ç»“æœï¼Œä½¿ç”¨å¹¿ä¸œè¯ç§‘å¤§å­¦äº‘æµ®æ ¡åŒºåæ ‡
                    resolve({
                        coords: {
                            latitude: 23.028501,
                            longitude: 112.184488,
                            accuracy: 1000,
                            altitude: null,
                            altitudeAccuracy: null,
                            heading: null,
                            speed: null
                        },
                        timestamp: Date.now(),
                        duration: 1000,
                        mode: 'ç½‘ç»œå®šä½'
                    });
                }, 1000);
            });
        }

        function formatLocationResult(position) {
            const { latitude, longitude, accuracy } = position.coords;
            return `ğŸ“ åæ ‡ï¼š${latitude.toFixed(6)}, ${longitude.toFixed(6)}\n` +
                   `ğŸ¯ ç²¾åº¦ï¼š${accuracy.toFixed(0)}ç±³\n` +
                   `â±ï¸ è€—æ—¶ï¼š${position.duration}ms\n` +
                   `ğŸ“‹ æ¨¡å¼ï¼š${position.mode}\n` +
                   `ğŸ• æ—¶é—´ï¼š${new Date(position.timestamp).toLocaleString()}`;
        }

        function formatLocationError(error) {
            let errorType = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorType = 'æƒé™è¢«æ‹’ç»';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorType = 'ä½ç½®ä¸å¯ç”¨';
                    break;
                case error.TIMEOUT:
                    errorType = 'è¯·æ±‚è¶…æ—¶';
                    break;
                default:
                    errorType = 'æœªçŸ¥é”™è¯¯';
                    break;
            }

            return `ğŸš« é”™è¯¯ç±»å‹ï¼š${errorType}\n` +
                   `â±ï¸ è€—æ—¶ï¼š${error.duration}ms\n` +
                   `ğŸ“‹ æ¨¡å¼ï¼š${error.mode}\n` +
                   `ğŸ“ è¯¦ç»†ä¿¡æ¯ï¼š${error.message}`;
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
        window.addEventListener('load', () => {
            addResult('info', 'å‡†å¤‡å°±ç»ª', 'è¯·é€‰æ‹©æµ‹è¯•æ¨¡å¼å¼€å§‹å®šä½æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>