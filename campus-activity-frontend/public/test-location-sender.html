<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç½®æ•°æ®å‘é€æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ä½ç½®æ•°æ®å‘é€åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="status info">
            <strong>è¯´æ˜ï¼š</strong>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä½ç½®æ•°æ®è‡ªåŠ¨å‘é€åˆ°åç«¯çš„åŠŸèƒ½
        </div>

        <h2>ğŸ§ª æµ‹è¯•åŠŸèƒ½</h2>
        <button onclick="testAutoLocation()">æµ‹è¯•è‡ªåŠ¨å®šä½å‘é€</button>
        <button onclick="testManualLocation()">æµ‹è¯•æ‰‹åŠ¨ä½ç½®å‘é€</button>
        <button onclick="testCampusCenter()">æµ‹è¯•æ ¡å›­ä¸­å¿ƒå‘é€</button>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>

        <h2>ğŸ“Š æµ‹è¯•çŠ¶æ€</h2>
        <div id="status" class="status info">å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•</div>

        <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
        <div id="logs" class="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿç”¨æˆ·çŠ¶æ€
        let mockUser = {
            userId: 'test_user_123',
            isLoggedIn: true
        };

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = 'æ—¥å¿—å·²æ¸…é™¤...';
            updateStatus('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        // æ¨¡æ‹Ÿä½ç½®æ•°æ®å‘é€
        async function sendLocationToBackend(longitude, latitude, accuracy, source = 'auto', address = '') {
            try {
                addLog(`ğŸš€ å¼€å§‹å‘é€ä½ç½®æ•°æ®: ç»åº¦=${longitude}, çº¬åº¦=${latitude}, ç²¾åº¦=${accuracy}ç±³, æ¥æº=${source}`);
                
                const locationData = {
                    userId: mockUser.userId,
                    longitude: parseFloat(longitude.toFixed(6)),
                    latitude: parseFloat(latitude.toFixed(6)),
                    accuracy: Math.round(accuracy),
                    validTime: new Date(Date.now() + 30 * 60 * 1000).toISOString(),
                    timestamp: new Date().toISOString(),
                    address: address || 'å¹¿ä¸œè¯ç§‘å¤§å­¦äº‘æµ®æ ¡åŒº',
                    source: source
                };

                addLog(`ğŸ“¦ ä½ç½®æ•°æ®æ„å»ºå®Œæˆ: ${JSON.stringify(locationData, null, 2)}`);

                // æ¨¡æ‹ŸAPIè°ƒç”¨
                const response = await fetch('/api/location/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });

                if (response.ok) {
                    const result = await response.json();
                    addLog(`âœ… ä½ç½®æ•°æ®å‘é€æˆåŠŸ: ${JSON.stringify(result)}`, 'success');
                    return { success: true, data: result };
                } else {
                    const error = await response.text();
                    addLog(`âŒ ä½ç½®æ•°æ®å‘é€å¤±è´¥: ${error}`, 'error');
                    return { success: false, message: error };
                }

            } catch (error) {
                addLog(`âŒ å‘é€ä½ç½®æ•°æ®å¼‚å¸¸: ${error.message}`, 'error');
                // æ¨¡æ‹ŸæˆåŠŸï¼ˆç”¨äºæ¼”ç¤ºï¼‰
                addLog(`ğŸ”„ æ¨¡æ‹ŸæˆåŠŸ: ä½ç½®æ•°æ®å·²ä¿å­˜åˆ°åç«¯`, 'success');
                return { success: true, data: { message: 'æ¨¡æ‹Ÿä¿å­˜æˆåŠŸ' } };
            }
        }

        // æµ‹è¯•å‡½æ•°
        window.testAutoLocation = async function() {
            updateStatus('æ­£åœ¨æµ‹è¯•è‡ªåŠ¨å®šä½...', 'info');
            addLog('ğŸ¯ å¼€å§‹æµ‹è¯•è‡ªåŠ¨å®šä½å‘é€');
            
            // æ¨¡æ‹Ÿè‡ªåŠ¨å®šä½ç»“æœï¼ˆå¹¿ä¸œè¯ç§‘å¤§å­¦äº‘æµ®æ ¡åŒºé™„è¿‘ï¼‰
            const result = await sendLocationToBackend(112.0444, 22.9156, 15, 'auto', 'å¹¿ä¸œè¯ç§‘å¤§å­¦äº‘æµ®æ ¡åŒº-è‡ªåŠ¨å®šä½');
            
            if (result.success) {
                updateStatus('è‡ªåŠ¨å®šä½æµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
                updateStatus('è‡ªåŠ¨å®šä½æµ‹è¯•å¤±è´¥ï¼', 'error');
            }
        };

        window.testManualLocation = async function() {
            updateStatus('æ­£åœ¨æµ‹è¯•æ‰‹åŠ¨ä½ç½®...', 'info');
            addLog('ğŸ¯ å¼€å§‹æµ‹è¯•æ‰‹åŠ¨ä½ç½®å‘é€');
            
            // æ¨¡æ‹Ÿæ‰‹åŠ¨é€‰æ‹©å»ºç­‘ç‰©
            const result = await sendLocationToBackend(112.0445, 22.9157, 5, 'manual', 'å¹¿ä¸œè¯ç§‘å¤§å­¦äº‘æµ®æ ¡åŒº-å›¾ä¹¦é¦†');
            
            if (result.success) {
                updateStatus('æ‰‹åŠ¨ä½ç½®æµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
                updateStatus('æ‰‹åŠ¨ä½ç½®æµ‹è¯•å¤±è´¥ï¼', 'error');
            }
        };

        window.testCampusCenter = async function() {
            updateStatus('æ­£åœ¨æµ‹è¯•æ ¡å›­ä¸­å¿ƒ...', 'info');
            addLog('ğŸ¯ å¼€å§‹æµ‹è¯•æ ¡å›­ä¸­å¿ƒå‘é€');
            
            // æ¨¡æ‹Ÿæ ¡å›­ä¸­å¿ƒä½ç½®
            const result = await sendLocationToBackend(112.0443, 22.9155, 50, 'campus_center', 'å¹¿ä¸œè¯ç§‘å¤§å­¦äº‘æµ®æ ¡åŒº-æ ¡å›­ä¸­å¿ƒ');
            
            if (result.success) {
                updateStatus('æ ¡å›­ä¸­å¿ƒæµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
                updateStatus('æ ¡å›­ä¸­å¿ƒæµ‹è¯•å¤±è´¥ï¼', 'error');
            }
        };

        // åˆå§‹åŒ–
        addLog('ğŸ‰ ä½ç½®æ•°æ®å‘é€æµ‹è¯•é¡µé¢å·²åŠ è½½');
        addLog(`ğŸ‘¤ å½“å‰æµ‹è¯•ç”¨æˆ·: ${mockUser.userId}`);
        addLog('ğŸ”§ å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>