<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šä½ç®—æ³•ä¼˜åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .test-section {
            margin: 20px 0;
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .reference-points {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        
        .point-card {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
        }
        
        .point-card.library { border-color: #28a745; background: #f8fff9; }
        .point-card.dormitory { border-color: #ffc107; background: #fffbf0; }
        .point-card.academic { border-color: #17a2b8; background: #f0fcff; }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        
        .metric {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px;
        }
        
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 4px 0;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .log-entry.info { background: #e3f2fd; }
        .log-entry.success { background: #e8f5e8; }
        .log-entry.warning { background: #fff3e0; }
        .log-entry.error { background: #ffebee; }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }
        
        .algorithm-result {
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .algorithm-result.old { background: #fff5f5; border-color: #fed7d7; }
        .algorithm-result.new { background: #f0fff4; border-color: #c6f6d5; }
        
        .confidence-high { color: #28a745; font-weight: bold; }
        .confidence-medium { color: #ffc107; font-weight: bold; }
        .confidence-low { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ å®šä½ç®—æ³•ä¼˜åŒ–æµ‹è¯•</h1>
        <p>æµ‹è¯•æ–°çš„æ™ºèƒ½æƒé‡å®šä½ç®—æ³•ï¼Œè§£å†³å›¾ä¹¦é¦†è¢«è¯¯è¯†åˆ«ä¸ºå®¿èˆçš„é—®é¢˜</p>
        
        <div id="status" class="status info">
            å‡†å¤‡å¼€å§‹æµ‹è¯•...
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="startLocationTest()">ğŸ“ å¼€å§‹å®šä½æµ‹è¯•</button>
            <button onclick="simulateLibraryLocation()">ğŸ“š æ¨¡æ‹Ÿå›¾ä¹¦é¦†ä½ç½®</button>
            <button onclick="simulateDormitoryLocation()">ğŸ  æ¨¡æ‹Ÿå®¿èˆä½ç½®</button>
            <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æ ¡å›­å‚è€ƒç‚¹é…ç½®</h2>
        <div class="reference-points" id="referencePoints">
            <!-- åŠ¨æ€ç”Ÿæˆå‚è€ƒç‚¹å¡ç‰‡ -->
        </div>
    </div>

    <div class="container">
        <h2>ğŸ” å®šä½ç»“æœå¯¹æ¯”</h2>
        <div class="comparison">
            <div class="algorithm-result old">
                <h3>âŒ æ—§ç®—æ³•ç»“æœ</h3>
                <div id="oldAlgorithmResult">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            <div class="algorithm-result new">
                <h3>âœ… æ–°ç®—æ³•ç»“æœ</h3>
                <div id="newAlgorithmResult">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“ˆ å®šä½æŒ‡æ ‡</h2>
        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="accuracyValue">--</div>
                <div class="metric-label">ç²¾åº¦(ç±³)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="confidenceValue">--</div>
                <div class="metric-label">ç½®ä¿¡åº¦</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="distanceValue">--</div>
                <div class="metric-label">æœ€è¿‘è·ç¦»(ç±³)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="weightScoreValue">--</div>
                <div class="metric-label">æƒé‡å¾—åˆ†</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <div class="log-container" id="logContainer">
            <div class="log-entry info">ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ ¡å›­å‚è€ƒç‚¹æ•°æ®ï¼ˆä¸location.jsä¿æŒä¸€è‡´ï¼‰
        const CAMPUS_REFERENCE_POINTS = [
            {
                name: 'å›¾ä¹¦é¦†',
                coords: [23.0419, 113.4016],
                radius: 150,
                priority: 1,
                weight: 1.0,
                buildingType: 'library'
            },
            {
                name: '4æ ‹å®¿èˆ',
                coords: [23.0415, 113.4020],
                radius: 100,
                priority: 2,
                weight: 0.4,
                buildingType: 'dormitory'
            },
            {
                name: '3æ ‹å®¿èˆ',
                coords: [23.0413, 113.4022],
                radius: 100,
                priority: 2,
                weight: 0.4,
                buildingType: 'dormitory'
            },
            {
                name: 'æ•™å­¦æ¥¼Aæ ‹',
                coords: [23.0421, 113.4012],
                radius: 120,
                priority: 3,
                weight: 0.7,
                buildingType: 'academic'
            },
            {
                name: 'ä½“è‚²é¦†',
                coords: [23.0417, 113.4010],
                radius: 150,
                priority: 2,
                weight: 0.5,
                buildingType: 'sports'
            },
            {
                name: 'é£Ÿå ‚',
                coords: [23.0423, 113.4018],
                radius: 120,
                priority: 3,
                weight: 0.4,
                buildingType: 'dining'
            }
        ];

        // è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»ï¼ˆHaversineå…¬å¼ï¼‰
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // æ—§ç®—æ³•ï¼ˆç®€å•è·ç¦»ä¼˜å…ˆï¼‰
        function oldAlgorithm(rawLocation) {
            const distances = CAMPUS_REFERENCE_POINTS.map(point => {
                const distance = calculateDistance(
                    rawLocation.latitude,
                    rawLocation.longitude,
                    point.coords[0],
                    point.coords[1]
                );
                return { ...point, distance, isInRange: distance <= point.radius };
            });

            const inRangePoints = distances.filter(d => d.isInRange);
            if (inRangePoints.length > 0) {
                inRangePoints.sort((a, b) => {
                    if (a.priority !== b.priority) return a.priority - b.priority;
                    return a.distance - b.distance;
                });
                return inRangePoints[0];
            }
            return null;
        }

        // æ–°ç®—æ³•ï¼ˆæ™ºèƒ½æƒé‡ï¼‰
        function newAlgorithm(rawLocation) {
            const distances = CAMPUS_REFERENCE_POINTS.map(point => {
                const distance = calculateDistance(
                    rawLocation.latitude,
                    rawLocation.longitude,
                    point.coords[0],
                    point.coords[1]
                );
                const distanceScore = Math.max(0, 1 - distance / point.radius);
                const weightedScore = distanceScore * point.weight;
                return {
                    ...point,
                    distance,
                    isInRange: distance <= point.radius,
                    distanceScore,
                    weightedScore
                };
            });

            const inRangePoints = distances.filter(d => d.isInRange && d.weightedScore > 0.3);
            if (inRangePoints.length > 0) {
                inRangePoints.sort((a, b) => {
                    if (Math.abs(a.weightedScore - b.weightedScore) > 0.1) {
                        return b.weightedScore - a.weightedScore;
                    }
                    if (a.priority !== b.priority) return a.priority - b.priority;
                    return a.distance - b.distance;
                });

                const bestPoint = inRangePoints[0];
                const secondBest = inRangePoints[1];
                
                if (bestPoint.weightedScore > 0.6 && 
                    (!secondBest || bestPoint.weightedScore - secondBest.weightedScore > 0.2)) {
                    return { ...bestPoint, confidence: 'high' };
                } else if (bestPoint.distance <= 80) {
                    return { ...bestPoint, confidence: 'medium' };
                }
            }
            return null;
        }

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // æ›´æ–°æŒ‡æ ‡
        function updateMetrics(result) {
            document.getElementById('accuracyValue').textContent = result.accuracy ? result.accuracy.toFixed(0) : '--';
            document.getElementById('confidenceValue').textContent = result.confidence || '--';
            document.getElementById('distanceValue').textContent = result.distance ? result.distance.toFixed(0) : '--';
            document.getElementById('weightScoreValue').textContent = result.weightedScore ? result.weightedScore.toFixed(2) : '--';
        }

        // æ˜¾ç¤ºç®—æ³•ç»“æœ
        function showAlgorithmResult(elementId, result, algorithmName) {
            const element = document.getElementById(elementId);
            if (!result) {
                element.innerHTML = '<p style="color: #666;">æœªæ‰¾åˆ°åˆé€‚çš„æ ¡å‡†ç‚¹</p>';
                return;
            }

            const confidenceClass = result.confidence === 'high' ? 'confidence-high' : 
                                  result.confidence === 'medium' ? 'confidence-medium' : 'confidence-low';

            element.innerHTML = `
                <p><strong>è¯†åˆ«å»ºç­‘ï¼š</strong>${result.name}</p>
                <p><strong>å»ºç­‘ç±»å‹ï¼š</strong>${result.buildingType}</p>
                <p><strong>è·ç¦»ï¼š</strong>${result.distance.toFixed(1)}ç±³</p>
                <p><strong>æƒé‡å¾—åˆ†ï¼š</strong>${result.weightedScore ? result.weightedScore.toFixed(2) : '--'}</p>
                <p><strong>ç½®ä¿¡åº¦ï¼š</strong><span class="${confidenceClass}">${result.confidence || 'ä½'}</span></p>
                <p><strong>ä¼˜å…ˆçº§ï¼š</strong>${result.priority}</p>
            `;
        }

        // åˆå§‹åŒ–å‚è€ƒç‚¹æ˜¾ç¤º
        function initReferencePoints() {
            const container = document.getElementById('referencePoints');
            CAMPUS_REFERENCE_POINTS.forEach(point => {
                const card = document.createElement('div');
                card.className = `point-card ${point.buildingType}`;
                card.innerHTML = `
                    <h4>${point.name}</h4>
                    <p><strong>åæ ‡ï¼š</strong>${point.coords[0]}, ${point.coords[1]}</p>
                    <p><strong>åŠå¾„ï¼š</strong>${point.radius}ç±³</p>
                    <p><strong>æƒé‡ï¼š</strong>${point.weight}</p>
                    <p><strong>ä¼˜å…ˆçº§ï¼š</strong>${point.priority}</p>
                `;
                container.appendChild(card);
            });
        }

        // æµ‹è¯•å®šä½
        function testLocation(rawLocation) {
            addLog(`å¼€å§‹æµ‹è¯•ä½ç½®: ${rawLocation.latitude.toFixed(4)}, ${rawLocation.longitude.toFixed(4)}`, 'info');
            
            const oldResult = oldAlgorithm(rawLocation);
            const newResult = newAlgorithm(rawLocation);
            
            addLog(`æ—§ç®—æ³•ç»“æœ: ${oldResult ? oldResult.name : 'æ— åŒ¹é…'}`, oldResult ? 'warning' : 'error');
            addLog(`æ–°ç®—æ³•ç»“æœ: ${newResult ? newResult.name : 'æ— åŒ¹é…'}`, newResult ? 'success' : 'error');
            
            if (newResult) {
                addLog(`æ–°ç®—æ³•è¯¦æƒ… - æƒé‡å¾—åˆ†: ${newResult.weightedScore?.toFixed(2)}, ç½®ä¿¡åº¦: ${newResult.confidence}`, 'info');
                updateMetrics(newResult);
            }
            
            showAlgorithmResult('oldAlgorithmResult', oldResult, 'æ—§ç®—æ³•');
            showAlgorithmResult('newAlgorithmResult', newResult, 'æ–°ç®—æ³•');
            
            // æ£€æŸ¥æ˜¯å¦è§£å†³äº†é—®é¢˜
            if (rawLocation.latitude === 23.0419 && rawLocation.longitude === 113.4016) {
                // è¿™æ˜¯å›¾ä¹¦é¦†ä½ç½®
                if (newResult && newResult.name === 'å›¾ä¹¦é¦†') {
                    updateStatus('âœ… æˆåŠŸï¼æ–°ç®—æ³•æ­£ç¡®è¯†åˆ«å›¾ä¹¦é¦†ä½ç½®', 'success');
                    addLog('é—®é¢˜è§£å†³ï¼šå›¾ä¹¦é¦†ä½ç½®è¢«æ­£ç¡®è¯†åˆ«', 'success');
                } else {
                    updateStatus('âŒ é—®é¢˜æœªè§£å†³ï¼Œå›¾ä¹¦é¦†ä»è¢«è¯¯è¯†åˆ«', 'error');
                    addLog('é—®é¢˜æœªè§£å†³ï¼šå›¾ä¹¦é¦†ä½ç½®è¯†åˆ«é”™è¯¯', 'error');
                }
            }
        }

        // å¼€å§‹å®šä½æµ‹è¯•
        function startLocationTest() {
            updateStatus('æ­£åœ¨è·å–çœŸå®ä½ç½®...', 'info');
            addLog('è¯·æ±‚æµè§ˆå™¨å®šä½æƒé™', 'info');
            
            if (!navigator.geolocation) {
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒå®šä½', 'error');
                addLog('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½API', 'error');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const rawLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    updateStatus('å®šä½æˆåŠŸï¼Œå¼€å§‹ç®—æ³•å¯¹æ¯”æµ‹è¯•', 'success');
                    addLog(`è·å–åˆ°çœŸå®ä½ç½®ï¼Œç²¾åº¦: ${position.coords.accuracy.toFixed(0)}ç±³`, 'success');
                    testLocation(rawLocation);
                },
                (error) => {
                    updateStatus('å®šä½å¤±è´¥ï¼Œè¯·ä½¿ç”¨æ¨¡æ‹Ÿä½ç½®æµ‹è¯•', 'error');
                    addLog(`å®šä½å¤±è´¥: ${error.message}`, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        // æ¨¡æ‹Ÿå›¾ä¹¦é¦†ä½ç½®
        function simulateLibraryLocation() {
            updateStatus('æ¨¡æ‹Ÿå›¾ä¹¦é¦†ä½ç½®æµ‹è¯•', 'info');
            const libraryLocation = {
                latitude: 23.0419,
                longitude: 113.4016,
                accuracy: 50
            };
            testLocation(libraryLocation);
        }

        // æ¨¡æ‹Ÿå®¿èˆä½ç½®
        function simulateDormitoryLocation() {
            updateStatus('æ¨¡æ‹Ÿå®¿èˆä½ç½®æµ‹è¯•', 'info');
            const dormitoryLocation = {
                latitude: 23.0415,
                longitude: 113.4020,
                accuracy: 50
            };
            testLocation(dormitoryLocation);
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry info">æ—¥å¿—å·²æ¸…é™¤</div>';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initReferencePoints();
            addLog('å®šä½ç®—æ³•ä¼˜åŒ–æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            addLog('å‚è€ƒç‚¹é…ç½®å·²åˆå§‹åŒ–', 'info');
        });
    </script>
</body>
</html>