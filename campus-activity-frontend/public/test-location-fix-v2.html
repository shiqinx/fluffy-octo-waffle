<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šä½ä¿®å¤æµ‹è¯• - æ ¡å›­å®šä½ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 30px;
        }
        
        .status-card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4f46e5;
        }
        
        .status-card h3 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .location-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .info-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
            word-break: break-all;
        }
        
        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .campus-map {
            background: #f1f5f9;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .reference-points {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .point-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .point-item.library {
            border-color: #4f46e5;
            background: #eef2ff;
        }
        
        .point-item.dormitory {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .accuracy-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .accuracy-excellent {
            background: #dcfce7;
            color: #166534;
        }
        
        .accuracy-good {
            background: #fef3c7;
            color: #92400e;
        }
        
        .accuracy-poor {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.info {
            color: #60a5fa;
        }
        
        .log-entry.success {
            color: #34d399;
        }
        
        .log-entry.warning {
            color: #fbbf24;
        }
        
        .log-entry.error {
            color: #f87171;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .comparison-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #1e293b;
        }
        
        .improvement {
            color: #059669;
            font-weight: 600;
        }
        
        .degradation {
            color: #dc2626;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å®šä½ä¿®å¤æµ‹è¯•</h1>
            <p>éªŒè¯æ ¡å›­å®šä½ç³»ç»Ÿçš„åæ ‡ä¿®å¤å’Œç²¾åº¦æ”¹è¿›æ•ˆæœ</p>
        </div>
        
        <div class="content">
            <div class="status-card">
                <h3>ğŸ“ å½“å‰å®šä½çŠ¶æ€</h3>
                <div id="currentStatus">
                    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å®šä½æµ‹è¯•...</p>
                </div>
            </div>
            
            <button class="btn" onclick="testCurrentLocation()">
                <span id="testBtn">ğŸ§ª æµ‹è¯•å½“å‰å®šä½</span>
            </button>
            
            <button class="btn btn-secondary" onclick="testCalibration()">
                ğŸ¯ æµ‹è¯•ä½ç½®æ ¡å‡†åŠŸèƒ½
            </button>
            
            <button class="btn btn-warning" onclick="clearCache()">
                ğŸ—‘ï¸ æ¸…é™¤å®šä½ç¼“å­˜
            </button>
            
            <div class="status-card">
                <h3>ğŸ“Š å®šä½ä¿¡æ¯è¯¦æƒ…</h3>
                <div class="location-info" id="locationInfo">
                    <div class="info-item">
                        <div class="info-label">çº¬åº¦</div>
                        <div class="info-value" id="latitude">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ç»åº¦</div>
                        <div class="info-value" id="longitude">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ç²¾åº¦</div>
                        <div class="info-value" id="accuracy">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ ¡å‡†çŠ¶æ€</div>
                        <div class="info-value" id="calibrated">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æœ€è¿‘å»ºç­‘</div>
                        <div class="info-value" id="nearestBuilding">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è·ç¦»</div>
                        <div class="info-value" id="distance">--</div>
                    </div>
                </div>
            </div>
            
            <div class="campus-map">
                <h3>ğŸ« æ ¡å›­å‚è€ƒç‚¹</h3>
                <div class="reference-points">
                    <div class="point-item library">
                        <strong>ğŸ“š å›¾ä¹¦é¦†</strong><br>
                        [23.0419, 113.4016]<br>
                        åŠå¾„: 150m
                    </div>
                    <div class="point-item dormitory">
                        <strong>ğŸ  4æ ‹å®¿èˆ</strong><br>
                        [23.0415, 113.4020]<br>
                        åŠå¾„: 100m
                    </div>
                    <div class="point-item">
                        <strong>ğŸ« æ•™å­¦æ¥¼Aæ ‹</strong><br>
                        [23.0422, 113.4012]<br>
                        åŠå¾„: 120m
                    </div>
                    <div class="point-item">
                        <strong>ğŸƒ ä½“è‚²é¦†</strong><br>
                        [23.0410, 113.4018]<br>
                        åŠå¾„: 150m
                    </div>
                    <div class="point-item">
                        <strong>ğŸ½ï¸ é£Ÿå ‚</strong><br>
                        [23.0425, 113.4010]<br>
                        åŠå¾„: 120m
                    </div>
                </div>
            </div>
            
            <div class="status-card">
                <h3>ğŸ“ˆ ä¿®å¤å‰åå¯¹æ¯”</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®</th>
                            <th>ä¿®å¤å‰</th>
                            <th>ä¿®å¤å</th>
                            <th>æ”¹è¿›</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>é»˜è®¤ä½ç½®</td>
                            <td>[23.0292, 112.1849]</td>
                            <td>[23.0419, 113.4016]</td>
                            <td class="improvement">âœ… æ­£ç¡®æ ¡å›­åæ ‡</td>
                        </tr>
                        <tr>
                            <td>å›¾ä¹¦é¦†åæ ‡</td>
                            <td>[23.0292, 112.1849]</td>
                            <td>[23.0419, 113.4016]</td>
                            <td class="improvement">âœ… å¹¿å·å¤§å­¦åŸ</td>
                        </tr>
                        <tr>
                            <td>æ ¡å‡†èŒƒå›´</td>
                            <td>50ç±³</td>
                            <td>100ç±³</td>
                            <td class="improvement">âœ… è¦†ç›–æ›´å¹¿</td>
                        </tr>
                        <tr>
                            <td>å‚è€ƒç‚¹æ•°é‡</td>
                            <td>3ä¸ª</td>
                            <td>5ä¸ª</td>
                            <td class="improvement">âœ… æ›´ç²¾ç¡®</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="log-container" id="logContainer">
                <div class="log-entry info">ğŸ“‹ å®šä½æµ‹è¯•æ—¥å¿—å·²å‡†å¤‡å°±ç»ª...</div>
            </div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥å®šä½å·¥å…·å‡½æ•°
        import { 
            getCurrentLocation, 
            smartLocationCalibration,
            calculateDistance,
            DEFAULT_LOCATION,
            formatUserFriendlyError
        } from '../src/utils/location.js';
        
        let testResults = [];
        
        // æ—¥å¿—è®°å½•å‡½æ•°
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ›´æ–°å®šä½ä¿¡æ¯æ˜¾ç¤º
        function updateLocationDisplay(locationData) {
            document.getElementById('latitude').textContent = locationData.latitude?.toFixed(6) || '--';
            document.getElementById('longitude').textContent = locationData.longitude?.toFixed(6) || '--';
            document.getElementById('accuracy').textContent = locationData.accuracy ? `${locationData.accuracy.toFixed(0)}m` : '--';
            
            const calibratedEl = document.getElementById('calibrated');
            if (locationData.calibrated) {
                calibratedEl.innerHTML = '<span class="accuracy-indicator accuracy-excellent">å·²æ ¡å‡†</span>';
                calibratedEl.querySelector('.accuracy-indicator').textContent += ` (${locationData.calibrationSource})`;
            } else {
                calibratedEl.innerHTML = '<span class="accuracy-indicator accuracy-poor">æœªæ ¡å‡†</span>';
            }
            
            document.getElementById('nearestBuilding').textContent = locationData.calibrationSource || '--';
            document.getElementById('distance').textContent = locationData.originalDistance ? `${locationData.originalDistance.toFixed(0)}m` : '--';
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusEl = document.getElementById('currentStatus');
            if (locationData.calibrated) {
                statusEl.innerHTML = `
                    <p style="color: #059669; font-weight: 600;">âœ… å®šä½æˆåŠŸå¹¶å·²æ ¡å‡†</p>
                    <p>æ ¡å‡†æ¥æº: ${locationData.calibrationSource}</p>
                    <p>åŸå§‹è·ç¦»: ${locationData.originalDistance?.toFixed(0)}m | æ–°ç²¾åº¦: ${locationData.accuracy?.toFixed(0)}m</p>
                `;
            } else {
                statusEl.innerHTML = `
                    <p style="color: #d97706; font-weight: 600;">âš ï¸ å®šä½æˆåŠŸä½†æœªæ ¡å‡†</p>
                    <p>å¯èƒ½åŸå› : è·ç¦»å‚è€ƒç‚¹å¤ªè¿œæˆ–ç²¾åº¦ä¸è¶³</p>
                    <p>å½“å‰ç²¾åº¦: ${locationData.accuracy?.toFixed(0)}m</p>
                `;
            }
        }
        
        // æµ‹è¯•å½“å‰å®šä½
        window.testCurrentLocation = async function() {
            const btn = document.getElementById('testBtn');
            btn.innerHTML = '<span class="loading"></span>æ­£åœ¨å®šä½...';
            btn.disabled = true;
            
            addLog('ğŸš€ å¼€å§‹æµ‹è¯•å½“å‰å®šä½...', 'info');
            
            try {
                const location = await getCurrentLocation({
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                });
                
                addLog(`âœ… å®šä½æˆåŠŸ: [${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}]`, 'success');
                addLog(`ğŸ“ å®šä½ç²¾åº¦: ${location.accuracy.toFixed(0)}m`, 'info');
                
                // æµ‹è¯•æ ¡å‡†
                const calibratedLocation = smartLocationCalibration(location);
                
                if (calibratedLocation.calibrated) {
                    addLog(`ğŸ¯ æ ¡å‡†æˆåŠŸ: ${calibratedLocation.calibrationSource}`, 'success');
                    addLog(`ğŸ“ åŸå§‹è·ç¦»: ${calibratedLocation.originalDistance?.toFixed(0)}m`, 'info');
                } else {
                    addLog(`âš ï¸ æ ¡å‡†å¤±è´¥: ${calibratedLocation.calibrationReason || 'æœªçŸ¥åŸå› '}`, 'warning');
                }
                
                updateLocationDisplay(calibratedLocation);
                testResults.push({
                    timestamp: new Date().toISOString(),
                    location: calibratedLocation,
                    success: true
                });
                
            } catch (error) {
                const friendlyError = formatUserFriendlyError(error);
                addLog(`âŒ å®šä½å¤±è´¥: ${friendlyError.message}`, 'error');
                addLog(`ğŸ’¡ å»ºè®®: ${friendlyError.suggestion}`, 'warning');
                
                document.getElementById('currentStatus').innerHTML = `
                    <p style="color: #dc2626; font-weight: 600;">âŒ å®šä½å¤±è´¥</p>
                    <p>${friendlyError.message}</p>
                    <p style="font-size: 14px; color: #64748b;">${friendlyError.suggestion}</p>
                `;
                
                testResults.push({
                    timestamp: new Date().toISOString(),
                    error: friendlyError,
                    success: false
                });
            } finally {
                btn.innerHTML = 'ğŸ§ª æµ‹è¯•å½“å‰å®šä½';
                btn.disabled = false;
            }
        };
        
        // æµ‹è¯•æ ¡å‡†åŠŸèƒ½
        window.testCalibration = function() {
            addLog('ğŸ§ª å¼€å§‹æµ‹è¯•ä½ç½®æ ¡å‡†åŠŸèƒ½...', 'info');
            
            // æµ‹è¯•ä¸åŒä½ç½®çš„æ ¡å‡†æ•ˆæœ
            const testLocations = [
                { name: 'å›¾ä¹¦é¦†é™„è¿‘', latitude: 23.0419, longitude: 113.4016, accuracy: 50 },
                { name: '4æ ‹å®¿èˆé™„è¿‘', latitude: 23.0415, longitude: 113.4020, accuracy: 50 },
                { name: 'æ ¡å›­å¤–', latitude: 23.0500, longitude: 113.4100, accuracy: 100 }
            ];
            
            testLocations.forEach((testLoc, index) => {
                setTimeout(() => {
                    addLog(`ğŸ“ æµ‹è¯•ä½ç½®: ${testLoc.name}`, 'info');
                    const calibrated = smartLocationCalibration(testLoc);
                    
                    if (calibratedLocation.calibrated) {
                        addLog(`âœ… ${testLoc.name} æ ¡å‡†æˆåŠŸ: ${calibratedLocation.calibrationSource}`, 'success');
                    } else {
                        addLog(`âš ï¸ ${testLoc.name} æ ¡å‡†å¤±è´¥`, 'warning');
                    }
                }, index * 1000);
            });
        };
        
        // æ¸…é™¤ç¼“å­˜
        window.clearCache = function() {
            if ('localStorage' in window) {
                const keys = Object.keys(localStorage).filter(key => key.startsWith('location_'));
                keys.forEach(key => localStorage.removeItem(key));
                addLog(`ğŸ—‘ï¸ å·²æ¸…é™¤ ${keys.length} ä¸ªå®šä½ç¼“å­˜`, 'success');
            }
        };
        
        // åˆå§‹åŒ–
        addLog('ğŸ¯ å®šä½ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
        addLog('ğŸ“ ä¿®å¤å†…å®¹: æ ¡å›­åæ ‡ã€æ ¡å‡†èŒƒå›´ã€å‚è€ƒç‚¹æ•°é‡', 'info');
    </script>
</body>
</html>