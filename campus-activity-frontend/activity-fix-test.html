<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨æ•°æ®ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        .activity-list {
            list-style: none;
            padding: 0;
        }
        .activity-item {
            background: white;
            margin: 8px 0;
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .activity-title {
            font-weight: bold;
            color: #495057;
        }
        .activity-meta {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ´»åŠ¨æ•°æ®ä¿®å¤æµ‹è¯•å·¥å…·</h1>
    
    <div class="container">
        <h2>ğŸ“Š å½“å‰çŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkCurrentData()">æ£€æŸ¥å½“å‰æ´»åŠ¨æ•°æ®</button>
        <div id="current-status"></div>
    </div>

    <div class="container">
        <h2>ğŸ”„ ä¿®å¤æ“ä½œ</h2>
        <button onclick="fixActivityData()" class="danger">ä¿®å¤æ´»åŠ¨æ•°æ®</button>
        <button onclick="clearAllData()">æ¸…ç†æ‰€æœ‰æ•°æ®</button>
        <div id="fix-status"></div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æ´»åŠ¨åˆ—è¡¨é¢„è§ˆ</h2>
        <button onclick="previewActivities()">é¢„è§ˆæ´»åŠ¨åˆ—è¡¨</button>
        <div id="activity-preview"></div>
    </div>

    <div class="container">
        <h2>ğŸ§ª è‡ªåŠ¨æµ‹è¯•</h2>
        <button onclick="runAutoTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="auto-test-result"></div>
    </div>

    <div class="container">
        <h2>ğŸ“ æ§åˆ¶å°è¾“å‡º</h2>
        <pre id="console-output">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</pre>
    </div>

    <script>
        // æ§åˆ¶å°è¾“å‡ºé‡å®šå‘
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToConsole(message, type = 'log') {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'warn' ? 'warning' : 'info';
            output.innerHTML += `<div class="status ${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        // æ£€æŸ¥å½“å‰æ´»åŠ¨æ•°æ®
        function checkCurrentData() {
            const status = document.getElementById('current-status');
            
            try {
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                
                let html = `<div class="status info">æ‰¾åˆ° ${activities.length} ä¸ªæ´»åŠ¨</div>`;
                
                if (activities.length > 0) {
                    const titles = activities.map(a => a.title);
                    const uniqueTitles = [...new Set(titles)];
                    
                    if (uniqueTitles.length === 1) {
                        html += `<div class="status error">âš ï¸ é—®é¢˜: æ‰€æœ‰æ´»åŠ¨éƒ½æ˜¯åŒä¸€ä¸ªæ ‡é¢˜ "${uniqueTitles[0]}"</div>`;
                    } else {
                        html += `<div class="status success">âœ… æ´»åŠ¨æ•°æ®æ­£å¸¸ï¼ŒåŒ…å« ${uniqueTitles.length} ç§ä¸åŒæ´»åŠ¨</div>`;
                    }
                    
                    html += '<h4>æ´»åŠ¨åˆ—è¡¨:</h4><ul class="activity-list">';
                    activities.forEach((activity, index) => {
                        html += `<li class="activity-item">
                            <div class="activity-title">${activity.title || 'æ— æ ‡é¢˜'}</div>
                            <div class="activity-meta">
                                ç±»å‹: ${activity.type || 'æœªçŸ¥'} | 
                                ä½ç½®: ${activity.locationName || 'æœªçŸ¥'} | 
                                ID: ${activity.id || 'æœªçŸ¥'}
                            </div>
                        </li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<div class="status warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ´»åŠ¨æ•°æ®</div>';
                }
                
                status.innerHTML = html;
                
            } catch (error) {
                status.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ä¿®å¤æ´»åŠ¨æ•°æ®
        function fixActivityData() {
            const status = document.getElementById('fix-status');
            
            try {
                // æ¸…ç†ç°æœ‰æ•°æ®
                localStorage.removeItem('campus_activities');
                
                // ç”Ÿæˆæ­£ç¡®çš„é»˜è®¤æ´»åŠ¨æ•°æ®
                const defaultOrganizerId = 1;
                const defaultActivities = [
                    {
                        id: 1,
                        title: 'ä¸­åŒ»å…»ç”Ÿè®²åº§',
                        type: 'study',
                        category: 'study',
                        locationName: 'å­¦æœ¯æŠ¥å‘Šå…',
                        location: {
                            name: 'å­¦æœ¯æŠ¥å‘Šå…',
                            address: 'å­¦æ ¡å­¦æœ¯æŠ¥å‘Šå…'
                        },
                        description: 'é‚€è¯·ä¸­åŒ»ä¸“å®¶è®²è§£ä¸­åŒ»å…»ç”ŸçŸ¥è¯†ï¼Œåˆ†äº«ä¼ ç»Ÿä¿å¥æ–¹æ³•ã€‚',
                        startTime: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000 + 2 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000 - 2 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000 - 2 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 15,
                        maxParticipants: 30,
                        organizer: {
                            id: defaultOrganizerId + 1,
                            name: 'ä¸­åŒ»å­¦é™¢',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 98
                        },
                        distance: 0.8,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    },
                    {
                        id: 2,
                        title: 'æ‘„å½±ä½œå“å±•è§ˆ',
                        type: 'culture',
                        category: 'culture',
                        locationName: 'è‰ºæœ¯å±•å…',
                        location: {
                            name: 'è‰ºæœ¯å±•å…',
                            address: 'å­¦æ ¡è‰ºæœ¯å±•å…'
                        },
                        description: 'å±•ç¤ºå­¦ç”Ÿæ‘„å½±ä½œå“ï¼Œåˆ†äº«æ‘„å½±æŠ€å·§ï¼Œäº¤æµåˆ›ä½œå¿ƒå¾—ã€‚',
                        startTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 + 3 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 - 3 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 - 3 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 12,
                        maxParticipants: 25,
                        organizer: {
                            id: defaultOrganizerId + 2,
                            name: 'æ‘„å½±åä¼š',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 92
                        },
                        distance: 0.3,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    },
                    {
                        id: 3,
                        title: 'ç¼–ç¨‹é©¬æ‹‰æ¾å¤§èµ›',
                        type: 'tech',
                        category: 'tech',
                        locationName: 'åˆ›æ–°å®éªŒå®¤',
                        location: {
                            name: 'åˆ›æ–°å®éªŒå®¤',
                            address: 'å­¦æ ¡åˆ›æ–°å®éªŒå®¤'
                        },
                        description: '24å°æ—¶ç¼–ç¨‹æŒ‘æˆ˜èµ›ï¼Œä¸»é¢˜ä¸ºæ™ºæ…§æ ¡å›­ï¼Œå±•ç¤ºç¼–ç¨‹æŠ€èƒ½ã€‚',
                        startTime: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000 - 4 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000 - 4 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 8,
                        maxParticipants: 20,
                        organizer: {
                            id: defaultOrganizerId + 3,
                            name: 'è®¡ç®—æœºå­¦é™¢',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 96
                        },
                        distance: 1.2,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    },
                    {
                        id: 4,
                        title: 'éŸ³ä¹èŠ‚',
                        type: 'culture',
                        category: 'culture',
                        locationName: 'éœ²å¤©å‰§åœº',
                        location: {
                            name: 'éœ²å¤©å‰§åœº',
                            address: 'å­¦æ ¡éœ²å¤©å‰§åœº'
                        },
                        description: 'å¹´åº¦æ ¡å›­éŸ³ä¹èŠ‚ï¼Œé‚€è¯·æ ¡å†…å¤–ä¹é˜Ÿæ¼”å‡ºï¼Œäº«å—éŸ³ä¹ç››å®´ã€‚',
                        startTime: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000 - 4 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000 - 4 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 25,
                        maxParticipants: 40,
                        organizer: {
                            id: defaultOrganizerId + 4,
                            name: 'å­¦ç”Ÿä¼š',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 94
                        },
                        distance: 0.6,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    },
                    {
                        id: 5,
                        title: 'ç¯®çƒå‹è°Šèµ›',
                        type: 'sports',
                        category: 'sports',
                        locationName: 'ç¯®çƒåœº1',
                        location: {
                            name: 'ç¯®çƒåœº1',
                            address: 'å­¦æ ¡ç¯®çƒåœº1'
                        },
                        description: 'å‘¨æœ«ç¯®çƒæ¯”èµ›ï¼Œæ¬¢è¿æ‰€æœ‰ç¯®çƒçˆ±å¥½è€…å‚åŠ ã€‚æ´»åŠ¨å°†åœ¨å­¦æ ¡ç¯®çƒåœºä¸¾è¡Œï¼Œè¯·è‡ªå¸¦è¿åŠ¨è£…å¤‡ã€‚',
                        startTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 26 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 4,
                        maxParticipants: 8,
                        organizer: {
                            id: defaultOrganizerId,
                            name: 'ç¯®çƒç¤¾',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 95
                        },
                        distance: 0.5,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    }
                ];
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('campus_activities', JSON.stringify(defaultActivities));
                
                status.innerHTML = `
                    <div class="status success">âœ… ä¿®å¤æˆåŠŸï¼å·²ä¿å­˜ ${defaultActivities.length} ä¸ªæ­£ç¡®çš„æ´»åŠ¨æ•°æ®</div>
                    <div class="status info">è¯·åˆ·æ–°æ´»åŠ¨åˆ—è¡¨é¡µé¢æŸ¥çœ‹æ•ˆæœ</div>
                `;
                
                console.log('âœ… æ´»åŠ¨æ•°æ®ä¿®å¤å®Œæˆ');
                
            } catch (error) {
                status.innerHTML = `<div class="status error">âŒ ä¿®å¤å¤±è´¥: ${error.message}</div>`;
                console.error('âŒ ä¿®å¤å¤±è´¥:', error);
            }
        }

        // æ¸…ç†æ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æ´»åŠ¨ç›¸å…³æ•°æ®å—ï¼Ÿ')) {
                const keys = Object.keys(localStorage);
                const activityKeys = keys.filter(key => 
                    key.includes('activity') || 
                    key.includes('campus') || 
                    key.includes('activities')
                );
                
                activityKeys.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                document.getElementById('fix-status').innerHTML = `
                    <div class="status success">âœ… æ¸…ç†å®Œæˆï¼å·²æ¸…ç† ${activityKeys.length} ä¸ªé”®</div>
                `;
                
                console.log('âœ… æ•°æ®æ¸…ç†å®Œæˆ');
            }
        }

        // é¢„è§ˆæ´»åŠ¨åˆ—è¡¨
        function previewActivities() {
            const preview = document.getElementById('activity-preview');
            
            try {
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                
                if (activities.length === 0) {
                    preview.innerHTML = '<div class="status warning">æ²¡æœ‰æ´»åŠ¨æ•°æ®å¯é¢„è§ˆ</div>';
                    return;
                }
                
                let html = `<div class="status info">å…± ${activities.length} ä¸ªæ´»åŠ¨</div>`;
                html += '<ul class="activity-list">';
                
                activities.forEach((activity, index) => {
                    const isValid = activity && 
                                   typeof activity === 'object' &&
                                   activity.id && 
                                   activity.title && 
                                   activity.type &&
                                   activity.locationName;
                    
                    html += `<li class="activity-item">
                        <div class="activity-title">
                            ${isValid ? 'âœ…' : 'âŒ'} ${activity.title || 'æ— æ ‡é¢˜'}
                        </div>
                        <div class="activity-meta">
                            ç±»å‹: ${activity.type || 'æœªçŸ¥'} | 
                            ä½ç½®: ${activity.locationName || 'æœªçŸ¥'} | 
                            ID: ${activity.id || 'æœªçŸ¥'} |
                            çŠ¶æ€: ${isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}
                        </div>
                    </li>`;
                });
                
                html += '</ul>';
                preview.innerHTML = html;
                
            } catch (error) {
                preview.innerHTML = `<div class="status error">âŒ é¢„è§ˆå¤±è´¥: ${error.message}</div>`;
            }
        }

        // è¿è¡Œè‡ªåŠ¨æµ‹è¯•
        function runAutoTest() {
            const result = document.getElementById('auto-test-result');
            
            console.log('ğŸ” å¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            
            // æ£€æŸ¥å½“å‰æ•°æ®
            const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
            const titles = activities.map(a => a.title);
            const uniqueTitles = [...new Set(titles)];
            
            let html = '<div class="status info">ğŸ§ª è‡ªåŠ¨æµ‹è¯•ç»“æœ:</div>';
            
            if (activities.length === 0) {
                html += '<div class="status warning">âš ï¸ æ²¡æœ‰æ´»åŠ¨æ•°æ®ï¼Œæ­£åœ¨ä¿®å¤...</div>';
                fixActivityData();
                html += '<div class="status success">âœ… æ•°æ®ä¿®å¤å®Œæˆ</div>';
            } else if (uniqueTitles.length === 1) {
                html += '<div class="status error">âŒ æ£€æµ‹åˆ°æ•°æ®é‡å¤é—®é¢˜ï¼Œæ­£åœ¨ä¿®å¤...</div>';
                fixActivityData();
                html += '<div class="status success">âœ… æ•°æ®ä¿®å¤å®Œæˆ</div>';
            } else {
                html += '<div class="status success">âœ… æ´»åŠ¨æ•°æ®æ­£å¸¸</div>';
            }
            
            // éªŒè¯ä¿®å¤ç»“æœ
            const fixedActivities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
            const fixedTitles = fixedActivities.map(a => a.title);
            const fixedUniqueTitles = [...new Set(fixedTitles)];
            
            if (fixedActivities.length >= 5 && fixedUniqueTitles.length >= 5) {
                html += '<div class="status success">ğŸ‰ æµ‹è¯•é€šè¿‡ï¼æ´»åŠ¨æ•°æ®å·²æ¢å¤æ­£å¸¸</div>';
                html += `<div class="status info">æ´»åŠ¨æ•°é‡: ${fixedActivities.length}, ä¸åŒæ´»åŠ¨: ${fixedUniqueTitles.length}</div>`;
            } else {
                html += '<div class="status error">âŒ æµ‹è¯•å¤±è´¥ï¼Œæ•°æ®ä»æœ‰é—®é¢˜</div>';
            }
            
            result.innerHTML = html;
            console.log('ğŸ‰ è‡ªåŠ¨æµ‹è¯•å®Œæˆ');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ£€æŸ¥...');
            checkCurrentData();
        };
    </script>
</body>
</html>