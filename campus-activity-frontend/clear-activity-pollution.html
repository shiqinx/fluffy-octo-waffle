<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨æ•°æ®æ±¡æŸ“æ¸…ç†å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .info { background: #e3f2fd; color: #1976d2; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #f57c00; }
        .error { background: #ffebee; color: #c62828; }
        .button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .button:hover { background: #1565c0; }
        .button.danger { background: #d32f2f; }
        .button.danger:hover { background: #c62828; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .activity-list {
            margin: 20px 0;
        }
        .activity-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ´»åŠ¨æ•°æ®æ±¡æŸ“æ¸…ç†å·¥å…·</h1>
        
        <div class="status info">
            <strong>é—®é¢˜è¯Šæ–­ï¼š</strong>å¦‚æœæ‰€æœ‰æ´»åŠ¨éƒ½æ˜¾ç¤ºä¸º"ä¸­åŒ»å…»ç”Ÿè®²åº§"ï¼Œè¯´æ˜localStorageä¸­çš„æ•°æ®è¢«æ±¡æŸ“æˆ–é‡å¤äº†ã€‚
        </div>

        <div class="button-group">
            <button class="button" onclick="checkCurrentData()">ğŸ“Š æ£€æŸ¥å½“å‰æ•°æ®</button>
            <button class="button danger" onclick="clearPollution()">ğŸ—‘ï¸ æ¸…ç†æ•°æ®æ±¡æŸ“</button>
            <button class="button" onclick="reloadPage()">ğŸ”„ åˆ·æ–°é¡µé¢</button>
        </div>

        <div id="status"></div>
        <div id="activityList" class="activity-list"></div>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function checkCurrentData() {
            log('å¼€å§‹æ£€æŸ¥å½“å‰æ•°æ®...');
            
            const keysToCheck = [
                'campus_activities',
                'activities', 
                'activity_data',
                'user_activities',
                'enrollments'
            ];
            
            let totalActivities = [];
            
            keysToCheck.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        log(`ğŸ“ ${key}: ${Array.isArray(parsed) ? parsed.length : 'éæ•°ç»„'} æ¡æ•°æ®`);
                        
                        if (Array.isArray(parsed)) {
                            totalActivities = totalActivities.concat(parsed);
                            
                            // æ£€æŸ¥æ ‡é¢˜é‡å¤æƒ…å†µ
                            const titles = parsed.map(item => item.title || item.name || 'æœªçŸ¥');
                            const uniqueTitles = [...new Set(titles)];
                            
                            if (uniqueTitles.length === 1 && uniqueTitles[0] === 'ä¸­åŒ»å…»ç”Ÿè®²åº§') {
                                log(`âš ï¸ ${key} ä¸­æ‰€æœ‰é¡¹ç›®éƒ½æ˜¯"ä¸­åŒ»å…»ç”Ÿè®²åº§"`);
                            }
                        }
                    } catch (error) {
                        log(`âŒ ${key} æ•°æ®è§£æå¤±è´¥: ${error.message}`);
                    }
                } else {
                    log(`ğŸ“ ${key}: æ— æ•°æ®`);
                }
            });
            
            // æ˜¾ç¤ºæ´»åŠ¨åˆ—è¡¨
            displayActivities(totalActivities);
            
            // åˆ†ææ•°æ®
            const allTitles = totalActivities.map(item => item.title || item.name || 'æœªçŸ¥');
            const uniqueTitles = [...new Set(allTitles)];
            
            if (uniqueTitles.length === 1 && uniqueTitles[0] === 'ä¸­åŒ»å…»ç”Ÿè®²åº§') {
                showStatus('âŒ æ£€æµ‹åˆ°æ•°æ®æ±¡æŸ“ï¼æ‰€æœ‰æ´»åŠ¨éƒ½æ˜¾ç¤ºä¸º"ä¸­åŒ»å…»ç”Ÿè®²åº§"', 'error');
            } else if (uniqueTitles.length === 0) {
                showStatus('ğŸ“­ æš‚æ— æ´»åŠ¨æ•°æ®', 'info');
            } else {
                showStatus(`âœ… æ•°æ®æ­£å¸¸ï¼Œå…± ${totalActivities.length} ä¸ªæ´»åŠ¨ï¼Œ${uniqueTitles.length} ä¸ªä¸åŒæ ‡é¢˜`, 'success');
            }
        }

        function displayActivities(activities) {
            const listDiv = document.getElementById('activityList');
            
            if (activities.length === 0) {
                listDiv.innerHTML = '<p>æš‚æ— æ´»åŠ¨æ•°æ®</p>';
                return;
            }
            
            const titles = activities.map(item => item.title || item.name || 'æœªçŸ¥');
            const titleCounts = {};
            titles.forEach(title => {
                titleCounts[title] = (titleCounts[title] || 0) + 1;
            });
            
            const html = Object.entries(titleCounts).map(([title, count]) => `
                <div class="activity-item">
                    <strong>${title}</strong> - ${count} ä¸ª
                </div>
            `).join('');
            
            listDiv.innerHTML = `<h3>æ´»åŠ¨æ ‡é¢˜ç»Ÿè®¡ï¼š</h3>${html}`;
        }

        function clearPollution() {
            log('å¼€å§‹æ¸…ç†æ•°æ®æ±¡æŸ“...');
            
            const keysToCheck = [
                'campus_activities',
                'activities',
                'activity_data', 
                'user_activities',
                'enrollments'
            ];
            
            let clearedCount = 0;
            
            keysToCheck.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed)) {
                            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ´»åŠ¨éƒ½æ˜¯åŒä¸€ä¸ªæ ‡é¢˜
                            const titles = parsed.map(item => item.title || item.name || 'æœªçŸ¥');
                            const uniqueTitles = [...new Set(titles)];
                            
                            if (uniqueTitles.length === 1 && uniqueTitles[0] === 'ä¸­åŒ»å…»ç”Ÿè®²åº§') {
                                log(`ğŸ—‘ï¸ æ¸…ç† ${key} ä¸­çš„æ±¡æŸ“æ•°æ®...`);
                                localStorage.removeItem(key);
                                clearedCount++;
                                log(`âœ… å·²æ¸…ç† ${key}`);
                            } else {
                                log(`âœ… ${key} æ•°æ®æ­£å¸¸ï¼Œä¿ç•™`);
                            }
                        }
                    } catch (error) {
                        log(`ğŸ—‘ï¸ ${key} æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œæ¸…ç†ä¸­...`);
                        localStorage.removeItem(key);
                        clearedCount++;
                    }
                }
            });
            
            if (clearedCount > 0) {
                showStatus(`âœ… æˆåŠŸæ¸…ç† ${clearedCount} ä¸ªæ±¡æŸ“çš„æ•°æ®é¡¹ï¼è¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœã€‚`, 'success');
                log('ğŸ‰ æ¸…ç†å®Œæˆï¼å»ºè®®åˆ·æ–°é¡µé¢ä»¥é‡æ–°åŠ è½½æ•°æ®ã€‚');
            } else {
                showStatus('â„¹ï¸ æœªå‘ç°éœ€è¦æ¸…ç†çš„æ•°æ®', 'info');
                log('â„¹ï¸ æœªå‘ç°æ•°æ®æ±¡æŸ“é—®é¢˜');
            }
        }

        function reloadPage() {
            log('é‡æ–°åŠ è½½é¡µé¢...');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkCurrentData();
        };
    </script>
</body>
</html>