<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼èˆªæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .nav-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª åº”ç”¨å¯¼èˆªå’ŒçŠ¶æ€æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š å½“å‰çŠ¶æ€æ£€æŸ¥</h2>
        <div id="status-check">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkStatus()">é‡æ–°æ£€æŸ¥</button>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª ç”¨æˆ·è®¤è¯æµ‹è¯•</h2>
        <div id="auth-status">æ£€æŸ¥ä¸­...</div>
        <div>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button onclick="testLogout()">æµ‹è¯•é€€å‡º</button>
            <button onclick="checkAuthStatus()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ§­ è·¯ç”±å¯¼èˆªæµ‹è¯•</h2>
        <div class="nav-test">
            <button onclick="navigateTo('/home')">é¦–é¡µ</button>
            <button onclick="navigateTo('/activities-teams')">æ´»åŠ¨/å›¢é˜Ÿ</button>
            <button onclick="navigateTo('/messages')">æ¶ˆæ¯</button>
            <button onclick="navigateTo('/profile')">ä¸ªäººä¸­å¿ƒ</button>
            <button onclick="navigateTo('/activities/create')">åˆ›å»ºæ´»åŠ¨</button>
            <button onclick="navigateTo('/login')">ç™»å½•é¡µ</button>
        </div>
        <div id="nav-result">ç‚¹å‡»æŒ‰é’®æµ‹è¯•å¯¼èˆª</div>
    </div>

    <div class="test-section">
        <h2>ğŸ“± åº•éƒ¨å¯¼èˆªæµ‹è¯•</h2>
        <div id="bottom-nav-status">æ£€æŸ¥ä¸­...</div>
        <button onclick="testBottomNav()">æµ‹è¯•åº•éƒ¨å¯¼èˆª</button>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ æ§åˆ¶å°æ—¥å¿—</h2>
        <div id="console-log" style="background: #f8f9fa; padding: 10px; border-radius: 4px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script type="module">
        // æ•è·æ§åˆ¶å°è¾“å‡º
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToLog(type, ...args) {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            logDiv.innerHTML += `<div style="color: ${type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black'}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog('log', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog('error', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog('warn', ...args);
        };

        // æ£€æŸ¥åº”ç”¨çŠ¶æ€
        window.checkStatus = function() {
            const statusDiv = document.getElementById('status-check');
            
            try {
                // æ£€æŸ¥å½“å‰URL
                const currentUrl = window.location.href;
                const currentPath = window.location.pathname;
                
                // æ£€æŸ¥localStorage
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('user');
                const loginTime = localStorage.getItem('loginTime');
                
                let statusHTML = `
                    <div class="info"><strong>å½“å‰URL:</strong> ${currentUrl}</div>
                    <div class="info"><strong>å½“å‰è·¯å¾„:</strong> ${currentPath}</div>
                    <div class="${token ? 'success' : 'error'}"><strong>Token:</strong> ${token ? 'å·²å­˜åœ¨' : 'ä¸å­˜åœ¨'}</div>
                    <div class="${user ? 'success' : 'error'}"><strong>ç”¨æˆ·ä¿¡æ¯:</strong> ${user ? 'å·²å­˜åœ¨' : 'ä¸å­˜åœ¨'}</div>
                    <div class="${loginTime ? 'success' : 'error'}"><strong>ç™»å½•æ—¶é—´:</strong> ${loginTime ? new Date(parseInt(loginTime)).toLocaleString() : 'ä¸å­˜åœ¨'}</div>
                `;
                
                if (token && loginTime) {
                    const loginTimestamp = parseInt(loginTime);
                    const currentTime = Date.now();
                    const fourHours = 4 * 60 * 60 * 1000;
                    const timeRemaining = fourHours - (currentTime - loginTimestamp);
                    
                    if (timeRemaining > 0) {
                        statusHTML += `<div class="success"><strong>Tokenæœ‰æ•ˆæœŸ:</strong> ${Math.floor(timeRemaining / 60000)} åˆ†é’Ÿ</div>`;
                    } else {
                        statusHTML += `<div class="error"><strong>TokençŠ¶æ€:</strong> å·²è¿‡æœŸ</div>`;
                    }
                }
                
                statusDiv.innerHTML = statusHTML;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">æ£€æŸ¥çŠ¶æ€æ—¶å‡ºé”™: ${error.message}</div>`;
            }
        };

        // æµ‹è¯•ç™»å½•
        window.testLogin = async function() {
            const authDiv = document.getElementById('auth-status');
            authDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•ç™»å½•...</div>';
            
            try {
                // å¯¼å…¥ç™»å½•API
                const { mockLogin } = await import('./src/api/mock.js');
                
                const testCredentials = {
                    studentId: '2021001',
                    password: 'password123'
                };
                
                console.log('æµ‹è¯•ç™»å½•å‡­æ®:', testCredentials);
                
                const result = await mockLogin(testCredentials);
                console.log('ç™»å½•ç»“æœ:', result);
                
                if (result && result.data) {
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('token', result.data.token);
                    localStorage.setItem('user', JSON.stringify(result.data.user));
                    localStorage.setItem('loginTime', Date.now().toString());
                    
                    authDiv.innerHTML = `
                        <div class="success">âœ… ç™»å½•æµ‹è¯•æˆåŠŸ!</div>
                        <div class="info">ç”¨æˆ·: ${result.data.user.name}</div>
                        <div class="info">Token: ${result.data.token.substring(0, 20)}...</div>
                    `;
                } else {
                    authDiv.innerHTML = '<div class="error">âŒ ç™»å½•å¤±è´¥: å“åº”æ ¼å¼é”™è¯¯</div>';
                }
                
            } catch (error) {
                console.error('ç™»å½•æµ‹è¯•å¤±è´¥:', error);
                authDiv.innerHTML = `<div class="error">âŒ ç™»å½•æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        };

        // æµ‹è¯•é€€å‡º
        window.testLogout = function() {
            try {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                
                document.getElementById('auth-status').innerHTML = '<div class="success">âœ… å·²æ¸…é™¤ç™»å½•ä¿¡æ¯</div>';
                console.log('ç”¨æˆ·å·²é€€å‡ºç™»å½•');
                
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                document.getElementById('auth-status').innerHTML = `<div class="error">âŒ é€€å‡ºå¤±è´¥: ${error.message}</div>`;
            }
        };

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        window.checkAuthStatus = function() {
            const authDiv = document.getElementById('auth-status');
            
            try {
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('user');
                const loginTime = localStorage.getItem('loginTime');
                
                if (!token || !loginTime) {
                    authDiv.innerHTML = '<div class="error">âŒ ç”¨æˆ·æœªç™»å½•</div>';
                    return;
                }
                
                const loginTimestamp = parseInt(loginTime);
                const currentTime = Date.now();
                const fourHours = 4 * 60 * 60 * 1000;
                
                if (currentTime - loginTimestamp > fourHours) {
                    authDiv.innerHTML = '<div class="error">âŒ Tokenå·²è¿‡æœŸ</div>';
                } else {
                    const userData = JSON.parse(user || '{}');
                    authDiv.innerHTML = `
                        <div class="success">âœ… ç”¨æˆ·å·²ç™»å½•</div>
                        <div class="info">ç”¨æˆ·å: ${userData.name || 'æœªçŸ¥'}</div>
                        <div class="info">å­¦å·: ${userData.studentId || 'æœªçŸ¥'}</div>
                    `;
                }
                
            } catch (error) {
                authDiv.innerHTML = `<div class="error">âŒ æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥: ${error.message}</div>`;
            }
        };

        // å¯¼èˆªæµ‹è¯•
        window.navigateTo = function(path) {
            const navResult = document.getElementById('nav-result');
            
            try {
                console.log('å°è¯•å¯¼èˆªåˆ°:', path);
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯
                const protectedRoutes = ['/home', '/activities-teams', '/messages', '/profile'];
                const needsAuth = protectedRoutes.some(route => path.startsWith(route));
                
                if (needsAuth) {
                    const token = localStorage.getItem('token');
                    const loginTime = localStorage.getItem('loginTime');
                    
                    if (!token || !loginTime) {
                        navResult.innerHTML = `<div class="error">âŒ è·¯å¾„ ${path} éœ€è¦ç™»å½•ï¼Œè¯·å…ˆç™»å½•</div>`;
                        return;
                    }
                    
                    const loginTimestamp = parseInt(loginTime);
                    const currentTime = Date.now();
                    const fourHours = 4 * 60 * 60 * 1000;
                    
                    if (currentTime - loginTimestamp > fourHours) {
                        navResult.innerHTML = `<div class="error">âŒ Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</div>`;
                        return;
                    }
                }
                
                // æ‰§è¡Œå¯¼èˆª
                window.location.href = window.location.origin + '/#' + path;
                navResult.innerHTML = `<div class="success">âœ… æ­£åœ¨å¯¼èˆªåˆ°: ${path}</div>`;
                
            } catch (error) {
                console.error('å¯¼èˆªå¤±è´¥:', error);
                navResult.innerHTML = `<div class="error">âŒ å¯¼èˆªå¤±è´¥: ${error.message}</div>`;
            }
        };

        // æµ‹è¯•åº•éƒ¨å¯¼èˆª
        window.testBottomNav = function() {
            const navDiv = document.getElementById('bottom-nav-status');
            
            try {
                // æ£€æŸ¥å½“å‰è·¯å¾„å¯¹åº”çš„åº•éƒ¨å¯¼èˆªçŠ¶æ€
                const currentPath = window.location.hash || '#/home';
                let activeTab = 'home';
                
                if (currentPath.includes('/activities') || currentPath.includes('/teams')) {
                    activeTab = 'activities-teams';
                } else if (currentPath.includes('/messages') || currentPath.includes('/chat')) {
                    activeTab = 'messages';
                } else if (currentPath.includes('/profile')) {
                    activeTab = 'profile';
                }
                
                navDiv.innerHTML = `
                    <div class="success">âœ… åº•éƒ¨å¯¼èˆªçŠ¶æ€æ­£å¸¸</div>
                    <div class="info">å½“å‰è·¯å¾„: ${currentPath}</div>
                    <div class="info">æ´»è·ƒæ ‡ç­¾: ${activeTab}</div>
                `;
                
            } catch (error) {
                navDiv.innerHTML = `<div class="error">âŒ æ£€æŸ¥åº•éƒ¨å¯¼èˆªå¤±è´¥: ${error.message}</div>`;
            }
        };

        // æ¸…ç©ºæ—¥å¿—
        window.clearLog = function() {
            document.getElementById('console-log').innerHTML = '';
        };

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å¯¼èˆªæµ‹è¯•é¡µé¢å·²åŠ è½½');
            checkStatus();
            checkAuthStatus();
            testBottomNav();
        });

        // ç›‘å¬è·¯ç”±å˜åŒ–
        window.addEventListener('hashchange', function() {
            console.log('è·¯ç”±å˜åŒ–:', window.location.hash);
            testBottomNav();
        });
    </script>
</body>
</html>