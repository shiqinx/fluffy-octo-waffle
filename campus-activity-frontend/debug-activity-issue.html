<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£€æŸ¥æ´»åŠ¨æ•°æ®é—®é¢˜</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .activity-item {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 3px;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #218838;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>æ´»åŠ¨æ•°æ®é—®é¢˜è¯Šæ–­å·¥å…·</h1>
    
    <div class="section">
        <h2>å½“å‰localStorageçŠ¶æ€</h2>
        <button onclick="checkLocalStorage()">æ£€æŸ¥localStorage</button>
        <div id="storage-info"></div>
    </div>

    <div class="section">
        <h2>æ´»åŠ¨æ•°æ®åˆ†æ</h2>
        <button onclick="analyzeActivities()">åˆ†ææ´»åŠ¨æ•°æ®</button>
        <div id="activity-analysis"></div>
    </div>

    <div class="section">
        <h2>ä¿®å¤æ“ä½œ</h2>
        <button onclick="fixActivityData()" class="success">ä¿®å¤æ´»åŠ¨æ•°æ®</button>
        <button onclick="clearAllData()" class="danger">æ¸…ç†æ‰€æœ‰æ•°æ®</button>
        <div id="fix-result"></div>
    </div>

    <div class="section">
        <h2>æµ‹è¯•é»˜è®¤æ•°æ®ç”Ÿæˆ</h2>
        <button onclick="testDefaultData()">æµ‹è¯•é»˜è®¤æ•°æ®</button>
        <div id="default-data-test"></div>
    </div>

    <script>
        function checkLocalStorage() {
            const info = document.getElementById('storage-info');
            let html = '<h3>localStorageå†…å®¹:</h3>';
            
            // æ£€æŸ¥æ‰€æœ‰é”®
            const keys = Object.keys(localStorage);
            html += `<p>æ€»å…±æœ‰ ${keys.length} ä¸ªé”®:</p>`;
            html += '<ul>';
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                html += `<li><strong>${key}</strong>: ${value ? (value.length > 100 ? value.substring(0, 100) + '...' : value) : 'null'}</li>`;
            });
            html += '</ul>';
            
            // ç‰¹åˆ«æ£€æŸ¥æ´»åŠ¨ç›¸å…³é”®
            const activityKeys = keys.filter(key => key.includes('activity') || key.includes('campus'));
            if (activityKeys.length > 0) {
                html += '<h3>æ´»åŠ¨ç›¸å…³é”®:</h3>';
                activityKeys.forEach(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        html += `<h4>${key} (${Array.isArray(data) ? data.length : typeof data} é¡¹)</h4>`;
                        if (Array.isArray(data)) {
                            html += '<pre>' + JSON.stringify(data.slice(0, 3), null, 2) + '</pre>';
                            if (data.length > 3) {
                                html += `<p>... è¿˜æœ‰ ${data.length - 3} é¡¹</p>`;
                            }
                        }
                    } catch (e) {
                        html += `<p><strong>${key}</strong>: è§£æå¤±è´¥ - ${e.message}</p>`;
                    }
                });
            }
            
            info.innerHTML = html;
        }

        function analyzeActivities() {
            const analysis = document.getElementById('activity-analysis');
            let html = '';
            
            try {
                const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
                
                html += `<h3>æ´»åŠ¨æ•°æ®åˆ†æ (å…± ${activities.length} ä¸ªæ´»åŠ¨)</h3>`;
                
                if (activities.length === 0) {
                    html += '<p>âŒ æ²¡æœ‰æ‰¾åˆ°æ´»åŠ¨æ•°æ®</p>';
                } else {
                    // ç»Ÿè®¡æ ‡é¢˜åˆ†å¸ƒ
                    const titleCount = {};
                    activities.forEach(activity => {
                        const title = activity?.title || 'æœªçŸ¥æ ‡é¢˜';
                        titleCount[title] = (titleCount[title] || 0) + 1;
                    });
                    
                    html += '<h4>æ ‡é¢˜åˆ†å¸ƒ:</h4>';
                    Object.entries(titleCount).forEach(([title, count]) => {
                        html += `<p>${title}: ${count} æ¬¡</p>`;
                    });
                    
                    // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                    html += '<h4>æ•°æ®å®Œæ•´æ€§æ£€æŸ¥:</h4>';
                    let validCount = 0;
                    activities.forEach((activity, index) => {
                        const isValid = activity && 
                                       typeof activity === 'object' &&
                                       activity.id && 
                                       activity.title && 
                                       activity.type &&
                                       activity.locationName &&
                                       activity.startTime &&
                                       activity.endTime;
                        
                        if (isValid) validCount++;
                        
                        html += `<div class="activity-item">
                            <strong>æ´»åŠ¨ ${index + 1}</strong>: ${activity?.title || 'æ— æ ‡é¢˜'} 
                            - ${isValid ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ'}
                            <br>ID: ${activity?.id}, ç±»å‹: ${activity?.type}, ä½ç½®: ${activity?.locationName}
                        </div>`;
                    });
                    
                    html += `<p><strong>æœ‰æ•ˆæ´»åŠ¨: ${validCount}/${activities.length}</strong></p>`;
                    
                    if (validCount < 5) {
                        html += '<p>âš ï¸ æœ‰æ•ˆæ´»åŠ¨æ•°é‡å°‘äº5ä¸ªï¼Œéœ€è¦ä¿®å¤</p>';
                    }
                }
                
            } catch (error) {
                html += `<p>âŒ åˆ†æå¤±è´¥: ${error.message}</p>`;
            }
            
            analysis.innerHTML = html;
        }

        function fixActivityData() {
            const result = document.getElementById('fix-result');
            
            try {
                // ç”Ÿæˆæ­£ç¡®çš„é»˜è®¤æ´»åŠ¨æ•°æ®
                const defaultOrganizerId = 1;
                const defaultActivities = [
                    {
                        id: 1,
                        title: 'ä¸­åŒ»å…»ç”Ÿè®²åº§',
                        type: 'study',
                        category: 'study',
                        locationName: 'å­¦æœ¯æŠ¥å‘Šå…',
                        location: {
                            name: 'å­¦æœ¯æŠ¥å‘Šå…',
                            address: 'å­¦æ ¡å­¦æœ¯æŠ¥å‘Šå…'
                        },
                        description: 'é‚€è¯·ä¸­åŒ»ä¸“å®¶è®²è§£ä¸­åŒ»å…»ç”ŸçŸ¥è¯†ï¼Œåˆ†äº«ä¼ ç»Ÿä¿å¥æ–¹æ³•ã€‚',
                        startTime: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000 + 2 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000 - 2 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000 - 2 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 15,
                        maxParticipants: 30,
                        organizer: {
                            id: defaultOrganizerId + 1,
                            name: 'ä¸­åŒ»å­¦é™¢',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 98
                        },
                        distance: 0.8,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    },
                    {
                        id: 2,
                        title: 'æ‘„å½±ä½œå“å±•è§ˆ',
                        type: 'culture',
                        category: 'culture',
                        locationName: 'è‰ºæœ¯å±•å…',
                        location: {
                            name: 'è‰ºæœ¯å±•å…',
                            address: 'å­¦æ ¡è‰ºæœ¯å±•å…'
                        },
                        description: 'å±•ç¤ºå­¦ç”Ÿæ‘„å½±ä½œå“ï¼Œåˆ†äº«æ‘„å½±æŠ€å·§ï¼Œäº¤æµåˆ›ä½œå¿ƒå¾—ã€‚',
                        startTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 + 3 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 - 3 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 - 3 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 12,
                        maxParticipants: 25,
                        organizer: {
                            id: defaultOrganizerId + 2,
                            name: 'æ‘„å½±åä¼š',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 92
                        },
                        distance: 0.3,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    },
                    {
                        id: 3,
                        title: 'ç¼–ç¨‹é©¬æ‹‰æ¾å¤§èµ›',
                        type: 'tech',
                        category: 'tech',
                        locationName: 'åˆ›æ–°å®éªŒå®¤',
                        location: {
                            name: 'åˆ›æ–°å®éªŒå®¤',
                            address: 'å­¦æ ¡åˆ›æ–°å®éªŒå®¤'
                        },
                        description: '24å°æ—¶ç¼–ç¨‹æŒ‘æˆ˜èµ›ï¼Œä¸»é¢˜ä¸ºæ™ºæ…§æ ¡å›­ï¼Œå±•ç¤ºç¼–ç¨‹æŠ€èƒ½ã€‚',
                        startTime: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000 - 4 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000 - 4 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 8,
                        maxParticipants: 20,
                        organizer: {
                            id: defaultOrganizerId + 3,
                            name: 'è®¡ç®—æœºå­¦é™¢',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 96
                        },
                        distance: 1.2,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    },
                    {
                        id: 4,
                        title: 'éŸ³ä¹èŠ‚',
                        type: 'culture',
                        category: 'culture',
                        locationName: 'éœ²å¤©å‰§åœº',
                        location: {
                            name: 'éœ²å¤©å‰§åœº',
                            address: 'å­¦æ ¡éœ²å¤©å‰§åœº'
                        },
                        description: 'å¹´åº¦æ ¡å›­éŸ³ä¹èŠ‚ï¼Œé‚€è¯·æ ¡å†…å¤–ä¹é˜Ÿæ¼”å‡ºï¼Œäº«å—éŸ³ä¹ç››å®´ã€‚',
                        startTime: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000 - 4 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000 - 4 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 25,
                        maxParticipants: 40,
                        organizer: {
                            id: defaultOrganizerId + 4,
                            name: 'å­¦ç”Ÿä¼š',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 94
                        },
                        distance: 0.6,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    },
                    {
                        id: 5,
                        title: 'ç¯®çƒå‹è°Šèµ›',
                        type: 'sports',
                        category: 'sports',
                        locationName: 'ç¯®çƒåœº1',
                        location: {
                            name: 'ç¯®çƒåœº1',
                            address: 'å­¦æ ¡ç¯®çƒåœº1'
                        },
                        description: 'å‘¨æœ«ç¯®çƒæ¯”èµ›ï¼Œæ¬¢è¿æ‰€æœ‰ç¯®çƒçˆ±å¥½è€…å‚åŠ ã€‚æ´»åŠ¨å°†åœ¨å­¦æ ¡ç¯®çƒåœºä¸¾è¡Œï¼Œè¯·è‡ªå¸¦è¿åŠ¨è£…å¤‡ã€‚',
                        startTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                        endTime: new Date(Date.now() + 26 * 60 * 60 * 1000).toISOString(),
                        registrationDeadline: new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString(),
                        enrollStartTime: new Date().toISOString(),
                        enrollEndTime: new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString(),
                        currentParticipants: 4,
                        maxParticipants: 8,
                        organizer: {
                            id: defaultOrganizerId,
                            name: 'ç¯®çƒç¤¾',
                            avatar: 'https://via.placeholder.com/150',
                            role: 'ç»„ç»‡è€…',
                            creditScore: 95
                        },
                        distance: 0.5,
                        isEnrolled: false,
                        isApproved: false,
                        status: 'open',
                        participants: [],
                        enrollments: []
                    }
                ];
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('campus_activities', JSON.stringify(defaultActivities));
                
                result.innerHTML = `
                    <h3>âœ… ä¿®å¤æˆåŠŸ!</h3>
                    <p>å·²ä¿å­˜ ${defaultActivities.length} ä¸ªæ­£ç¡®çš„æ´»åŠ¨æ•°æ®åˆ°localStorage</p>
                    <h4>æ´»åŠ¨åˆ—è¡¨:</h4>
                    <ul>
                        ${defaultActivities.map(a => `<li>${a.title} (${a.type})</li>`).join('')}
                    </ul>
                    <p>è¯·åˆ·æ–°æ´»åŠ¨åˆ—è¡¨é¡µé¢æŸ¥çœ‹æ•ˆæœ</p>
                `;
                
            } catch (error) {
                result.innerHTML = `<p>âŒ ä¿®å¤å¤±è´¥: ${error.message}</p>`;
            }
        }

        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æ´»åŠ¨ç›¸å…³æ•°æ®å—ï¼Ÿ')) {
                const keys = Object.keys(localStorage);
                const activityKeys = keys.filter(key => 
                    key.includes('activity') || 
                    key.includes('campus') || 
                    key.includes('activities')
                );
                
                activityKeys.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                document.getElementById('fix-result').innerHTML = `
                    <h3>âœ… æ¸…ç†å®Œæˆ!</h3>
                    <p>å·²æ¸…ç† ${activityKeys.length} ä¸ªé”®: ${activityKeys.join(', ')}</p>
                `;
                
                // é‡æ–°æ£€æŸ¥
                checkLocalStorage();
            }
        }

        function testDefaultData() {
            const test = document.getElementById('default-data-test');
            
            try {
                // æ¨¡æ‹ŸloadActivitiesFromStorageå‡½æ•°çš„é€»è¾‘
                const storedActivities = localStorage.getItem('campus_activities');
                let result = '';
                
                if (storedActivities) {
                    const activities = JSON.parse(storedActivities);
                    
                    if (Array.isArray(activities) && activities.length >= 5) {
                        const validActivities = activities.filter(activity => 
                            activity && 
                            typeof activity === 'object' &&
                            activity.id && 
                            activity.title && 
                            activity.type &&
                            activity.locationName &&
                            activity.startTime &&
                            activity.endTime
                        );
                        
                        if (validActivities.length >= 5) {
                            result = `<h3>âœ… localStorageæ•°æ®æœ‰æ•ˆ</h3>
                                <p>æ‰¾åˆ° ${validActivities.length} ä¸ªæœ‰æ•ˆæ´»åŠ¨</p>
                                <ul>${validActivities.map(a => `<li>${a.title} (${a.type})</li>`).join('')}</ul>`;
                        } else {
                            result = `<h3>âš ï¸ æœ‰æ•ˆæ´»åŠ¨ä¸è¶³</h3>
                                <p>åªæœ‰ ${validActivities.length} ä¸ªæœ‰æ•ˆæ´»åŠ¨ï¼Œéœ€è¦ä½¿ç”¨é»˜è®¤æ•°æ®</p>`;
                        }
                    } else {
                        result = `<h3>âš ï¸ æ•°æ®æ ¼å¼å¼‚å¸¸</h3>
                            <p>æ•°ç»„é•¿åº¦: ${activities?.length || 0}ï¼Œéœ€è¦ä½¿ç”¨é»˜è®¤æ•°æ®</p>`;
                    }
                } else {
                    result = `<h3>ğŸ“¦ localStorageæ— æ•°æ®</h3>
                        <p>éœ€è¦ä½¿ç”¨é»˜è®¤æ•°æ®</p>`;
                }
                
                test.innerHTML = result;
                
            } catch (error) {
                test.innerHTML = `<p>âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkLocalStorage();
            analyzeActivities();
        };
    </script>
</body>
</html>