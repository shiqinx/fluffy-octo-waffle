<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨åˆ›å»ºå®Œæ•´æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .test-btn:hover { background: #0056b3; }
        .test-btn:disabled { background: #ccc; cursor: not-allowed; }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .activity-list {
            margin: 20px 0;
        }
        .activity-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        .timestamp {
            color: #666;
            font-weight: bold;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª æ´»åŠ¨åˆ›å»ºå®Œæ•´æµ‹è¯•</h1>
        
        <div class="status info" id="status">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>
        
        <!-- ç®€å•çš„è¡¨å• -->
        <div class="form-group">
            <label class="form-label">æ´»åŠ¨æ ‡é¢˜:</label>
            <input type="text" id="activityTitle" class="form-input" value="æµ‹è¯•æ´»åŠ¨_ä¿®å¤éªŒè¯" placeholder="è¾“å…¥æ´»åŠ¨æ ‡é¢˜">
        </div>
        
        <div class="form-group">
            <label class="form-label">æ´»åŠ¨ç±»å‹:</label>
            <select id="activityType" class="form-input">
                <option value="study">å­¦ä¹ </option>
                <option value="sports">è¿åŠ¨</option>
                <option value="other">å…¶ä»–</option>
            </select>
        </div>
        
        <div>
            <button class="test-btn" onclick="createTestActivity()">ğŸš€ åˆ›å»ºæµ‹è¯•æ´»åŠ¨</button>
            <button class="test-btn" onclick="checkActivities()">ğŸ“‹ æ£€æŸ¥æ´»åŠ¨åˆ—è¡¨</button>
            <button class="test-btn" onclick="window.location.href='/activities'">ğŸ  æ´»åŠ¨åˆ—è¡¨é¡µ</button>
        </div>
        
        <div class="activity-list" id="activityList">
            <div class="info">ç‚¹å‡»"æ£€æŸ¥æ´»åŠ¨åˆ—è¡¨"æŸ¥çœ‹å½“å‰æ´»åŠ¨</div>
        </div>
        
        <div class="log" id="log">
            <div class="log-entry"><span class="timestamp">[å‡†å¤‡]</span> æµ‹è¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ´»åŠ¨å­˜å‚¨å’ŒAPI
        class ActivityManager {
            constructor() {
                this.activities = this.loadActivities();
            }

            loadActivities() {
                const stored = localStorage.getItem('campus_activities');
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        console.error('è§£ææ´»åŠ¨æ•°æ®å¤±è´¥:', e);
                    }
                }
                return [];
            }

            saveActivities() {
                localStorage.setItem('campus_activities', JSON.stringify(this.activities));
            }

            async createActivity(activityData) {
                // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const newActivity = {
                    id: Date.now().toString(),
                    ...activityData,
                    currentParticipants: 0,
                    status: 'recruiting',
                    createdAt: new Date().toISOString()
                };
                
                this.activities.push(newActivity);
                this.saveActivities();
                
                return {
                    success: true,
                    data: newActivity
                };
            }

            async refreshActivities() {
                // æ¨¡æ‹Ÿæ•°æ®åˆ·æ–°
                await new Promise(resolve => setTimeout(resolve, 100));
                this.activities = this.loadActivities();
                return this.activities;
            }
        }

        const activityManager = new ActivityManager();

        function addLog(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[æµ‹è¯•æ—¥å¿—] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function displayActivities(activities) {
            const listDiv = document.getElementById('activityList');
            
            if (!activities || activities.length === 0) {
                listDiv.innerHTML = '<div class="info">æš‚æ— æ´»åŠ¨</div>';
                return;
            }

            listDiv.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <strong>${activity.title}</strong> (ID: ${activity.id})<br>
                    ç±»å‹: ${activity.type || activity.category} | 
                    çŠ¶æ€: ${activity.status} | 
                    åˆ›å»ºæ—¶é—´: ${new Date(activity.createdAt).toLocaleString()}
                </div>
            `).join('');
        }

        async function createTestActivity() {
            try {
                const title = document.getElementById('activityTitle').value.trim();
                const type = document.getElementById('activityType').value;
                
                if (!title) {
                    updateStatus('è¯·è¾“å…¥æ´»åŠ¨æ ‡é¢˜', 'error');
                    return;
                }

                addLog('ğŸš€ å¼€å§‹åˆ›å»ºæµ‹è¯•æ´»åŠ¨...');
                updateStatus('æ­£åœ¨åˆ›å»ºæ´»åŠ¨...', 'info');

                const activityData = {
                    title: title,
                    category: type,
                    description: 'ç”¨äºéªŒè¯ä¿®å¤æ•ˆæœçš„æµ‹è¯•æ´»åŠ¨',
                    startTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    endTime: new Date(Date.now() + 26 * 60 * 60 * 1000).toISOString(),
                    location: {
                        name: 'æµ‹è¯•åœ°ç‚¹',
                        address: 'æµ‹è¯•åœ°å€'
                    },
                    maxParticipants: 20,
                    requiresApproval: false
                };

                addLog(`ğŸ“ åˆ›å»ºæ´»åŠ¨: ${activityData.title}`);

                // åˆ›å»ºæ´»åŠ¨
                const response = await activityManager.createActivity(activityData);
                
                if (response.success) {
                    addLog(`âœ… æ´»åŠ¨åˆ›å»ºæˆåŠŸ! ID: ${response.data.id}`);
                    
                    // ç«‹å³åˆ·æ–°æ•°æ®ï¼ˆæ¨¡æ‹Ÿä¿®å¤åçš„é€»è¾‘ï¼‰
                    addLog('ğŸ”„ æ­£åœ¨åˆ·æ–°æ´»åŠ¨åˆ—è¡¨æ•°æ®...');
                    await activityManager.refreshActivities();
                    addLog(`âœ… æ•°æ®åˆ·æ–°å®Œæˆï¼Œå½“å‰æ´»åŠ¨æ•°é‡: ${activityManager.activities.length}`);
                    
                    updateStatus('æ´»åŠ¨åˆ›å»ºæˆåŠŸ! ç‚¹å‡»"æ£€æŸ¥æ´»åŠ¨åˆ—è¡¨"æŸ¥çœ‹', 'success');
                    
                    // è‡ªåŠ¨æ£€æŸ¥æ´»åŠ¨åˆ—è¡¨
                    setTimeout(() => {
                        checkActivities();
                    }, 1000);
                } else {
                    throw new Error(response.message || 'åˆ›å»ºå¤±è´¥');
                }

            } catch (error) {
                addLog(`âŒ åˆ›å»ºå¤±è´¥: ${error.message}`);
                updateStatus(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkActivities() {
            try {
                addLog('ğŸ“‹ æ£€æŸ¥æ´»åŠ¨åˆ—è¡¨...');
                updateStatus('æ­£åœ¨æ£€æŸ¥æ´»åŠ¨åˆ—è¡¨...', 'info');

                await activityManager.refreshActivities();
                const activities = activityManager.activities;
                
                addLog(`ğŸ“Š å½“å‰æ´»åŠ¨æ•°é‡: ${activities.length}`);
                
                // æŸ¥æ‰¾åˆšåˆ›å»ºçš„æµ‹è¯•æ´»åŠ¨
                const testTitle = document.getElementById('activityTitle').value.trim();
                const testActivities = activities.filter(a => a.title && a.title.includes(testTitle));
                addLog(`ğŸ” æ‰¾åˆ° ${testActivities.length} ä¸ªåŒ¹é…çš„æµ‹è¯•æ´»åŠ¨`);
                
                displayActivities(activities);
                
                if (testActivities.length > 0) {
                    updateStatus('âœ… ä¿®å¤æˆåŠŸ! æ–°åˆ›å»ºçš„æ´»åŠ¨å·²æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­', 'success');
                    addLog('ğŸ‰ ä¿®å¤éªŒè¯æˆåŠŸ: æ´»åŠ¨åˆ›å»ºåç«‹å³æ˜¾ç¤º');
                } else {
                    updateStatus('âŒ ä¿®å¤å¤±è´¥: æœªæ‰¾åˆ°æ–°åˆ›å»ºçš„æ´»åŠ¨', 'error');
                    addLog('âš ï¸ ä¿®å¤éªŒè¯å¤±è´¥: æ–°åˆ›å»ºçš„æ´»åŠ¨æœªæ˜¾ç¤º');
                }

            } catch (error) {
                addLog(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
                updateStatus(`æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        addLog('ğŸ“± å®Œæ•´æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
        addLog('ğŸ”§ è¿™ä¸ªé¡µé¢æ¨¡æ‹Ÿäº†å®Œæ•´çš„æ´»åŠ¨åˆ›å»ºå’ŒéªŒè¯æµç¨‹');
        addLog('ğŸ’¡ å¡«å†™è¡¨å•åç‚¹å‡»"åˆ›å»ºæµ‹è¯•æ´»åŠ¨"å¼€å§‹æµ‹è¯•');
        
        // è‡ªåŠ¨æ£€æŸ¥å½“å‰æ´»åŠ¨
        setTimeout(() => {
            checkActivities();
        }, 1000);
    </script>
</body>
</html>