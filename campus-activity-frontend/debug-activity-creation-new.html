<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨åˆ›å»ºæ•°æ®æµè°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #40a9ff;
        }
        .button.danger {
            background: #ff4d4f;
        }
        .button.danger:hover {
            background: #ff7875;
        }
        .data-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #52c41a;
            font-weight: bold;
        }
        .error {
            color: #ff4d4f;
            font-weight: bold;
        }
        .warning {
            color: #faad14;
            font-weight: bold;
        }
        .info {
            color: #1890ff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ” æ´»åŠ¨åˆ›å»ºæ•°æ®æµè°ƒè¯•å·¥å…·</h1>
    
    <div class="container">
        <div class="section">
            <h3>ğŸ“Š localStorage æ•°æ®æ£€æŸ¥</h3>
            <button class="button" onclick="checkLocalStorageData()">æ£€æŸ¥ localStorage æ•°æ®</button>
            <button class="button danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            <div id="localStorageDisplay" class="data-display"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ§ª æ¨¡æ‹Ÿæ´»åŠ¨åˆ›å»º</h3>
            <button class="button" onclick="simulateCreateActivity()">æ¨¡æ‹Ÿåˆ›å»ºæ´»åŠ¨</button>
            <button class="button" onclick="simulateMultipleActivities()">åˆ›å»ºå¤šä¸ªæµ‹è¯•æ´»åŠ¨</button>
            <div id="creationResult" class="data-display"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ“‹ æ´»åŠ¨åˆ—è¡¨è·å–æµ‹è¯•</h3>
            <button class="button" onclick="testGetActivityList()">æµ‹è¯•è·å–æ´»åŠ¨åˆ—è¡¨</button>
            <button class="button" onclick="testStoreLoadActivities()">æµ‹è¯• Store åŠ è½½æ´»åŠ¨</button>
            <div id="listResult" class="data-display"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ”„ æ•°æ®åŒæ­¥æ£€æŸ¥</h3>
            <button class="button" onclick="checkDataSync()">æ£€æŸ¥æ•°æ®åŒæ­¥çŠ¶æ€</button>
            <button class="button" onclick="forceDataSync()">å¼ºåˆ¶æ•°æ®åŒæ­¥</button>
            <div id="syncResult" class="data-display"></div>
        </div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿ API å’Œ Store é€»è¾‘
        window.calculateActivityStatus = (startTime, endTime) => {
            const now = new Date();
            const start = new Date(startTime);
            const end = new Date(endTime);
            
            if (now < start) return 'recruiting';
            if (now >= start && now <= end) return 'ongoing';
            return 'ended';
        };

        window.mockCreateActivity = async (activityData) => {
            console.log('ğŸ”§ Mock API: åˆ›å»ºæ´»åŠ¨', activityData);
            
            const newActivity = {
                id: `act_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                creatorId: 1,
                creatorName: "æµ‹è¯•ç”¨æˆ·",
                createTime: new Date().toISOString(),
                ...activityData,
                currentParticipants: 1,
                status: calculateActivityStatus(activityData.startTime, activityData.endTime)
            };
            
            // è·å–ç°æœ‰æ´»åŠ¨
            const existingActivities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
            existingActivities.unshift(newActivity);
            localStorage.setItem('campus_activities', JSON.stringify(existingActivities));
            
            return {
                success: true,
                data: newActivity,
                message: 'æ´»åŠ¨åˆ›å»ºæˆåŠŸ'
            };
        };

        window.mockGetActivityList = async (params = {}) => {
            console.log('ğŸ”§ Mock API: è·å–æ´»åŠ¨åˆ—è¡¨', params);
            
            const activities = JSON.parse(localStorage.getItem('campus_activities') || '[]');
            
            let filteredActivities = activities;
            
            if (params.keyword) {
                const keyword = params.keyword.toLowerCase();
                filteredActivities = filteredActivities.filter(activity => 
                    activity.title.toLowerCase().includes(keyword) ||
                    activity.description.toLowerCase().includes(keyword)
                );
            }
            
            if (params.creatorId) {
                filteredActivities = filteredActivities.filter(activity => 
                    activity.creatorId === params.creatorId
                );
            }
            
            const page = params.page || 1;
            const pageSize = params.pageSize || 20;
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            
            return {
                success: true,
                data: {
                    items: filteredActivities.slice(startIndex, endIndex),
                    total: filteredActivities.length,
                    page: page,
                    pageSize: pageSize,
                    totalPages: Math.ceil(filteredActivities.length / pageSize)
                }
            };
        };

        // æ¨¡æ‹Ÿ Store é€»è¾‘
        window.loadActivitiesFromStorage = () => {
            try {
                const stored = localStorage.getItem('campus_activities');
                if (stored) {
                    return JSON.parse(stored);
                }
                
                // é»˜è®¤æ´»åŠ¨æ•°æ®
                const defaultActivities = [
                    {
                        id: "default_1",
                        title: "é»˜è®¤æ´»åŠ¨1",
                        description: "è¿™æ˜¯ä¸€ä¸ªé»˜è®¤æ´»åŠ¨",
                        startTime: new Date(Date.now() + 86400000).toISOString(),
                        endTime: new Date(Date.now() + 86400000 + 7200000).toISOString(),
                        locationName: "é»˜è®¤åœ°ç‚¹",
                        status: "recruiting",
                        currentParticipants: 5,
                        maxParticipants: 20,
                        creatorId: 1,
                        creatorName: "ç³»ç»Ÿç®¡ç†å‘˜"
                    }
                ];
                
                localStorage.setItem('campus_activities', JSON.stringify(defaultActivities));
                return defaultActivities;
            } catch (error) {
                console.error('åŠ è½½æ´»åŠ¨æ•°æ®å¤±è´¥:', error);
                return [];
            }
        };

        // å…¨å±€å‡½æ•°
        window.checkLocalStorageData = function() {
            const display = document.getElementById('localStorageDisplay');
            const data = {};
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('activity') || key.includes('campus')) {
                    try {
                        data[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        data[key] = localStorage.getItem(key);
                    }
                }
            }
            
            display.innerHTML = `<div class="info">localStorage æ•°æ®:</div>${JSON.stringify(data, null, 2)}`;
        };

        window.clearAllData = function() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('activity') || key.includes('campus') || key.includes('draft')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            const display = document.getElementById('localStorageDisplay');
            display.innerHTML = '<div class="success">å·²æ¸…ç©ºæ‰€æœ‰æ´»åŠ¨ç›¸å…³æ•°æ®</div>';
        };

        window.simulateCreateActivity = async function() {
            const display = document.getElementById('creationResult');
            
            try {
                const activityData = {
                    title: `æµ‹è¯•æ´»åŠ¨_${new Date().toLocaleTimeString()}`,
                    description: 'è¿™æ˜¯ä¸€ä¸ªé€šè¿‡è°ƒè¯•å·¥å…·åˆ›å»ºçš„æµ‹è¯•æ´»åŠ¨',
                    category: 'test',
                    startTime: new Date(Date.now() + 86400000).toISOString(),
                    endTime: new Date(Date.now() + 86400000 + 7200000).toISOString(),
                    location: {
                        name: 'æµ‹è¯•åœ°ç‚¹',
                        address: 'æµ‹è¯•åœ°å€'
                    },
                    maxParticipants: 10
                };
                
                display.innerHTML = '<div class="info">æ­£åœ¨åˆ›å»ºæ´»åŠ¨...</div>';
                
                const result = await mockCreateActivity(activityData);
                
                display.innerHTML = `
                    <div class="success">âœ… æ´»åŠ¨åˆ›å»ºæˆåŠŸ!</div>
                    <div>æ´»åŠ¨ID: ${result.data.id}</div>
                    <div>æ´»åŠ¨æ ‡é¢˜: ${result.data.title}</div>
                    <div>åˆ›å»ºæ—¶é—´: ${result.data.createTime}</div>
                    <div>è¯¦ç»†ä¿¡æ¯:</div>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `;
                
                // è‡ªåŠ¨æ£€æŸ¥æ•°æ®
                setTimeout(() => checkLocalStorageData(), 500);
                
            } catch (error) {
                display.innerHTML = `<div class="error">âŒ åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        };

        window.simulateMultipleActivities = async function() {
            const display = document.getElementById('creationResult');
            display.innerHTML = '<div class="info">æ­£åœ¨åˆ›å»ºå¤šä¸ªæµ‹è¯•æ´»åŠ¨...</div>';
            
            const activities = [
                { title: 'æŠ€æœ¯åˆ†äº«ä¼š', category: 'lecture', maxParticipants: 30 },
                { title: 'ç¯®çƒæ¯”èµ›', category: 'sports', maxParticipants: 20 },
                { title: 'æ¡Œæ¸¸èšä¼š', category: 'game', maxParticipants: 15 }
            ];
            
            for (let i = 0; i < activities.length; i++) {
                const activityData = {
                    ...activities[i],
                    description: `è¿™æ˜¯ç¬¬${i+1}ä¸ªæµ‹è¯•æ´»åŠ¨`,
                    startTime: new Date(Date.now() + (i+1) * 86400000).toISOString(),
                    endTime: new Date(Date.now() + (i+1) * 86400000 + 7200000).toISOString(),
                    location: {
                        name: `æµ‹è¯•åœ°ç‚¹${i+1}`,
                        address: `æµ‹è¯•åœ°å€${i+1}`
                    }
                };
                
                try {
                    await mockCreateActivity(activityData);
                    display.innerHTML += `<div class="success">âœ… åˆ›å»ºæ´»åŠ¨: ${activityData.title}</div>`;
                } catch (error) {
                    display.innerHTML += `<div class="error">âŒ åˆ›å»ºå¤±è´¥: ${activityData.title} - ${error.message}</div>`;
                }
            }
            
            display.innerHTML += '<div class="success">ğŸ‰ æ‰€æœ‰æ´»åŠ¨åˆ›å»ºå®Œæˆ!</div>';
            setTimeout(() => checkLocalStorageData(), 500);
        };

        window.testGetActivityList = async function() {
            const display = document.getElementById('listResult');
            
            try {
                display.innerHTML = '<div class="info">æ­£åœ¨è·å–æ´»åŠ¨åˆ—è¡¨...</div>';
                
                const result = await mockGetActivityList({ page: 1, pageSize: 20 });
                
                display.innerHTML = `
                    <div class="success">âœ… è·å–æ´»åŠ¨åˆ—è¡¨æˆåŠŸ!</div>
                    <div>æ€»æ•°: ${result.data.total}</div>
                    <div>å½“å‰é¡µ: ${result.data.page}</div>
                    <div>æ¯é¡µå¤§å°: ${result.data.pageSize}</div>
                    <div>æ´»åŠ¨åˆ—è¡¨:</div>
                    <pre>${JSON.stringify(result.data.items, null, 2)}</pre>
                `;
                
            } catch (error) {
                display.innerHTML = `<div class="error">âŒ è·å–å¤±è´¥: ${error.message}</div>`;
            }
        };

        window.testStoreLoadActivities = function() {
            const display = document.getElementById('listResult');
            
            try {
                const activities = loadActivitiesFromStorage();
                
                display.innerHTML = `
                    <div class="success">âœ… Store åŠ è½½æ´»åŠ¨æˆåŠŸ!</div>
                    <div>æ´»åŠ¨æ•°é‡: ${activities.length}</div>
                    <div>æ´»åŠ¨åˆ—è¡¨:</div>
                    <pre>${JSON.stringify(activities, null, 2)}</pre>
                `;
                
            } catch (error) {
                display.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        };

        window.checkDataSync = function() {
            const display = document.getElementById('syncResult');
            
            // æ£€æŸ¥ä¸åŒæ•°æ®æºçš„ä¸€è‡´æ€§
            const localStorageData = JSON.parse(localStorage.getItem('campus_activities') || '[]');
            const storeData = loadActivitiesFromStorage();
            
            const isConsistent = JSON.stringify(localStorageData) === JSON.stringify(storeData);
            
            display.innerHTML = `
                <div class="${isConsistent ? 'success' : 'warning'}">
                    ${isConsistent ? 'âœ… æ•°æ®åŒæ­¥æ­£å¸¸' : 'âš ï¸ æ•°æ®åŒæ­¥å¼‚å¸¸'}
                </div>
                <div>localStorage æ•°æ®é‡: ${localStorageData.length}</div>
                <div>Store æ•°æ®é‡: ${storeData.length}</div>
                <div>ä¸€è‡´æ€§æ£€æŸ¥: ${isConsistent ? 'é€šè¿‡' : 'å¤±è´¥'}</div>
            `;
        };

        window.forceDataSync = function() {
            const display = document.getElementById('syncResult');
            
            try {
                // å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®
                const activities = loadActivitiesFromStorage();
                localStorage.setItem('campus_activities', JSON.stringify(activities));
                
                display.innerHTML = '<div class="success">âœ… å¼ºåˆ¶æ•°æ®åŒæ­¥å®Œæˆ</div>';
                
                setTimeout(() => checkDataSync(), 100);
                
            } catch (error) {
                display.innerHTML = `<div class="error">âŒ åŒæ­¥å¤±è´¥: ${error.message}</div>`;
            }
        };

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æ•°æ®
        setTimeout(() => {
            checkLocalStorageData();
            checkDataSync();
        }, 100);
    </script>
</body>
</html>