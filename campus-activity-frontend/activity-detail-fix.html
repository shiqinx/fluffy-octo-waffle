<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨è¯¦æƒ…ä¿®å¤å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .activity-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .activity-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .activity-card .id {
            color: #6c757d;
            font-size: 12px;
            font-family: monospace;
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .activity-card .details {
            font-size: 13px;
            color: #6c757d;
            line-height: 1.4;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-top: 10px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .diagnostic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .diagnostic-item:last-child {
            border-bottom: none;
        }

        .diagnostic-label {
            font-weight: 500;
            color: #495057;
        }

        .diagnostic-value {
            color: #6c757d;
            font-family: monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æ´»åŠ¨è¯¦æƒ…ä¿®å¤å·¥å…·</h1>
            <p>ä¸“é—¨è§£å†³æ´»åŠ¨è¯¦æƒ…é¡µé¢æ˜¾ç¤ºé”™è¯¯æ•°æ®çš„é—®é¢˜</p>
        </div>

        <div class="content">
            <!-- é—®é¢˜è¯Šæ–­ -->
            <div class="section">
                <h3>ğŸ” é—®é¢˜è¯Šæ–­</h3>
                <div id="diagnostics">
                    <div class="diagnostic-item">
                        <span class="diagnostic-label">localStorageçŠ¶æ€:</span>
                        <span class="diagnostic-value" id="storage-status">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="diagnostic-item">
                        <span class="diagnostic-label">æ´»åŠ¨æ•°æ®æ•°é‡:</span>
                        <span class="diagnostic-value" id="activity-count">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="diagnostic-item">
                        <span class="diagnostic-label">æ•°æ®å®Œæ•´æ€§:</span>
                        <span class="diagnostic-value" id="data-integrity">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="diagnostic-item">
                        <span class="diagnostic-label">IDå”¯ä¸€æ€§:</span>
                        <span class="diagnostic-value" id="id-uniqueness">æ£€æŸ¥ä¸­...</span>
                    </div>
                </div>
            </div>

            <!-- å½“å‰æ´»åŠ¨æ•°æ® -->
            <div class="section">
                <h3>ğŸ“‹ å½“å‰æ´»åŠ¨æ•°æ®</h3>
                <div id="current-data" class="activity-grid">
                    <!-- æ´»åŠ¨å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="section">
                <h3>ğŸ› ï¸ ä¿®å¤æ“ä½œ</h3>
                <button class="btn btn-primary" onclick="diagnose()">ğŸ” é‡æ–°è¯Šæ–­</button>
                <button class="btn btn-success" onclick="fixActivityData()">âœ… ä¿®å¤æ´»åŠ¨æ•°æ®</button>
                <button class="btn btn-danger" onclick="clearCorruptedData()">ğŸ—‘ï¸ æ¸…ç©ºæŸåæ•°æ®</button>
            </div>

            <!-- æ“ä½œæ—¥å¿— -->
            <div class="section">
                <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
                <div id="log" class="log">ç­‰å¾…æ“ä½œ...</div>
            </div>
        </div>
    </div>

    <script>
        // é»˜è®¤æ´»åŠ¨æ•°æ®
        const DEFAULT_ACTIVITIES = [
            {
                id: "1",
                title: "ä¸­åŒ»å…»ç”Ÿè®²åº§",
                type: "lecture",
                category: "lecture",
                description: "ä¼ ç»Ÿä¸­åŒ»å…»ç”ŸçŸ¥è¯†åˆ†äº«ï¼Œä»‹ç»æ—¥å¸¸å…»ç”Ÿæ–¹æ³•å’Œå¥åº·ç†å¿µ",
                status: "recruiting",
                startTime: "2024-01-20T14:00:00",
                endTime: "2024-01-20T16:00:00",
                enrollStartTime: "2024-01-15T09:00:00",
                enrollEndTime: "2024-01-19T18:00:00",
                location: {
                    name: "æ•™å­¦æ¥¼A101",
                    address: "ç¬¬ä¸€æ•™å­¦æ¥¼101æ•™å®¤",
                    coords: [116.397428, 39.90923]
                },
                organizer: {
                    id: "user1",
                    name: "å¼ æ•™æˆ",
                    avatar: "https://picsum.photos/seed/prof1/200/200.jpg",
                    role: "ä¸­åŒ»å­¦æ•™æˆ",
                    creditScore: 95
                },
                currentParticipants: 25,
                maxParticipants: 100,
                enrollments: [],
                participants: []
            },
            {
                id: "2", 
                title: "æ‘„å½±ä½œå“å±•è§ˆ",
                type: "exhibition",
                category: "other",
                description: "æ ¡å›­æ‘„å½±çˆ±å¥½è€…ä½œå“å±•ç¤ºï¼Œè®°å½•ç¾å¥½æ ¡å›­ç”Ÿæ´»",
                status: "recruiting",
                startTime: "2024-01-22T10:00:00",
                endTime: "2024-01-22T17:00:00",
                enrollStartTime: "2024-01-16T09:00:00",
                enrollEndTime: "2024-01-21T18:00:00",
                location: {
                    name: "è‰ºæœ¯æ¥¼å±•å…",
                    address: "è‰ºæœ¯æ¥¼äºŒæ¥¼å±•å…",
                    coords: [116.397428, 39.90923]
                },
                organizer: {
                    id: "user2",
                    name: "æåŒå­¦",
                    avatar: "https://picsum.photos/seed/stu1/200/200.jpg",
                    role: "æ‘„å½±ç¤¾ç¤¾é•¿",
                    creditScore: 88
                },
                currentParticipants: 45,
                maxParticipants: 200,
                enrollments: [],
                participants: []
            },
            {
                id: "3",
                title: "ç¼–ç¨‹é©¬æ‹‰æ¾å¤§èµ›",
                type: "competition",
                category: "study",
                description: "48å°æ—¶ç¼–ç¨‹æŒ‘æˆ˜ï¼Œå›¢é˜Ÿåä½œå¼€å‘åˆ›æ–°é¡¹ç›®",
                status: "recruiting",
                startTime: "2024-01-25T09:00:00",
                endTime: "2024-01-27T18:00:00",
                enrollStartTime: "2024-01-18T09:00:00",
                enrollEndTime: "2024-01-24T18:00:00",
                location: {
                    name: "è®¡ç®—æœºå®éªŒå®¤",
                    address: "è®¡ç®—æœºæ¥¼302å®éªŒå®¤",
                    coords: [116.397428, 39.90923]
                },
                organizer: {
                    id: "user3",
                    name: "ç‹è€å¸ˆ",
                    avatar: "https://picsum.photos/seed/teacher1/200/200.jpg",
                    role: "è®¡ç®—æœºç³»æ•™å¸ˆ",
                    creditScore: 92
                },
                currentParticipants: 15,
                maxParticipants: 50,
                enrollments: [],
                participants: []
            },
            {
                id: "4",
                title: "ç¯®çƒå‹è°Šèµ›",
                type: "sports",
                category: "sports",
                description: "é™¢ç³»ç¯®çƒå‹è°Šèµ›ï¼Œå¢è¿›äº¤æµï¼Œå¼ºèº«å¥ä½“",
                status: "recruiting",
                startTime: "2024-01-23T15:00:00",
                endTime: "2024-01-23T17:00:00",
                enrollStartTime: "2024-01-17T09:00:00",
                enrollEndTime: "2024-01-22T18:00:00",
                location: {
                    name: "ä½“è‚²é¦†",
                    address: "æ ¡å†…ä½“è‚²é¦†ç¯®çƒåœº",
                    coords: [116.397428, 39.90923]
                },
                organizer: {
                    id: "user4",
                    name: "èµµåŒå­¦",
                    avatar: "https://picsum.photos/seed/stu2/200/200.jpg",
                    role: "ä½“è‚²éƒ¨éƒ¨é•¿",
                    creditScore: 85
                },
                currentParticipants: 32,
                maxParticipants: 40,
                enrollments: [],
                participants: []
            },
            {
                id: "5",
                title: "æ ¡å›­éŸ³ä¹èŠ‚",
                type: "performance",
                category: "other",
                description: "æ ¡å›­éŸ³ä¹çˆ±å¥½è€…ç››ä¼šï¼Œå±•ç¤ºéŸ³ä¹æ‰åï¼Œäº«å—éŸ³ä¹é­…åŠ›",
                status: "recruiting",
                startTime: "2024-01-26T18:00:00",
                endTime: "2024-01-26T21:00:00",
                enrollStartTime: "2024-01-19T09:00:00",
                enrollEndTime: "2024-01-25T18:00:00",
                location: {
                    name: "å¤§å­¦ç”Ÿæ´»åŠ¨ä¸­å¿ƒ",
                    address: "å¤§å­¦ç”Ÿæ´»åŠ¨ä¸­å¿ƒç¤¼å ‚",
                    coords: [116.397428, 39.90923]
                },
                organizer: {
                    id: "user5",
                    name: "é™ˆåŒå­¦",
                    avatar: "https://picsum.photos/seed/stu3/200/200.jpg",
                    role: "éŸ³ä¹ç¤¾ç¤¾é•¿",
                    creditScore: 90
                },
                currentParticipants: 180,
                maxParticipants: 300,
                enrollments: [],
                participants: []
            }
        ];

        let logContent = '';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(message);
        }

        function diagnose() {
            log('ğŸ” å¼€å§‹è¯Šæ–­æ´»åŠ¨æ•°æ®...');
            
            // æ£€æŸ¥localStorageçŠ¶æ€
            try {
                const stored = localStorage.getItem('campus_activities');
                if (stored) {
                    const activities = JSON.parse(stored);
                    document.getElementById('storage-status').textContent = 'âœ… æ•°æ®å­˜åœ¨';
                    document.getElementById('activity-count').textContent = `${activities.length} ä¸ªæ´»åŠ¨`;
                    
                    // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                    const validActivities = activities.filter(act => 
                        act.id && act.title && act.type && act.category
                    );
                    document.getElementById('data-integrity').textContent = 
                        `${validActivities.length}/${activities.length} å®Œæ•´`;
                    
                    // æ£€æŸ¥IDå”¯ä¸€æ€§
                    const ids = activities.map(act => act.id);
                    const uniqueIds = [...new Set(ids)];
                    document.getElementById('id-uniqueness').textContent = 
                        uniqueIds.length === ids.length ? 'âœ… å”¯ä¸€' : 'âŒ é‡å¤';
                    
                    displayCurrentData(activities);
                } else {
                    document.getElementById('storage-status').textContent = 'âŒ æ— æ•°æ®';
                    document.getElementById('activity-count').textContent = '0 ä¸ªæ´»åŠ¨';
                    document.getElementById('data-integrity').textContent = 'æ— æ•°æ®';
                    document.getElementById('id-uniqueness').textContent = 'æ— æ•°æ®';
                }
            } catch (error) {
                log('âŒ è¯Šæ–­å¤±è´¥: ' + error.message);
                document.getElementById('storage-status').textContent = 'âŒ æŸå';
            }
        }

        function displayCurrentData(activities) {
            const container = document.getElementById('current-data');
            container.innerHTML = '';
            
            activities.forEach(activity => {
                const card = document.createElement('div');
                card.className = 'activity-card';
                card.innerHTML = `
                    <h4>${activity.title}</h4>
                    <div class="id">ID: ${activity.id}</div>
                    <div class="details">
                        ç±»å‹: ${activity.type || 'æœªè®¾ç½®'}<br>
                        åˆ†ç±»: ${activity.category || 'æœªè®¾ç½®'}<br>
                        çŠ¶æ€: ${activity.status || 'æœªè®¾ç½®'}<br>
                        å‚ä¸è€…: ${activity.currentParticipants || 0}/${activity.maxParticipants || 0}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function fixActivityData() {
            log('ğŸ”§ å¼€å§‹ä¿®å¤æ´»åŠ¨æ•°æ®...');
            
            try {
                // ä¿å­˜å½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½
                const currentData = localStorage.getItem('campus_activities');
                if (currentData) {
                    localStorage.setItem('campus_activities_backup', currentData);
                    log('ğŸ“¦ å·²å¤‡ä»½å½“å‰æ•°æ®');
                }
                
                // ä½¿ç”¨é»˜è®¤æ•°æ®è¦†ç›–
                localStorage.setItem('campus_activities', JSON.stringify(DEFAULT_ACTIVITIES));
                log('âœ… å·²ä½¿ç”¨æ­£ç¡®çš„é»˜è®¤æ•°æ®è¦†ç›–localStorage');
                
                // æ¸…ç†å¯èƒ½çš„ç¼“å­˜
                if (typeof globalDataManager !== 'undefined') {
                    globalDataManager.resetActivities();
                    log('ğŸ§¹ å·²æ¸…ç†å…¨å±€æ•°æ®ç®¡ç†å™¨ç¼“å­˜');
                }
                
                log('ğŸ‰ ä¿®å¤å®Œæˆï¼æ´»åŠ¨æ•°æ®å·²æ¢å¤æ­£å¸¸');
                
                // é‡æ–°è¯Šæ–­
                setTimeout(diagnose, 500);
                
            } catch (error) {
                log('âŒ ä¿®å¤å¤±è´¥: ' + error.message);
            }
        }

        function clearCorruptedData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ´»åŠ¨æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®ã€‚')) {
                log('ğŸ—‘ï¸ æ¸…ç©ºæŸåæ•°æ®...');
                
                try {
                    localStorage.removeItem('campus_activities');
                    localStorage.removeItem('campus_activities_backup');
                    log('âœ… å·²æ¸…ç©ºlocalStorageä¸­çš„æ´»åŠ¨æ•°æ®');
                    
                    // é‡æ–°è¯Šæ–­
                    setTimeout(diagnose, 500);
                    
                } catch (error) {
                    log('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message);
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯Šæ–­
        window.onload = function() {
            log('ğŸš€ æ´»åŠ¨è¯¦æƒ…ä¿®å¤å·¥å…·å·²å¯åŠ¨');
            diagnose();
        };
    </script>
</body>
</html>