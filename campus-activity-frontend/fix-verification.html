<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨åˆ›å»ºä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .error { background: #fff2f2; color: #ff4d4f; border: 1px solid #ffccc7; }
        .info { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; }
        .test-btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-btn:hover { background: #40a9ff; }
        .test-btn:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        .timestamp {
            color: #666;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ´»åŠ¨åˆ›å»ºä¿®å¤éªŒè¯</h1>
        
        <div class="status info" id="status">
            å‡†å¤‡å¼€å§‹éªŒè¯æ´»åŠ¨åˆ›å»ºå’Œæ˜¾ç¤ºåŠŸèƒ½çš„ä¿®å¤æ•ˆæœ...
        </div>
        
        <div>
            <button class="test-btn" onclick="runTest()">ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button class="test-btn" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="log" id="log">
            <div class="log-entry"><span class="timestamp">[å‡†å¤‡]</span> ç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"å¼€å§‹éªŒè¯...</div>
        </div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿå¯¼å…¥å’Œæµ‹è¯•é€»è¾‘
        let activityStore = null;
        let testResults = [];

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[éªŒè¯æ—¥å¿—] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // æ¨¡æ‹Ÿæ´»åŠ¨æ•°æ®å­˜å‚¨
        class MockActivityStore {
            constructor() {
                this.activities = this.loadFromStorage();
            }

            loadFromStorage() {
                const stored = localStorage.getItem('activities');
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return this.getDefaultActivities();
                    }
                }
                return this.getDefaultActivities();
            }

            getDefaultActivities() {
                return [
                    {
                        id: '1',
                        title: 'é»˜è®¤æ´»åŠ¨1',
                        type: 'study',
                        locationName: 'å›¾ä¹¦é¦†',
                        startTime: new Date().toISOString(),
                        currentParticipants: 5,
                        maxParticipants: 20
                    },
                    {
                        id: '2', 
                        title: 'é»˜è®¤æ´»åŠ¨2',
                        type: 'sports',
                        locationName: 'ä½“è‚²é¦†',
                        startTime: new Date().toISOString(),
                        currentParticipants: 8,
                        maxParticipants: 15
                    }
                ];
            }

            saveToStorage() {
                localStorage.setItem('activities', JSON.stringify(this.activities));
            }

            async loadActivities() {
                this.activities = this.loadFromStorage();
                return this.activities;
            }

            createActivity(activityData) {
                const newActivity = {
                    id: Date.now().toString(),
                    ...activityData,
                    type: activityData.category || activityData.type,
                    locationName: activityData.location?.name || activityData.locationName,
                    currentParticipants: 0,
                    createdAt: new Date().toISOString()
                };
                
                this.activities.push(newActivity);
                this.saveToStorage();
                
                return {
                    success: true,
                    data: newActivity
                };
            }
        }

        // æ¨¡æ‹Ÿåˆ›å»ºæ´»åŠ¨API
        async function mockCreateActivity(activityData) {
            addLog(`ğŸ“ è°ƒç”¨åˆ›å»ºAPI: ${activityData.title}`);
            
            // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const store = new MockActivityStore();
            const result = store.createActivity(activityData);
            
            addLog(`âœ… APIè°ƒç”¨æˆåŠŸï¼Œæ´»åŠ¨ID: ${result.data.id}`);
            return result;
        }

        // å®Œæ•´æµ‹è¯•æµç¨‹
        window.runTest = async function() {
            try {
                addLog('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...');
                updateStatus('æ­£åœ¨æµ‹è¯•æ´»åŠ¨åˆ›å»ºå’Œæ˜¾ç¤ºåŠŸèƒ½...', 'info');

                // åˆå§‹åŒ–store
                activityStore = new MockActivityStore();
                await activityStore.loadActivities();
                const initialCount = activityStore.activities.length;
                addLog(`ğŸ“Š åˆå§‹æ´»åŠ¨æ•°é‡: ${initialCount}`);

                // åˆ›å»ºæµ‹è¯•æ´»åŠ¨
                const testActivity = {
                    title: `ä¿®å¤éªŒè¯æ´»åŠ¨_${Date.now()}`,
                    category: 'other',
                    description: 'ç”¨äºéªŒè¯ä¿®å¤æ•ˆæœçš„æµ‹è¯•æ´»åŠ¨',
                    startTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    endTime: new Date(Date.now() + 26 * 60 * 60 * 1000).toISOString(),
                    location: {
                        name: 'æµ‹è¯•åœ°ç‚¹',
                        address: 'æµ‹è¯•åœ°å€'
                    },
                    maxParticipants: 20,
                    requiresApproval: false
                };

                addLog(`ğŸ¯ å‡†å¤‡åˆ›å»ºæµ‹è¯•æ´»åŠ¨: ${testActivity.title}`);

                // è°ƒç”¨åˆ›å»ºAPIï¼ˆæ¨¡æ‹Ÿä¿®å¤åçš„é€»è¾‘ï¼‰
                const response = await mockCreateActivity(testActivity);

                if (response.success) {
                    addLog(`âœ… æ´»åŠ¨åˆ›å»ºæˆåŠŸ! ID: ${response.data.id}`);

                    // ç«‹å³åˆ·æ–°æ•°æ®ï¼ˆä¿®å¤åçš„å…³é”®æ­¥éª¤ï¼‰
                    await activityStore.loadActivities();
                    const afterCount = activityStore.activities.length;
                    addLog(`ğŸ”„ æ•°æ®åˆ·æ–°å®Œæˆï¼Œå½“å‰æ´»åŠ¨æ•°é‡: ${afterCount}`);

                    // æŸ¥æ‰¾æ–°åˆ›å»ºçš„æ´»åŠ¨
                    const newActivity = activityStore.activities.find(a => a.id === response.data.id);

                    if (newActivity) {
                        addLog('ğŸ‰ æµ‹è¯•æˆåŠŸ! æ–°åˆ›å»ºçš„æ´»åŠ¨å·²æ­£ç¡®æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­');
                        addLog(`ğŸ“‹ æ´»åŠ¨è¯¦æƒ…: ${newActivity.title} | ID: ${newActivity.id} | åœ°ç‚¹: ${newActivity.locationName}`);
                        updateStatus('âœ… ä¿®å¤éªŒè¯æˆåŠŸ! æ´»åŠ¨åˆ›å»ºåç«‹å³æ˜¾ç¤º', 'success');
                        
                        testResults.push({
                            test: 'æ´»åŠ¨åˆ›å»ºå’Œæ˜¾ç¤º',
                            result: 'PASS',
                            details: `æ´»åŠ¨ID: ${newActivity.id}, åˆ—è¡¨æ•°é‡: ${initialCount} â†’ ${afterCount}`
                        });
                    } else {
                        addLog('âŒ æµ‹è¯•å¤±è´¥: æ–°åˆ›å»ºçš„æ´»åŠ¨æœªåœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°');
                        updateStatus('âŒ ä¿®å¤éªŒè¯å¤±è´¥: æ´»åŠ¨æœªæ˜¾ç¤º', 'error');
                        
                        testResults.push({
                            test: 'æ´»åŠ¨åˆ›å»ºå’Œæ˜¾ç¤º',
                            result: 'FAIL',
                            details: 'æ´»åŠ¨åˆ›å»ºæˆåŠŸä½†æœªåœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º'
                        });
                    }
                } else {
                    throw new Error(response.message || 'åˆ›å»ºæ´»åŠ¨å¤±è´¥');
                }

                // æ˜¾ç¤ºæµ‹è¯•æ€»ç»“
                addLog('ğŸ“Š æµ‹è¯•æ€»ç»“:');
                testResults.forEach(result => {
                    addLog(`  ${result.result === 'PASS' ? 'âœ…' : 'âŒ'} ${result.test}: ${result.details}`);
                });

                const allPassed = testResults.every(r => r.result === 'PASS');
                if (allPassed) {
                    addLog('ğŸŠ æ‰€æœ‰æµ‹è¯•é€šè¿‡! ä¿®å¤æ•ˆæœéªŒè¯æˆåŠŸ');
                    updateStatus('ğŸŠ ä¿®å¤éªŒè¯å®Œæˆ! æ‰€æœ‰åŠŸèƒ½æ­£å¸¸', 'success');
                }

            } catch (error) {
                addLog(`ğŸ’¥ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                updateStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        window.clearLog = function() {
            document.getElementById('log').innerHTML = '<div class="log-entry"><span class="timestamp">[æ¸…ç©º]</span> æ—¥å¿—å·²æ¸…ç©º</div>';
        };

        // é¡µé¢åŠ è½½å®Œæˆ
        addLog('ğŸ“± éªŒè¯é¡µé¢åŠ è½½å®Œæˆ');
        addLog('ğŸ’¡ è¿™ä¸ªæµ‹è¯•æ¨¡æ‹Ÿäº†ä¿®å¤åçš„æ´»åŠ¨åˆ›å»ºæµç¨‹');
        addLog('ğŸ”§ ä¿®å¤å†…å®¹: åˆ›å»ºæˆåŠŸåç«‹å³åˆ·æ–°æ•°æ®ï¼Œå†è¿›è¡Œé¡µé¢è·³è½¬');
    </script>
</body>
</html>